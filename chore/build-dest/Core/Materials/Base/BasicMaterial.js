import Material from "../Material";
import ContextComponents from "../../../ContextComponents";
import JThreeContext from "../../../JThreeContext";
import MaterialPass from "./MaterialPass";
import Q from "q";
class BasicMaterial extends Material {
    constructor(sourceString, name) {
        super();
        this._passes = [];
        this._uniformRegisters = [];
        this._passCount = 0;
        this._parseMaterialDocument(sourceString, name);
    }
    /**
  * Apply configuration of program.
  * This is used for passing variables,using programs,binding index buffer.
  */
    apply(matArg) {
        if (!this.Initialized) {
            return;
        }
        super.apply(matArg);
        const targetPass = this._passes[matArg.passIndex];
        targetPass.apply(matArg, this._uniformRegisters, this);
    }
    /**
    * Should return how many times required to render this material.
    * If you render some of model with edge,it can be 2 or greater.
    * Because it needs rendering edge first,then rendering forward shading.
    */
    getPassCount(techniqueIndex) {
        return this._passCount;
    }
    get MaterialGroup() {
        return this._materialGroup;
    }
    _parseMaterialDocument(source, name) {
        const xmml = (new DOMParser()).parseFromString(source, "text/xml");
        this._materialName = xmml.querySelector("material").getAttribute("name");
        this._materialGroup = xmml.querySelector("material").getAttribute("group");
        if (!this._materialName && !name) {
            console.error("Material name must be specified");
        }
        this._materialName = this._materialName || name;
        this._initializeUniformRegisters(xmml);
        this._parsePasses(xmml).then(() => {
            this.__setLoaded();
        });
    }
    _parsePasses(doc) {
        const passes = doc.querySelectorAll("material > passes > pass");
        for (let i = 0; i < passes.length; i++) {
            const pass = passes.item(i);
            this._passes.push(new MaterialPass(this, pass, this._materialName, i));
        }
        this._passCount = passes.length;
        return Q.all(this._passes.map(e => e.initialize(this._uniformRegisters)));
    }
    _initializeUniformRegisters(doc) {
        const registersDOM = doc.querySelectorAll("material > uniform-register > register");
        for (let i = 0; i < registersDOM.length; i++) {
            const registerDOM = registersDOM.item(i);
            const registererConstructor = this._materialManager.getUniformRegister(registerDOM.attributes.getNamedItem("name").value);
            if (!registererConstructor) {
                continue;
            }
            this._uniformRegisters.push(new registererConstructor());
        }
    }
    get _materialManager() {
        return JThreeContext.getContextComponent(ContextComponents.MaterialManager);
    }
}
export default BasicMaterial;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkNvcmUvTWF0ZXJpYWxzL0Jhc2UvQmFzaWNNYXRlcmlhbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiT0FDTyxRQUFRLE1BQU0sYUFBYTtPQUMzQixpQkFBaUIsTUFBTSw0QkFBNEI7T0FDbkQsYUFBYSxNQUFNLHdCQUF3QjtPQUUzQyxZQUFZLE1BQU0sZ0JBQWdCO09BRWxDLENBQUMsTUFBTSxHQUFHO0FBQ2pCLDRCQUE0QixRQUFRO0lBV2xDLFlBQVksWUFBb0IsRUFBRSxJQUFhO1FBQzdDLE9BQU8sQ0FBQztRQVhGLFlBQU8sR0FBbUIsRUFBRSxDQUFDO1FBRTdCLHNCQUFpQixHQUFzQixFQUFFLENBQUM7UUFNMUMsZUFBVSxHQUFXLENBQUMsQ0FBQztRQUk3QixJQUFJLENBQUMsc0JBQXNCLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2xELENBQUM7SUFFRDs7O0lBR0E7SUFDTyxLQUFLLENBQUMsTUFBOEI7UUFDekMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztZQUN0QixNQUFNLENBQUM7UUFDVCxDQUFDO1FBQ0QsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNwQixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNsRCxVQUFVLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDekQsQ0FBQztJQUVEOzs7O01BSUU7SUFDSyxZQUFZLENBQUMsY0FBc0I7UUFDeEMsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7SUFDekIsQ0FBQztJQUVELElBQVcsYUFBYTtRQUN0QixNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQztJQUM3QixDQUFDO0lBRU8sc0JBQXNCLENBQUMsTUFBYyxFQUFFLElBQWE7UUFDMUQsTUFBTSxJQUFJ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LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEJhc2ljUmVnaXN0ZXJlciBmcm9tIFwiLi9SZWdpc3RlcmVyL0Jhc2ljUmVnaXN0ZXJlclwiO1xuaW1wb3J0IE1hdGVyaWFsIGZyb20gXCIuLi9NYXRlcmlhbFwiO1xuaW1wb3J0IENvbnRleHRDb21wb25lbnRzIGZyb20gXCIuLi8uLi8uLi9Db250ZXh0Q29tcG9uZW50c1wiO1xuaW1wb3J0IEpUaHJlZUNvbnRleHQgZnJvbSBcIi4uLy4uLy4uL0pUaHJlZUNvbnRleHRcIjtcbmltcG9ydCBNYXRlcmlhbE1hbmFnZXIgZnJvbSBcIi4vTWF0ZXJpYWxNYW5hZ2VyXCI7XG5pbXBvcnQgTWF0ZXJpYWxQYXNzIGZyb20gXCIuL01hdGVyaWFsUGFzc1wiO1xuaW1wb3J0IElBcHBseU1hdGVyaWFsQXJndW1lbnQgZnJvbSBcIi4vSUFwcGx5TWF0ZXJpYWxBcmd1bWVudFwiO1xuaW1wb3J0IFEgZnJvbSBcInFcIjtcbmNsYXNzIEJhc2ljTWF0ZXJpYWwgZXh0ZW5kcyBNYXRlcmlhbCB7XG4gIHByaXZhdGUgX3Bhc3NlczogTWF0ZXJpYWxQYXNzW10gPSBbXTtcblxuICBwcml2YXRlIF91bmlmb3JtUmVnaXN0ZXJzOiBCYXNpY1JlZ2lzdGVyZXJbXSA9IFtdO1xuXG4gIHByaXZhdGUgX21hdGVyaWFsR3JvdXA6IHN0cmluZztcblxuICBwcml2YXRlIF9tYXRlcmlhbE5hbWU6IHN0cmluZztcblxuICBwcml2YXRlIF9wYXNzQ291bnQ6IG51bWJlciA9IDA7XG5cbiAgY29uc3RydWN0b3Ioc291cmNlU3RyaW5nOiBzdHJpbmcsIG5hbWU/OiBzdHJpbmcpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX3BhcnNlTWF0ZXJpYWxEb2N1bWVudChzb3VyY2VTdHJpbmcsIG5hbWUpO1xuICB9XG5cbiAgLyoqXG4qIEFwcGx5IGNvbmZpZ3VyYXRpb24gb2YgcHJvZ3JhbS5cbiogVGhpcyBpcyB1c2VkIGZvciBwYXNzaW5nIHZhcmlhYmxlcyx1c2luZyBwcm9ncmFtcyxiaW5kaW5nIGluZGV4IGJ1ZmZlci5cbiovXG4gIHB1YmxpYyBhcHBseShtYXRBcmc6IElBcHBseU1hdGVyaWFsQXJndW1lbnQpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuSW5pdGlhbGl6ZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgc3VwZXIuYXBwbHkobWF0QXJnKTtcbiAgICBjb25zdCB0YXJnZXRQYXNzID0gdGhpcy5fcGFzc2VzW21hdEFyZy5wYXNzSW5kZXhdO1xuICAgIHRhcmdldFBhc3MuYXBwbHkobWF0QXJnLCB0aGlzLl91bmlmb3JtUmVnaXN0ZXJzLCB0aGlzKTtcbiAgfVxuXG4gIC8qKlxuICAqIFNob3VsZCByZXR1cm4gaG93IG1hbnkgdGltZXMgcmVxdWlyZWQgdG8gcmVuZGVyIHRoaXMgbWF0ZXJpYWwuXG4gICogSWYgeW91IHJlbmRlciBzb21lIG9mIG1vZGVsIHdpdGggZWRnZSxpdCBjYW4gYmUgMiBvciBncmVhdGVyLlxuICAqIEJlY2F1c2UgaXQgbmVlZHMgcmVuZGVyaW5nIGVkZ2UgZmlyc3QsdGhlbiByZW5kZXJpbmcgZm9yd2FyZCBzaGFkaW5nLlxuICAqL1xuICBwdWJsaWMgZ2V0UGFzc0NvdW50KHRlY2huaXF1ZUluZGV4OiBudW1iZXIpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLl9wYXNzQ291bnQ7XG4gIH1cblxuICBwdWJsaWMgZ2V0IE1hdGVyaWFsR3JvdXAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX21hdGVyaWFsR3JvdXA7XG4gIH1cblxuICBwcml2YXRlIF9wYXJzZU1hdGVyaWFsRG9jdW1lbnQoc291cmNlOiBzdHJpbmcsIG5hbWU/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCB4bW1sID0gKG5ldyBET01QYXJzZXIoKSkucGFyc2VGcm9tU3RyaW5nKHNvdXJjZSwgXCJ0ZXh0L3htbFwiKTtcbiAgICB0aGlzLl9tYXRlcmlhbE5hbWUgPSB4bW1sLnF1ZXJ5U2VsZWN0b3IoXCJtYXRlcmlhbFwiKS5nZXRBdHRyaWJ1dGUoXCJuYW1lXCIpO1xuICAgIHRoaXMuX21hdGVyaWFsR3JvdXAgPSB4bW1sLnF1ZXJ5U2VsZWN0b3IoXCJtYXRlcmlhbFwiKS5nZXRBdHRyaWJ1dGUoXCJncm91cFwiKTtcbiAgICBpZiAoIXRoaXMuX21hdGVyaWFsTmFtZSAmJiAhbmFtZSkge1xuICAgICAgY29uc29sZS5lcnJvcihcIk1hdGVyaWFsIG5hbWUgbXVzdCBiZSBzcGVjaWZpZWRcIik7XG4gICAgfVxuICAgIHRoaXMuX21hdGVyaWFsTmFtZSA9IHRoaXMuX21hdGVyaWFsTmFtZSB8fCBuYW1lO1xuICAgIHRoaXMuX2luaXRpYWxpemVVbmlmb3JtUmVnaXN0ZXJzKHhtbWwpO1xuICAgIHRoaXMuX3BhcnNlUGFzc2VzKHhtbWwpLnRoZW4oKCkgPT4ge1xuICAgICAgdGhpcy5fX3NldExvYWRlZCgpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBfcGFyc2VQYXNzZXMoZG9jOiBEb2N1bWVudCk6IFEuSVByb21pc2U8dm9pZFtdPiB7XG4gICAgY29uc3QgcGFzc2VzID0gZG9jLnF1ZXJ5U2VsZWN0b3JBbGwoXCJtYXRlcmlhbCA+IHBhc3NlcyA+IHBhc3NcIik7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXNzZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IHBhc3MgPSBwYXNzZXMuaXRlbShpKTtcbiAgICAgIHRoaXMuX3Bhc3Nlcy5wdXNoKG5ldyBNYXRlcmlhbFBhc3ModGhpcywgcGFzcywgdGhpcy5fbWF0ZXJpYWxOYW1lLCBpKSk7XG4gICAgfVxuICAgIHRoaXMuX3Bhc3NDb3VudCA9IHBhc3Nlcy5sZW5ndGg7XG4gICAgcmV0dXJuIFEuYWxsKHRoaXMuX3Bhc3Nlcy5tYXA8US5JUHJvbWlzZTx2b2lkPj4oZSA9PiBlLmluaXRpYWxpemUodGhpcy5fdW5pZm9ybVJlZ2lzdGVycykpKTtcbiAgfVxuXG4gIHByaXZhdGUgX2luaXRpYWxpemVVbmlmb3JtUmVnaXN0ZXJzKGRvYzogRG9jdW1lbnQpOiB2b2lkIHtcbiAgICBjb25zdCByZWdpc3RlcnNET00gPSBkb2MucXVlcnlTZWxlY3RvckFsbChcIm1hdGVyaWFsID4gdW5pZm9ybS1yZWdpc3RlciA+IHJlZ2lzdGVyXCIpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmVnaXN0ZXJzRE9NLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCByZWdpc3RlckRPTSA9IHJlZ2lzdGVyc0RPTS5pdGVtKGkpO1xuICAgICAgY29uc3QgcmVnaXN0ZXJlckNvbnN0cnVjdG9yID0gdGhpcy5fbWF0ZXJpYWxNYW5hZ2VyLmdldFVuaWZvcm1SZWdpc3RlcihyZWdpc3RlckRPTS5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbShcIm5hbWVcIikudmFsdWUpO1xuICAgICAgaWYgKCFyZWdpc3RlcmVyQ29uc3RydWN0b3IpIHsgY29udGludWU7IH1cbiAgICAgIHRoaXMuX3VuaWZvcm1SZWdpc3RlcnMucHVzaChuZXcgcmVnaXN0ZXJlckNvbnN0cnVjdG9yKCkpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0IF9tYXRlcmlhbE1hbmFnZXIoKTogTWF0ZXJpYWxNYW5hZ2VyIHtcbiAgICByZXR1cm4gSlRocmVlQ29udGV4dC5nZXRDb250ZXh0Q29tcG9uZW50PE1hdGVyaWFsTWFuYWdlcj4oQ29udGV4dENvbXBvbmVudHMuTWF0ZXJpYWxNYW5hZ2VyKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBCYXNpY01hdGVyaWFsO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9

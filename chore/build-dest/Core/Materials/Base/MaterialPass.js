import DefaultValuePreProcessor from "./DefaultValuePreProcessor";
import JThreeObjectWithID from "../../../Base/JThreeObjectWithID";
import XMLRenderConfigUtility from "./XMLRenderConfigUtility";
import ContextComponents from "../../../ContextComponents";
import JThreeContext from "../../../JThreeContext";
import ShaderParser from "./ShaderParser";
import Q from "q";
class MaterialPass extends JThreeObjectWithID {
    constructor(material, passDocument, materialName, index) {
        super();
        this.ready = false;
        this._renderConfigureCache = {};
        this.passIndex = index;
        this._material = material;
        this._passDocument = passDocument;
        this.materialName = materialName;
    }
    initialize(uniformRegisters) {
        const shaderCode = this._passDocument.getElementsByTagName("glsl").item(0).textContent;
        return ShaderParser.parseCombined(shaderCode).then((result) => {
            this.programDescription = result;
            this._constructProgram(this.materialName + this.passIndex);
            return DefaultValuePreProcessor.preprocess(this.programDescription.uniforms);
        }).then(() => {
            return Q.all(uniformRegisters.map(m => m.preprocess(this, this.programDescription.uniforms)));
        }).then(() => {
            this.ready = true;
        });
    }
    apply(matArg, uniformRegisters, material) {
        if (!this.ready) {
            throw new Error("initialization was not completed yet!");
        }
        const gl = matArg.renderStage.GL;
        const pWrapper = this.program.getForContext(matArg.renderStage.Renderer.Canvas);
        const renderConfig = this._fetchRenderConfigure(matArg);
        XMLRenderConfigUtility.applyAll(gl, renderConfig);
        // Declare using program before assigning material variables
        pWrapper.useProgram();
        // Apply attribute variables by geometries
        matArg.object.Geometry.applyAttributeVariables(pWrapper, this.programDescription.attributes);
        // Apply uniform variables
        uniformRegisters.forEach((r) => {
            r.register(gl, pWrapper, matArg, this.programDescription.uniforms);
        });
        material.registerMaterialVariables(matArg.renderStage.Renderer, pWrapper, this.programDescription.uniforms);
    }
    __preprocessUniformVariables() {
        // Preprocess default value for uniforms
    }
    _fetchRenderConfigure(matArg) {
        const id = matArg.renderStage.ID;
        let result;
        if (this._renderConfigureCache[id]) {
            result = this._renderConfigureCache[id];
        }
        else {
            const configure = XMLRenderConfigUtility.parseRenderConfig(this._passDocument, matArg.renderStage.getDefaultRendererConfigure(matArg.techniqueIndex));
            this._renderConfigureCache[id] = configure;
            result = configure;
        }
        this._material.emit("configure", {
            pass: this,
            passIndex: this.passIndex,
            material: this._material,
            configure: result
        });
        return result;
    }
    _constructProgram(idPrefix) {
        this._passId = idPrefix;
        this.fragmentShader = MaterialPass._resourceManager.createShader(idPrefix + "-fs", this.programDescription.fragment, WebGLRenderingContext.FRAGMENT_SHADER);
        this.vertexShader = MaterialPass._resourceManager.createShader(idPrefix + "-vs", this.programDescription.vertex, WebGLRenderingContext.VERTEX_SHADER);
        this.fragmentShader.loadAll();
        this.vertexShader.loadAll();
        this.program = MaterialPass._resourceManager.createProgram(idPrefix + "-program", [this.vertexShader, this.fragmentShader]);
    }
    static get _resourceManager() {
        return JThreeContext.getContextComponent(ContextComponents.ResourceManager);
    }
}
export default MaterialPass;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkNvcmUvTWF0ZXJpYWxzL0Jhc2UvTWF0ZXJpYWxQYXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJPQUNPLHdCQUF3QixNQUFNLDRCQUE0QjtPQUUxRCxrQkFBa0IsTUFBTSxrQ0FBa0M7T0FLMUQsc0JBQXNCLE1BQU0sMEJBQTBCO09BR3RELGlCQUFpQixNQUFNLDRCQUE0QjtPQUNuRCxhQUFhLE1BQU0sd0JBQXdCO09BRTNDLFlBQVksTUFBTSxnQkFBZ0I7T0FDbEMsQ0FBQyxNQUFNLEdBQUc7QUFDakIsMkJBQTJCLGtCQUFrQjtJQXdCM0MsWUFBWSxRQUFrQixFQUFFLFlBQXFCLEVBQUUsWUFBb0IsRUFBRSxLQUFhO1FBQ3hGLE9BQU8sQ0FBQztRQXZCSCxVQUFLLEdBQVksS0FBSyxDQUFDO1FBZ0J0QiwwQkFBcUIsR0FBa0QsRUFBRSxDQUFDO1FBUWhGLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDO1FBQzFCLElBQUksQ0FBQyxhQUFhLEdBQUcsWUFBWSxDQUFDO1FBQ2xDLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO0lBQ25DLENBQUM7SUFFTSxVQUFVLENBQUMsZ0JBQW1DO1FBQ25ELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQztRQUN2RixNQUFNLENBQUMsWUFBWSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNO1lBQ3hELElBQUksQ0FBQyxrQkFBa0IsR0FBRyxNQUFNLENBQUM7WUFDakMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQzNELE1BQU0sQ0FBQyx3QkFBd0IsQ0FBQyxVQUFVLENBQUMsSUFBSSxD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LENBQUMsQ0FBQztRQUNILE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUdPLGlCQUFpQixDQUFDLFFBQWdCO1FBQ3hDLElBQUksQ0FBQyxPQUFPLEdBQUcsUUFBUSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxjQUFjLEdBQUcsWUFBWSxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxRQUFRLEdBQUcsS0FBSyxFQUFFLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLEVBQUUscUJBQXFCLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDNUosSUFBSSxDQUFDLFlBQVksR0FBRyxZQUFZLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLFFBQVEsR0FBRyxLQUFLLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sRUFBRSxxQkFBcUIsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUN0SixJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQzlCLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLE9BQU8sR0FBRyxZQUFZLENBQUMsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLFFBQVEsR0FBRyxVQUFVLEVBQUUsQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDO0lBQzlILENBQUM7SUFJRCxXQUFtQixnQkFBZ0I7UUFDakMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxtQkFBbUIsQ0FBa0IsaUJBQWlCLENBQUMsZUFBZSxDQUFDLENBQUM7SUFDL0YsQ0FBQztBQUNILENBQUM7QUFFRCxlQUFlLFlBQVksQ0FBQyIsImZpbGUiOiJDb3JlL01hdGVyaWFscy9CYXNlL01hdGVyaWFsUGFzcy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBCYXNpY1JlZ2lzdGVyZXIgZnJvbSBcIi4vUmVnaXN0ZXJlci9CYXNpY1JlZ2lzdGVyZXJcIjtcbmltcG9ydCBEZWZhdWx0VmFsdWVQcmVQcm9jZXNzb3IgZnJvbSBcIi4vRGVmYXVsdFZhbHVlUHJlUHJvY2Vzc29yXCI7XG5pbXBvcnQgSUNvbmZpZ3VyZUV2ZW50QXJncyBmcm9tIFwiLi4vLi4vSUNvbmZpZ3VyZUV2ZW50QXJnc1wiO1xuaW1wb3J0IEpUaHJlZU9iamVjdFdpdGhJRCBmcm9tIFwiLi4vLi4vLi4vQmFzZS9KVGhyZWVPYmplY3RXaXRoSURcIjtcbmltcG9ydCBJUmVuZGVyU3RhZ2VSZW5kZXJDb25maWd1cmUgZnJvbSBcIi4uLy4uL1JlbmRlcmVycy9SZW5kZXJTdGFnZXMvSVJlbmRlclN0YWdlUmVuZGVyZXJDb25maWd1cmVcIjtcbmltcG9ydCBNYXRlcmlhbCBmcm9tIFwiLi4vTWF0ZXJpYWxcIjtcbmltcG9ydCBJUHJvZ3JhbURlc2NyaXB0aW9uIGZyb20gXCIuL0lQcm9ncmFtRGVzY3JpcHRpb25cIjtcbmltcG9ydCBJQXBwbHlNYXRlcmlhbEFyZ3VtZW50IGZyb20gXCIuL0lBcHBseU1hdGVyaWFsQXJndW1lbnRcIjtcbmltcG9ydCBYTUxSZW5kZXJDb25maWdVdGlsaXR5IGZyb20gXCIuL1hNTFJlbmRlckNvbmZpZ1V0aWxpdHlcIjtcbmltcG9ydCBQcm9ncmFtIGZyb20gXCIuLi8uLi9SZXNvdXJjZXMvUHJvZ3JhbS9Qcm9ncmFtXCI7XG5pbXBvcnQgU2hhZGVyIGZyb20gXCIuLi8uLi9SZXNvdXJjZXMvU2hhZGVyL1NoYWRlclwiO1xuaW1wb3J0IENvbnRleHRDb21wb25lbnRzIGZyb20gXCIuLi8uLi8uLi9Db250ZXh0Q29tcG9uZW50c1wiO1xuaW1wb3J0IEpUaHJlZUNvbnRleHQgZnJvbSBcIi4uLy4uLy4uL0pUaHJlZUNvbnRleHRcIjtcbmltcG9ydCBSZXNvdXJjZU1hbmFnZXIgZnJvbSBcIi4uLy4uL1Jlc291cmNlTWFuYWdlclwiO1xuaW1wb3J0IFNoYWRlclBhcnNlciBmcm9tIFwiLi9TaGFkZXJQYXJzZXJcIjtcbmltcG9ydCBRIGZyb20gXCJxXCI7XG5jbGFzcyBNYXRlcmlhbFBhc3MgZXh0ZW5kcyBKVGhyZWVPYmplY3RXaXRoSUQge1xuXG4gIHB1YmxpYyByZWFkeTogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIHB1YmxpYyBtYXRlcmlhbE5hbWU6IHN0cmluZztcblxuICBwdWJsaWMgcGFzc0luZGV4OiBudW1iZXI7XG5cbiAgcHVibGljIGZyYWdtZW50U2hhZGVyOiBTaGFkZXI7XG5cbiAgcHVibGljIHZlcnRleFNoYWRlcjogU2hhZGVyO1xuXG4gIHB1YmxpYyBwcm9ncmFtOiBQcm9ncmFtO1xuXG4gIHB1YmxpYyBwcm9ncmFtRGVzY3JpcHRpb246IElQcm9ncmFtRGVzY3JpcHRpb247XG5cbiAgcHJpdmF0ZSBfcGFzc0RvY3VtZW50OiBFbGVtZW50O1xuXG4gIHByaXZhdGUgX3JlbmRlckNvbmZpZ3VyZUNhY2hlOiB7IFtpZDogc3RyaW5nXTogSVJlbmRlclN0YWdlUmVuZGVyQ29uZmlndXJlIH0gPSB7fTtcblxuICBwcml2YXRlIF9wYXNzSWQ6IHN0cmluZztcblxuICBwcml2YXRlIF9tYXRlcmlhbDogTWF0ZXJpYWw7XG5cbiAgY29uc3RydWN0b3IobWF0ZXJpYWw6IE1hdGVyaWFsLCBwYXNzRG9jdW1lbnQ6IEVsZW1lbnQsIG1hdGVyaWFsTmFtZTogc3RyaW5nLCBpbmRleDogbnVtYmVyKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLnBhc3NJbmRleCA9IGluZGV4O1xuICAgIHRoaXMuX21hdGVyaWFsID0gbWF0ZXJpYWw7XG4gICAgdGhpcy5fcGFzc0RvY3VtZW50ID0gcGFzc0RvY3VtZW50O1xuICAgIHRoaXMubWF0ZXJpYWxOYW1lID0gbWF0ZXJpYWxOYW1lO1xuICB9XG5cbiAgcHVibGljIGluaXRpYWxpemUodW5pZm9ybVJlZ2lzdGVyczogQmFzaWNSZWdpc3RlcmVyW10pOiBRLklQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBzaGFkZXJDb2RlID0gdGhpcy5fcGFzc0RvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKFwiZ2xzbFwiKS5pdGVtKDApLnRleHRDb250ZW50O1xuICAgIHJldHVybiBTaGFkZXJQYXJzZXIucGFyc2VDb21iaW5lZChzaGFkZXJDb2RlKS50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgIHRoaXMucHJvZ3JhbURlc2NyaXB0aW9uID0gcmVzdWx0O1xuICAgICAgdGhpcy5fY29uc3RydWN0UHJvZ3JhbSh0aGlzLm1hdGVyaWFsTmFtZSArIHRoaXMucGFzc0luZGV4KTtcbiAgICAgIHJldHVybiBEZWZhdWx0VmFsdWVQcmVQcm9jZXNzb3IucHJlcHJvY2Vzcyh0aGlzLnByb2dyYW1EZXNjcmlwdGlvbi51bmlmb3Jtcyk7XG4gICAgfSkudGhlbigoKSA9PiB7XG4gICAgICByZXR1cm4gUS5hbGwodW5pZm9ybVJlZ2lzdGVycy5tYXAobSA9PiBtLnByZXByb2Nlc3ModGhpcywgdGhpcy5wcm9ncmFtRGVzY3JpcHRpb24udW5pZm9ybXMpKSk7XG4gICAgfSkudGhlbigoKSA9PiB7XG4gICAgICB0aGlzLnJlYWR5ID0gdHJ1ZTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhcHBseShtYXRBcmc6IElBcHBseU1hdGVyaWFsQXJndW1lbnQsIHVuaWZvcm1SZWdpc3RlcnM6IEJhc2ljUmVnaXN0ZXJlcltdLCBtYXRlcmlhbDogTWF0ZXJpYWwpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMucmVhZHkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcImluaXRpYWxpemF0aW9uIHdhcyBub3QgY29tcGxldGVkIHlldCFcIik7XG4gICAgfVxuICAgIGNvbnN0IGdsID0gbWF0QXJnLnJlbmRlclN0YWdlLkdMO1xuICAgIGNvbnN0IHBXcmFwcGVyID0gdGhpcy5wcm9ncmFtLmdldEZvckNvbnRleHQobWF0QXJnLnJlbmRlclN0YWdlLlJlbmRlcmVyLkNhbnZhcyk7XG4gICAgY29uc3QgcmVuZGVyQ29uZmlnID0gdGhpcy5fZmV0Y2hSZW5kZXJDb25maWd1cmUobWF0QXJnKTtcbiAgICBYTUxSZW5kZXJDb25maWdVdGlsaXR5LmFwcGx5QWxsKGdsLCByZW5kZXJDb25maWcpO1xuICAgIC8vIERlY2xhcmUgdXNpbmcgcHJvZ3JhbSBiZWZvcmUgYXNzaWduaW5nIG1hdGVyaWFsIHZhcmlhYmxlc1xuICAgIHBXcmFwcGVyLnVzZVByb2dyYW0oKTtcbiAgICAvLyBBcHBseSBhdHRyaWJ1dGUgdmFyaWFibGVzIGJ5IGdlb21ldHJpZXNcbiAgICBtYXRBcmcub2JqZWN0Lkdlb21ldHJ5LmFwcGx5QXR0cmlidXRlVmFyaWFibGVzKHBXcmFwcGVyLCB0aGlzLnByb2dyYW1EZXNjcmlwdGlvbi5hdHRyaWJ1dGVzKTtcbiAgICAvLyBBcHBseSB1bmlmb3JtIHZhcmlhYmxlc1xuICAgIHVuaWZvcm1SZWdpc3RlcnMuZm9yRWFjaCgocikgPT4ge1xuICAgICAgci5yZWdpc3RlcihnbCwgcFdyYXBwZXIsIG1hdEFyZywgdGhpcy5wcm9ncmFtRGVzY3JpcHRpb24udW5pZm9ybXMpO1xuICAgIH0pO1xuICAgIG1hdGVyaWFsLnJlZ2lzdGVyTWF0ZXJpYWxWYXJpYWJsZXMobWF0QXJnLnJlbmRlclN0YWdlLlJlbmRlcmVyLCBwV3JhcHBlciwgdGhpcy5wcm9ncmFtRGVzY3JpcHRpb24udW5pZm9ybXMpO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9fcHJlcHJvY2Vzc1VuaWZvcm1WYXJpYWJsZXMoKTogdm9pZCB7XG4gICAgLy8gUHJlcHJvY2VzcyBkZWZhdWx0IHZhbHVlIGZvciB1bmlmb3Jtc1xuICB9XG5cbiAgcHJpdmF0ZSBfZmV0Y2hSZW5kZXJDb25maWd1cmUobWF0QXJnOiBJQXBwbHlNYXRlcmlhbEFyZ3VtZW50KTogSVJlbmRlclN0YWdlUmVuZGVyQ29uZmlndXJlIHtcbiAgICBjb25zdCBpZCA9IG1hdEFyZy5yZW5kZXJTdGFnZS5JRDtcbiAgICBsZXQgcmVzdWx0OiBJUmVuZGVyU3RhZ2VSZW5kZXJDb25maWd1cmU7XG4gICAgaWYgKHRoaXMuX3JlbmRlckNvbmZpZ3VyZUNhY2hlW2lkXSkge1xuICAgICAgcmVzdWx0ID0gdGhpcy5fcmVuZGVyQ29uZmlndXJlQ2FjaGVbaWRdO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBjb25maWd1cmUgPSBYTUxSZW5kZXJDb25maWdVdGlsaXR5LnBhcnNlUmVuZGVyQ29uZmlnKHRoaXMuX3Bhc3NEb2N1bWVudCwgbWF0QXJnLnJlbmRlclN0YWdlLmdldERlZmF1bHRSZW5kZXJlckNvbmZpZ3VyZShtYXRBcmcudGVjaG5pcXVlSW5kZXgpKTtcbiAgICAgIHRoaXMuX3JlbmRlckNvbmZpZ3VyZUNhY2hlW2lkXSA9IGNvbmZpZ3VyZTtcbiAgICAgIHJlc3VsdCA9IGNvbmZpZ3VyZTtcbiAgICB9XG4gICAgdGhpcy5fbWF0ZXJpYWwuZW1pdChcImNvbmZpZ3VyZVwiLCA8SUNvbmZpZ3VyZUV2ZW50QXJncz57XG4gICAgICBwYXNzOiB0aGlzLFxuICAgICAgcGFzc0luZGV4OiB0aGlzLnBhc3NJbmRleCxcbiAgICAgIG1hdGVyaWFsOiB0aGlzLl9tYXRlcmlhbCxcbiAgICAgIGNvbmZpZ3VyZTogcmVzdWx0XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG5cbiAgcHJpdmF0ZSBfY29uc3RydWN0UHJvZ3JhbShpZFByZWZpeDogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5fcGFzc0lkID0gaWRQcmVmaXg7XG4gICAgdGhpcy5mcmFnbWVudFNoYWRlciA9IE1hdGVyaWFsUGFzcy5fcmVzb3VyY2VNYW5hZ2VyLmNyZWF0ZVNoYWRlcihpZFByZWZpeCArIFwiLWZzXCIsIHRoaXMucHJvZ3JhbURlc2NyaXB0aW9uLmZyYWdtZW50LCBXZWJHTFJlbmRlcmluZ0NvbnRleHQuRlJBR01FTlRfU0hBREVSKTtcbiAgICB0aGlzLnZlcnRleFNoYWRlciA9IE1hdGVyaWFsUGFzcy5fcmVzb3VyY2VNYW5hZ2VyLmNyZWF0ZVNoYWRlcihpZFByZWZpeCArIFwiLXZzXCIsIHRoaXMucHJvZ3JhbURlc2NyaXB0aW9uLnZlcnRleCwgV2ViR0xSZW5kZXJpbmdDb250ZXh0LlZFUlRFWF9TSEFERVIpO1xuICAgIHRoaXMuZnJhZ21lbnRTaGFkZXIubG9hZEFsbCgpO1xuICAgIHRoaXMudmVydGV4U2hhZGVyLmxvYWRBbGwoKTtcbiAgICB0aGlzLnByb2dyYW0gPSBNYXRlcmlhbFBhc3MuX3Jlc291cmNlTWFuYWdlci5jcmVhdGVQcm9ncmFtKGlkUHJlZml4ICsgXCItcHJvZ3JhbVwiLCBbdGhpcy52ZXJ0ZXhTaGFkZXIsIHRoaXMuZnJhZ21lbnRTaGFkZXJdKTtcbiAgfVxuXG5cblxuICBwcml2YXRlIHN0YXRpYyBnZXQgX3Jlc291cmNlTWFuYWdlcigpOiBSZXNvdXJjZU1hbmFnZXIge1xuICAgIHJldHVybiBKVGhyZWVDb250ZXh0LmdldENvbnRleHRDb21wb25lbnQ8UmVzb3VyY2VNYW5hZ2VyPihDb250ZXh0Q29tcG9uZW50cy5SZXNvdXJjZU1hbmFnZXIpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IE1hdGVyaWFsUGFzcztcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==

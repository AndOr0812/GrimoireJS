import ResourceWrapper from "../ResourceWrapper";
class TextureWrapperBase extends ResourceWrapper {
    constructor(owner, parent) {
        super(owner);
        this._targetTexture = null;
        this._parent = parent;
        this._parent.onFilterParameterChanged(this._applyTextureParameter.bind(this));
    }
    get Parent() {
        return this._parent;
    }
    get TargetTexture() {
        return this._targetTexture;
    }
    bind() {
        if (this._targetTexture != null) {
            this.GL.bindTexture(this.Parent.TargetTextureType, this._targetTexture);
        }
        else {
            this.GL.bindTexture(this.Parent.TargetTextureType, null);
        }
    }
    registerTexture(registerIndex) {
        if (this.TargetTexture == null) {
            this.GL.activeTexture(WebGLRenderingContext.TEXTURE0 + registerIndex);
            this.GL.bindTexture(this._parent.TargetTextureType, null);
            return false;
        }
        this.GL.activeTexture(WebGLRenderingContext.TEXTURE0 + registerIndex);
        this._applyTextureParameter();
        return true;
    }
    init() {
        return;
    }
    preTextureUpload() {
        if (this._parent.FlipY) {
            this.GL.pixelStorei(WebGLRenderingContext.UNPACK_FLIP_Y_WEBGL, 1);
        }
        else {
            this.GL.pixelStorei(WebGLRenderingContext.UNPACK_FLIP_Y_WEBGL, 0);
        }
    }
    generateHtmlImage(encoder) {
        return null;
    }
    dispose() {
        if (this._targetTexture) {
            this.GL.deleteTexture(this._targetTexture);
            this.__setInitialized(false);
            this._targetTexture = null;
        }
    }
    getPixel(x, y) {
        const result = new Uint8Array(4);
        const frameBuffer = this.GL.createFramebuffer();
        this.GL.bindFramebuffer(this.GL.FRAMEBUFFER, frameBuffer);
        this.GL.framebufferTexture2D(this.GL.FRAMEBUFFER, this.GL.COLOR_ATTACHMENT0, this.GL.TEXTURE_2D, this._targetTexture, 0);
        this.GL.readPixels(x, y, 1, 1, this.GL.RGBA, this.Parent.ElementFormat, result);
        this.GL.deleteFramebuffer(frameBuffer);
        return result;
    }
    __setTargetTexture(texture) {
        this._targetTexture = texture;
    }
    __encodeHtmlImage(width, height, encode) {
        const lastFBO = this.GL.getParameter(this.GL.FRAMEBUFFER_BINDING);
        // Create framebuffer to transfer texture data
        const framebuffer = this.GL.createFramebuffer();
        this.GL.bindFramebuffer(this.GL.FRAMEBUFFER, framebuffer);
        this.GL.framebufferTexture2D(this.GL.FRAMEBUFFER, this.GL.COLOR_ATTACHMENT0, this.GL.TEXTURE_2D, this._targetTexture, 0);
        let data;
        let dataArrayConstructor;
        let transformFunc;
        switch (this.Parent.ElementFormat) {
            case WebGLRenderingContext.FLOAT:
                dataArrayConstructor = Float32Array;
                break;
            case WebGLRenderingContext.UNSIGNED_BYTE:
                dataArrayConstructor = Uint8Array;
                break;
            case WebGLRenderingContext.UNSIGNED_SHORT:
            case WebGLRenderingContext.UNSIGNED_SHORT_5_6_5:
            case WebGLRenderingContext.UNSIGNED_SHORT_4_4_4_4:
            case WebGLRenderingContext.UNSIGNED_SHORT_5_5_5_1:
                dataArrayConstructor = Uint16Array;
                break;
            default:
                console.error("Element format is not supported!");
                return;
        }
        switch (this.Parent.TextureFormat) {
            case WebGLRenderingContext.RGB:
                data = new dataArrayConstructor(width * height * 4);
                transformFunc = (w, h, arr) => {
                    const ret = new Uint8Array(w * h * 4);
                    for (let x = 0; x < w; x++) {
                        for (let y = 0; y < h; y++) {
                            ret[4 * (y * w + x) + 0] = arr[4 * ((h - y) * w + x) + 0];
                            ret[4 * (y * w + x) + 1] = arr[4 * ((h - y) * w + x) + 1];
                            ret[4 * (y * w + x) + 2] = arr[4 * ((h - y) * w + x) + 2];
                            ret[4 * (y * w + x) + 3] = 255;
                        }
                    }
                    return ret;
                };
                break;
            case WebGLRenderingContext.RGBA:
                data = new dataArrayConstructor(width * height * 4);
                transformFunc = (w, h, arr) => {
                    const ret = new Uint8Array(w * h * 4);
                    for (let x = 0; x < w; x++) {
                        for (let y = 0; y < h; y++) {
                            ret[4 * (y * w + x) + 0] = arr[4 * ((h - y) * w + x) + 0];
                            ret[4 * (y * w + x) + 1] = arr[4 * ((h - y) * w + x) + 1];
                            ret[4 * (y * w + x) + 2] = arr[4 * ((h - y) * w + x) + 2];
                            ret[4 * (y * w + x) + 3] = arr[4 * ((h - y) * w + x) + 3];
                        }
                    }
                    return ret;
                };
                break;
            case WebGLRenderingContext.ALPHA:
                data = new dataArrayConstructor(width * height * 4);
                transformFunc = (w, h, arr) => {
                    const ret = new Uint8Array(w * h * 4);
                    for (let x = 0; x < w; x++) {
                        for (let y = 0; y < h; y++) {
                            ret[4 * (y * w + x) + 0] = arr[4 * (y * w + x)];
                            ret[4 * (y * w + x) + 1] = 0;
                            ret[4 * (y * w + x) + 2] = 0;
                            ret[4 * (y * w + x) + 3] = 255;
                        }
                    }
                    return ret;
                };
                break;
            default:
                console.error("Specified texture format is unsupported!");
                return;
        }
        transformFunc = encode || transformFunc;
        // read pixels from framebuffer
        this.GL.readPixels(0, 0, width, height, WebGLRenderingContext.RGBA, this.Parent.ElementFormat, data);
        this.GL.deleteFramebuffer(framebuffer);
        this.GL.bindFramebuffer(this.GL.FRAMEBUFFER, lastFBO);
        // generate canvas for result
        const canvas = document.createElement("canvas");
        canvas.width = width;
        canvas.height = height;
        const context = canvas.getContext("2d");
        // Copy the pixels to a 2D canvas
        const imageData = context.createImageData(width, height);
        imageData.data.set(transformFunc(width, height, data));
        context.putImageData(imageData, 0, 0);
        const img = new Image();
        img.src = canvas.toDataURL();
        return img;
    }
    /**
     * apply texture parameters
     */
    _applyTextureParameter() {
        if (this._targetTexture == null) {
            return;
        }
        this.bind();
        this.GL.texParameteri(this.Parent.TargetTextureType, WebGLRenderingContext.TEXTURE_MIN_FILTER, this._parent.MinFilter);
        this.GL.texParameteri(this.Parent.TargetTextureType, WebGLRenderingContext.TEXTURE_MAG_FILTER, this._parent.MagFilter);
        this.GL.texParameteri(this.Parent.TargetTextureType, WebGLRenderingContext.TEXTURE_WRAP_S, this._parent.SWrap);
        this.GL.texParameteri(this.Parent.TargetTextureType, WebGLRenderingContext.TEXTURE_WRAP_T, this._parent.TWrap);
    }
}
TextureWrapperBase.__altTextureBuffer = new Uint8Array([255, 0, 255, 255]);
export default TextureWrapperBase;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkNvcmUvUmVzb3VyY2VzL1RleHR1cmUvVGV4dHVyZVdyYXBwZXJCYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJPQUFPLGVBQWUsTUFBTSxvQkFBb0I7QUFJaEQsaUNBQWlDLGVBQWU7SUFNOUMsWUFBWSxLQUFhLEVBQUUsTUFBbUI7UUFDNUMsTUFBTSxLQUFLLENBQUMsQ0FBQztRQUpQLG1CQUFjLEdBQWlCLElBQUksQ0FBQztRQUsxQyxJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztRQUN0QixJQUFJLENBQUMsT0FBTyxDQUFDLHdCQUF3QixDQUFDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUNoRixDQUFDO0lBRUQsSUFBVyxNQUFNO1FBQ2YsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDdEIsQ0FBQztJQUVELElBQVcsYUFBYTtRQUN0QixNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQztJQUM3QixDQUFDO0lBRU0sSUFBSTtRQUNULEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNoQyxJQUFJLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLGlCQUFpQixFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUMxRSxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixJQUFJLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLGlCQUFpQixFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzNELENBQUM7SUFDSCxDQUFDO0lBRU0sZUFBZSxDQUFDLGFBQXFCO1FBQzFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztZQUMvQixJQUFJLENBQUMsRUFBRSxDQUFDLGFBQWEsQ0FBQyxxQkFBcUIsQ0FB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QUFDO2dCQUNwRCxhQUFhLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUc7b0JBQ3hCLE1BQU0sR0FBRyxHQUFHLElBQUksVUFBVSxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7b0JBQ3RDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7d0JBQzNCLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7NEJBQzNCLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7NEJBQzFELEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7NEJBQzFELEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7NEJBQzFELEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMs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LEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMvRyxJQUFJLENBQUMsRUFBRSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLGlCQUFpQixFQUFFLHFCQUFxQixDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2pILENBQUM7QUFFSCxDQUFDO0FBNUxrQixxQ0FBa0IsR0FBZSxJQUFJLFVBQVUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBNExyRjtBQUNELGVBQWUsa0JBQWtCLENBQUMiLCJmaWxlIjoiQ29yZS9SZXNvdXJjZXMvVGV4dHVyZS9UZXh0dXJlV3JhcHBlckJhc2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVzb3VyY2VXcmFwcGVyIGZyb20gXCIuLi9SZXNvdXJjZVdyYXBwZXJcIjtcbmltcG9ydCBUZXh0dXJlQmFzZSBmcm9tIFwiLi9UZXh0dXJlQmFzZVwiO1xuaW1wb3J0IENhbnZhcyBmcm9tIFwiLi4vLi4vQ2FudmFzL0NhbnZhc1wiO1xuaW1wb3J0IHtGdW5jM30gZnJvbSBcIi4uLy4uLy4uL0Jhc2UvRGVsZWdhdGVzXCI7XG5jbGFzcyBUZXh0dXJlV3JhcHBlckJhc2UgZXh0ZW5kcyBSZXNvdXJjZVdyYXBwZXIge1xuXG4gIHByb3RlY3RlZCBzdGF0aWMgX19hbHRUZXh0dXJlQnVmZmVyOiBVaW50OEFycmF5ID0gbmV3IFVpbnQ4QXJyYXkoWzI1NSwgMCwgMjU1LCAyNTVdKTtcbiAgcHJpdmF0ZSBfdGFyZ2V0VGV4dHVyZTogV2ViR0xUZXh0dXJlID0gbnVsbDtcbiAgcHJpdmF0ZSBfcGFyZW50OiBUZXh0dXJlQmFzZTtcblxuICBjb25zdHJ1Y3Rvcihvd25lcjogQ2FudmFzLCBwYXJlbnQ6IFRleHR1cmVCYXNlKSB7XG4gICAgc3VwZXIob3duZXIpO1xuICAgIHRoaXMuX3BhcmVudCA9IHBhcmVudDtcbiAgICB0aGlzLl9wYXJlbnQub25GaWx0ZXJQYXJhbWV0ZXJDaGFuZ2VkKHRoaXMuX2FwcGx5VGV4dHVyZVBhcmFtZXRlci5iaW5kKHRoaXMpKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgUGFyZW50KCk6IFRleHR1cmVCYXNlIHtcbiAgICByZXR1cm4gdGhpcy5fcGFyZW50O1xuICB9XG5cbiAgcHVibGljIGdldCBUYXJnZXRUZXh0dXJlKCk6IFdlYkdMVGV4dHVyZSB7XG4gICAgcmV0dXJuIHRoaXMuX3RhcmdldFRleHR1cmU7XG4gIH1cblxuICBwdWJsaWMgYmluZCgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5fdGFyZ2V0VGV4dHVyZSAhPSBudWxsKSB7XG4gICAgICB0aGlzLkdMLmJpbmRUZXh0dXJlKHRoaXMuUGFyZW50LlRhcmdldFRleHR1cmVUeXBlLCB0aGlzLl90YXJnZXRUZXh0dXJlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5HTC5iaW5kVGV4dHVyZSh0aGlzLlBhcmVudC5UYXJnZXRUZXh0dXJlVHlwZSwgbnVsbCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHJlZ2lzdGVyVGV4dHVyZShyZWdpc3RlckluZGV4OiBudW1iZXIpOiBib29sZWFuIHtcbiAgICBpZiAodGhpcy5UYXJnZXRUZXh0dXJlID09IG51bGwpIHtcbiAgICAgIHRoaXMuR0wuYWN0aXZlVGV4dHVyZShXZWJHTFJlbmRlcmluZ0NvbnRleHQuVEVYVFVSRTAgKyByZWdpc3RlckluZGV4KTtcbiAgICAgIHRoaXMuR0wuYmluZFRleHR1cmUodGhpcy5fcGFyZW50LlRhcmdldFRleHR1cmVUeXBlLCBudWxsKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgdGhpcy5HTC5hY3RpdmVUZXh0dXJlKFdlYkdMUmVuZGVyaW5nQ29udGV4dC5URVhUVVJFMCArIHJlZ2lzdGVySW5kZXgpO1xuICAgIHRoaXMuX2FwcGx5VGV4dHVyZVBhcmFtZXRlcigpO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgcHVibGljIGluaXQoKTogdm9pZCB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgcHVibGljIHByZVRleHR1cmVVcGxvYWQoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX3BhcmVudC5GbGlwWSkge1xuICAgICAgdGhpcy5HTC5waXhlbFN0b3JlaShXZWJHTFJlbmRlcmluZ0NvbnRleHQuVU5QQUNLX0ZMSVBfWV9XRUJHTCwgMSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuR0wucGl4ZWxTdG9yZWkoV2ViR0xSZW5kZXJpbmdDb250ZXh0LlVOUEFDS19GTElQX1lfV0VCR0wsIDApO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZW5lcmF0ZUh0bWxJbWFnZShlbmNvZGVyPzogRnVuYzM8bnVtYmVyLCBudW1iZXIsIEFycmF5QnVmZmVyVmlldywgVWludDhBcnJheT4pOiBIVE1MSW1hZ2VFbGVtZW50IHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHB1YmxpYyBkaXNwb3NlKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLl90YXJnZXRUZXh0dXJlKSB7XG4gICAgICB0aGlzLkdMLmRlbGV0ZVRleHR1cmUodGhpcy5fdGFyZ2V0VGV4dHVyZSk7XG4gICAgICB0aGlzLl9fc2V0SW5pdGlhbGl6ZWQoZmFsc2UpO1xuICAgICAgdGhpcy5fdGFyZ2V0VGV4dHVyZSA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldFBpeGVsKHg6IG51bWJlciwgeTogbnVtYmVyKTogQXJyYXlCdWZmZXJWaWV3IHtcbiAgICBjb25zdCByZXN1bHQgPSBuZXcgVWludDhBcnJheSg0KTtcbiAgICBjb25zdCBmcmFtZUJ1ZmZlciA9IHRoaXMuR0wuY3JlYXRlRnJhbWVidWZmZXIoKTtcbiAgICB0aGlzLkdMLmJpbmRGcmFtZWJ1ZmZlcih0aGlzLkdMLkZSQU1FQlVGRkVSLCBmcmFtZUJ1ZmZlcik7XG4gICAgdGhpcy5HTC5mcmFtZWJ1ZmZlclRleHR1cmUyRCh0aGlzLkdMLkZSQU1FQlVGRkVSLCB0aGlzLkdMLkNPTE9SX0FUVEFDSE1FTlQwLCB0aGlzLkdMLlRFWFRVUkVfMkQsIHRoaXMuX3RhcmdldFRleHR1cmUsIDApO1xuICAgIHRoaXMuR0wucmVhZFBpeGVscyh4LCB5LCAxLCAxLCB0aGlzLkdMLlJHQkEsIHRoaXMuUGFyZW50LkVsZW1lbnRGb3JtYXQsIHJlc3VsdCk7XG4gICAgdGhpcy5HTC5kZWxldGVGcmFtZWJ1ZmZlcihmcmFtZUJ1ZmZlcik7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHByb3RlY3RlZCBfX3NldFRhcmdldFRleHR1cmUodGV4dHVyZTogV2ViR0xUZXh0dXJlKTogdm9pZCB7XG4gICAgdGhpcy5fdGFyZ2V0VGV4dHVyZSA9IHRleHR1cmU7XG4gIH1cblxuXG4gIHByb3RlY3RlZCBfX2VuY29kZUh0bWxJbWFnZSh3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciwgZW5jb2RlPzogRnVuYzM8bnVtYmVyLCBudW1iZXIsIEFycmF5QnVmZmVyVmlldywgVWludDhBcnJheT4pOiBhbnkge1xuICAgIGNvbnN0IGxhc3RGQk8gPSB0aGlzLkdMLmdldFBhcmFtZXRlcih0aGlzLkdMLkZSQU1FQlVGRkVSX0JJTkRJTkcpO1xuICAgIC8vIENyZWF0ZSBmcmFtZWJ1ZmZlciB0byB0cmFuc2ZlciB0ZXh0dXJlIGRhdGFcbiAgICBjb25zdCBmcmFtZWJ1ZmZlciA9IHRoaXMuR0wuY3JlYXRlRnJhbWVidWZmZXIoKTtcbiAgICB0aGlzLkdMLmJpbmRGcmFtZWJ1ZmZlcih0aGlzLkdMLkZSQU1FQlVGRkVSLCBmcmFtZWJ1ZmZlcik7XG4gICAgdGhpcy5HTC5mcmFtZWJ1ZmZlclRleHR1cmUyRCh0aGlzLkdMLkZSQU1FQlVGRkVSLCB0aGlzLkdMLkNPTE9SX0FUVEFDSE1FTlQwLCB0aGlzLkdMLlRFWFRVUkVfMkQsIHRoaXMuX3RhcmdldFRleHR1cmUsIDApO1xuICAgIGxldCBkYXRhOiBBcnJheUJ1ZmZlclZpZXc7XG4gICAgbGV0IGRhdGFBcnJheUNvbnN0cnVjdG9yOiBhbnk7XG4gICAgbGV0IHRyYW5zZm9ybUZ1bmM7XG4gICAgc3dpdGNoICh0aGlzLlBhcmVudC5FbGVtZW50Rm9ybWF0KSB7XG4gICAgICBjYXNlIFdlYkdMUmVuZGVyaW5nQ29udGV4dC5GTE9BVDpcbiAgICAgICAgZGF0YUFycmF5Q29uc3RydWN0b3IgPSBGbG9hdDMyQXJyYXk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIFdlYkdMUmVuZGVyaW5nQ29udGV4dC5VTlNJR05FRF9CWVRFOlxuICAgICAgICBkYXRhQXJyYXlDb25zdHJ1Y3RvciA9IFVpbnQ4QXJyYXk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIFdlYkdMUmVuZGVyaW5nQ29udGV4dC5VTlNJR05FRF9TSE9SVDpcbiAgICAgIGNhc2UgV2ViR0xSZW5kZXJpbmdDb250ZXh0LlVOU0lHTkVEX1NIT1JUXzVfNl81OlxuICAgICAgY2FzZSBXZWJHTFJlbmRlcmluZ0NvbnRleHQuVU5TSUdORURfU0hPUlRfNF80XzRfNDpcbiAgICAgIGNhc2UgV2ViR0xSZW5kZXJpbmdDb250ZXh0LlVOU0lHTkVEX1NIT1JUXzVfNV81XzE6XG4gICAgICAgIGRhdGFBcnJheUNvbnN0cnVjdG9yID0gVWludDE2QXJyYXk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgY29uc29sZS5lcnJvcihcIkVsZW1lbnQgZm9ybWF0IGlzIG5vdCBzdXBwb3J0ZWQhXCIpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIHN3aXRjaCAodGhpcy5QYXJlbnQuVGV4dHVyZUZvcm1hdCkge1xuICAgICAgY2FzZSBXZWJHTFJlbmRlcmluZ0NvbnRleHQuUkdCOlxuICAgICAgICBkYXRhID0gbmV3IGRhdGFBcnJheUNvbnN0cnVjdG9yKHdpZHRoICogaGVpZ2h0ICogNCk7XG4gICAgICAgIHRyYW5zZm9ybUZ1bmMgPSAodywgaCwgYXJyKSA9PiB7XG4gICAgICAgICAgY29uc3QgcmV0ID0gbmV3IFVpbnQ4QXJyYXkodyAqIGggKiA0KTtcbiAgICAgICAgICBmb3IgKGxldCB4ID0gMDsgeCA8IHc7IHgrKykge1xuICAgICAgICAgICAgZm9yIChsZXQgeSA9IDA7IHkgPCBoOyB5KyspIHtcbiAgICAgICAgICAgICAgcmV0WzQgKiAoeSAqIHcgKyB4KSArIDBdID0gYXJyWzQgKiAoKGggLSB5KSAqIHcgKyB4KSArIDBdO1xuICAgICAgICAgICAgICByZXRbNCAqICh5ICogdyArIHgpICsgMV0gPSBhcnJbNCAqICgoaCAtIHkpICogdyArIHgpICsgMV07XG4gICAgICAgICAgICAgIHJldFs0ICogKHkgKiB3ICsgeCkgKyAyXSA9IGFycls0ICogKChoIC0geSkgKiB3ICsgeCkgKyAyXTtcbiAgICAgICAgICAgICAgcmV0WzQgKiAoeSAqIHcgKyB4KSArIDNdID0gMjU1O1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gcmV0O1xuICAgICAgICB9O1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgV2ViR0xSZW5kZXJpbmdDb250ZXh0LlJHQkE6XG4gICAgICAgIGRhdGEgPSBuZXcgZGF0YUFycmF5Q29uc3RydWN0b3Iod2lkdGggKiBoZWlnaHQgKiA0KTtcbiAgICAgICAgdHJhbnNmb3JtRnVuYyA9ICh3LCBoLCBhcnIpID0+IHtcbiAgICAgICAgICBjb25zdCByZXQgPSBuZXcgVWludDhBcnJheSh3ICogaCAqIDQpO1xuICAgICAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgdzsgeCsrKSB7XG4gICAgICAgICAgICBmb3IgKGxldCB5ID0gMDsgeSA8IGg7IHkrKykge1xuICAgICAgICAgICAgICByZXRbNCAqICh5ICogdyArIHgpICsgMF0gPSBhcnJbNCAqICgoaCAtIHkpICogdyArIHgpICsgMF07XG4gICAgICAgICAgICAgIHJldFs0ICogKHkgKiB3ICsgeCkgKyAxXSA9IGFycls0ICogKChoIC0geSkgKiB3ICsgeCkgKyAxXTtcbiAgICAgICAgICAgICAgcmV0WzQgKiAoeSAqIHcgKyB4KSArIDJdID0gYXJyWzQgKiAoKGggLSB5KSAqIHcgKyB4KSArIDJdO1xuICAgICAgICAgICAgICByZXRbNCAqICh5ICogdyArIHgpICsgM10gPSBhcnJbNCAqICgoaCAtIHkpICogdyArIHgpICsgM107XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiByZXQ7XG4gICAgICAgIH07XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBXZWJHTFJlbmRlcmluZ0NvbnRleHQuQUxQSEE6XG4gICAgICAgIGRhdGEgPSBuZXcgZGF0YUFycmF5Q29uc3RydWN0b3Iod2lkdGggKiBoZWlnaHQgKiA0KTtcbiAgICAgICAgdHJhbnNmb3JtRnVuYyA9ICh3LCBoLCBhcnIpID0+IHtcbiAgICAgICAgICBjb25zdCByZXQgPSBuZXcgVWludDhBcnJheSh3ICogaCAqIDQpO1xuICAgICAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgdzsgeCsrKSB7XG4gICAgICAgICAgICBmb3IgKGxldCB5ID0gMDsgeSA8IGg7IHkrKykge1xuICAgICAgICAgICAgICByZXRbNCAqICh5ICogdyArIHgpICsgMF0gPSBhcnJbNCAqICh5ICogdyArIHgpXTtcbiAgICAgICAgICAgICAgcmV0WzQgKiAoeSAqIHcgKyB4KSArIDFdID0gMDtcbiAgICAgICAgICAgICAgcmV0WzQgKiAoeSAqIHcgKyB4KSArIDJdID0gMDtcbiAgICAgICAgICAgICAgcmV0WzQgKiAoeSAqIHcgKyB4KSArIDNdID0gMjU1O1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gcmV0O1xuICAgICAgICB9O1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJTcGVjaWZpZWQgdGV4dHVyZSBmb3JtYXQgaXMgdW5zdXBwb3J0ZWQhXCIpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIHRyYW5zZm9ybUZ1bmMgPSBlbmNvZGUgfHwgdHJhbnNmb3JtRnVuYztcbiAgICAvLyByZWFkIHBpeGVscyBmcm9tIGZyYW1lYnVmZmVyXG4gICAgdGhpcy5HTC5yZWFkUGl4ZWxzKDAsIDAsIHdpZHRoLCBoZWlnaHQsIFdlYkdMUmVuZGVyaW5nQ29udGV4dC5SR0JBLCB0aGlzLlBhcmVudC5FbGVtZW50Rm9ybWF0LCBkYXRhKTtcbiAgICB0aGlzLkdMLmRlbGV0ZUZyYW1lYnVmZmVyKGZyYW1lYnVmZmVyKTtcbiAgICB0aGlzLkdMLmJpbmRGcmFtZWJ1ZmZlcih0aGlzLkdMLkZSQU1FQlVGRkVSLCBsYXN0RkJPKTtcbiAgICAvLyBnZW5lcmF0ZSBjYW52YXMgZm9yIHJlc3VsdFxuICAgIGNvbnN0IGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJjYW52YXNcIik7XG4gICAgY2FudmFzLndpZHRoID0gd2lkdGg7XG4gICAgY2FudmFzLmhlaWdodCA9IGhlaWdodDtcbiAgICBjb25zdCBjb250ZXh0ID0gY2FudmFzLmdldENvbnRleHQoXCIyZFwiKTtcblxuICAgIC8vIENvcHkgdGhlIHBpeGVscyB0byBhIDJEIGNhbnZhc1xuICAgIGNvbnN0IGltYWdlRGF0YSA9IGNvbnRleHQuY3JlYXRlSW1hZ2VEYXRhKHdpZHRoLCBoZWlnaHQpO1xuICAgICg8YW55PmltYWdlRGF0YS5kYXRhKS5zZXQoPGFueT50cmFuc2Zvcm1GdW5jKHdpZHRoLCBoZWlnaHQsIGRhdGEpKTtcbiAgICBjb250ZXh0LnB1dEltYWdlRGF0YShpbWFnZURhdGEsIDAsIDApO1xuICAgIGNvbnN0IGltZyA9IG5ldyBJbWFnZSgpO1xuICAgIGltZy5zcmMgPSBjYW52YXMudG9EYXRhVVJMKCk7XG4gICAgcmV0dXJuIGltZztcbiAgfVxuXG4gIC8qKlxuICAgKiBhcHBseSB0ZXh0dXJlIHBhcmFtZXRlcnNcbiAgICovXG4gIHByaXZhdGUgX2FwcGx5VGV4dHVyZVBhcmFtZXRlcigpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5fdGFyZ2V0VGV4dHVyZSA9PSBudWxsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuYmluZCgpO1xuICAgIHRoaXMuR0wudGV4UGFyYW1ldGVyaSh0aGlzLlBhcmVudC5UYXJnZXRUZXh0dXJlVHlwZSwgV2ViR0xSZW5kZXJpbmdDb250ZXh0LlRFWFRVUkVfTUlOX0ZJTFRFUiwgdGhpcy5fcGFyZW50Lk1pbkZpbHRlcik7XG4gICAgdGhpcy5HTC50ZXhQYXJhbWV0ZXJpKHRoaXMuUGFyZW50LlRhcmdldFRleHR1cmVUeXBlLCBXZWJHTFJlbmRlcmluZ0NvbnRleHQuVEVYVFVSRV9NQUdfRklMVEVSLCB0aGlzLl9wYXJlbnQuTWFnRmlsdGVyKTtcbiAgICB0aGlzLkdMLnRleFBhcmFtZXRlcmkodGhpcy5QYXJlbnQuVGFyZ2V0VGV4dHVyZVR5cGUsIFdlYkdMUmVuZGVyaW5nQ29udGV4dC5URVhUVVJFX1dSQVBfUywgdGhpcy5fcGFyZW50LlNXcmFwKTtcbiAgICB0aGlzLkdMLnRleFBhcmFtZXRlcmkodGhpcy5QYXJlbnQuVGFyZ2V0VGV4dHVyZVR5cGUsIFdlYkdMUmVuZGVyaW5nQ29udGV4dC5URVhUVVJFX1dSQVBfVCwgdGhpcy5fcGFyZW50LlRXcmFwKTtcbiAgfVxuXG59XG5leHBvcnQgZGVmYXVsdCBUZXh0dXJlV3JhcHBlckJhc2U7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=

import DebuggerModuleBase from "./DebuggerModuleBase";
import JThreeContext from "../../JThreeContext";
import ContextComponents from "../../ContextComponents";
import Q from "q";
class RendererDebugger extends DebuggerModuleBase {
    attach(debug) {
        const sm = JThreeContext.getContextComponent(ContextComponents.SceneManager);
        sm.Scenes.forEach(s => {
            this._attachToScene(s, debug);
        });
        sm.on("change", (h) => {
            if (h.isAdditionalChange) {
                this._attachToScene(h.changedScene, debug);
            }
            else {
            }
        });
    }
    getShadowMapImage(rendererID, generator) {
        const d = Q.defer();
        this._shadowMapRequest = {
            deffered: d,
            rendererID: rendererID,
            generator: generator
        };
        return d.promise;
    }
    getShadowMapProgressImage(rendererID, generator) {
        const d = Q.defer();
        this._shadowMapProgressRequest = {
            deffered: d,
            rendererID: rendererID,
            generator: generator,
            begin: false
        };
        return d.promise;
    }
    getTextureHtmlImage(stageID, bufferTextureID, generator) {
        const d = Q.defer();
        this._bufferTextureRequest = {
            deffered: d,
            stageID: stageID,
            bufferTextureID: bufferTextureID,
            generator: generator
        };
        return d.promise;
    }
    getTextureProgressHtmlImage(stageID, bufferTextureID, generator) {
        const d = Q.defer();
        this._bufferTextureProgressRequest = {
            deffered: d,
            stageID: stageID,
            bufferTextureID: bufferTextureID,
            generator: generator,
            begin: false
        };
        return d.promise;
    }
    _attachToScene(scene, debug) {
        scene.Renderers.forEach(r => {
            this._attachToRenderer(r, debug);
        });
        scene.on("changed-renderer", (h) => {
            if (h.isAdditionalChange) {
                this._attachToRenderer(h.renderer, debug);
            }
            else {
            }
        });
    }
    _canvasToimg(renderer) {
        const canvas = renderer.Canvas;
        const img = new Image(canvas.canvasElement.width, canvas.canvasElement.height);
        img.src = canvas.canvasElement.toDataURL();
        return img;
    }
    _attachToRenderer(renderer, debug) {
        debug.debuggerAPI.renderers.addRenderer(renderer, this);
        renderer.RenderPathExecutor.on("rendered-stage", (v) => {
            if (this._bufferTextureRequest && v.completedChain.stage.ID === this._bufferTextureRequest.stageID) {
                if (v.bufferTextures[this._bufferTextureRequest.bufferTextureID] == null) {
                    this._bufferTextureRequest.deffered.resolve(this._canvasToimg(v.owner.renderer));
                    this._bufferTextureRequest = null;
                    return;
                }
                this._bufferTextureRequest.deffered.resolve(v.bufferTextures[this._bufferTextureRequest.bufferTextureID].wrappers[0].generateHtmlImage(this._bufferTextureRequest.generator));
                this._bufferTextureRequest = null;
            }
        });
        renderer.RenderPathExecutor.on("rendered-path", (v) => {
            if (this._shadowMapRequest && v.owner.renderer.ID === this._shadowMapRequest.rendererID) {
                // this.shadowMapRequest.deffered.resolve(v.scene.LightRegister.shadowMapResourceManager.shadowMapTileTexture.wrappers[0].generateHtmlImage(this.shadowMapRequest.generator));
                this._shadowMapRequest = null;
            }
            if (this._bufferTextureProgressRequest && this._bufferTextureProgressRequest.begin) {
                this._bufferTextureProgressRequest.deffered.resolve(null);
                this._bufferTextureProgressRequest = null;
            }
            if (this._shadowMapProgressRequest && this._shadowMapProgressRequest.begin) {
                this._shadowMapProgressRequest.deffered.resolve(null);
                this._shadowMapProgressRequest = null;
            }
        });
        renderer.RenderPathExecutor.on("rendered-object", (v) => {
            let img;
            if (this._bufferTextureProgressRequest && v.stage.ID === this._bufferTextureProgressRequest.stageID) {
                this._bufferTextureProgressRequest.begin = true;
                v.owner.renderer.GL.flush();
                if (v.bufferTextures[this._bufferTextureProgressRequest.bufferTextureID] == null) {
                    // for default buffer
                    img = this._canvasToimg(v.owner.renderer);
                }
                else {
                    img = v.bufferTextures[this._bufferTextureProgressRequest.bufferTextureID].wrappers[0].generateHtmlImage(this._bufferTextureProgressRequest.generator);
                }
                img.title = `object:${v.renderedObject.name} technique:${v.technique}`;
                this._bufferTextureProgressRequest.deffered.notify({
                    image: img,
                    object: v.renderedObject,
                    technique: v.technique
                });
            }
            if (this._shadowMapProgressRequest && v.stage.getTypeName() === "ShadowMapGenerationStage" && v.stage.Renderer.ID === this._shadowMapProgressRequest.rendererID) {
                this._shadowMapProgressRequest.begin = true;
                v.owner.renderer.GL.flush();
                img = undefined; // v.renderedObject.ParentScene.LightRegister.shadowMapResourceManager.shadowMapTileTexture.wrappers[0].generateHtmlImage(this.shadowMapProgressRequest.generator);
                img.title = `object:${v.renderedObject.name} technique:${v.technique}`;
                this._shadowMapProgressRequest.deffered.notify({
                    image: img,
                    object: v.renderedObject,
                    technique: v.technique
                });
            }
        });
    }
}
export default RendererDebugger;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkRlYnVnL01vZHVsZXMvUmVuZGVyZXJEZWJ1Z2dlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiT0FBTyxrQkFBa0IsTUFBTSxzQkFBc0I7T0FHOUMsYUFBYSxNQUFNLHFCQUFxQjtPQUN4QyxpQkFBaUIsTUFBTSx5QkFBeUI7T0FHaEQsQ0FBQyxNQUFNLEdBQUc7QUFNakIsK0JBQStCLGtCQUFrQjtJQVN4QyxNQUFNLENBQUMsS0FBZTtRQUMzQixNQUFNLEVBQUUsR0FBRyxhQUFhLENBQUMsbUJBQW1CLENBQWUsaUJBQWlCLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDM0YsRUFBRSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNqQixJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNoQyxDQUFDLENBQUMsQ0FBQztRQUNILEVBQUUsQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztZQUNoQixFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDO2dCQUN6QixJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxZQUFZLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDN0MsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO1lBRVIsQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVNLGlCQUFpQixDQUFDLFVBQWtCLEVBQUUsU0FBZTtRQUMxRCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxFQUFvQixDQUFDO1FBQ3RDLElBQUksQ0FBQyxpQkFBaUIsR0FBRztZQUN2QixRQUFRLEVBQUUsQ0FBQztZQUNYLFVBQVUsRUFBRSxVQUFVO1lBQ3RCLFNBQVMsRUFBRSxTQUFTO1NBQ3JCLENBQUM7UUFDRixNQUFNLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztJQUNuQixDQUFDO0lBRU0seUJBQXlCLENBQUMsVUFBa0IsRUFBRSxTQUFlO1FBQ2xFLE1B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Y0FBYyxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUM7Z0JBQ3ZFLElBQUksQ0FBQyw2QkFBNkIsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUNoRDtvQkFDRSxLQUFLLEVBQUUsR0FBRztvQkFDVixNQUFNLEVBQUUsQ0FBQyxDQUFDLGNBQWM7b0JBQ3hCLFNBQVMsRUFBRSxDQUFDLENBQUMsU0FBUztpQkFDdkIsQ0FDQSxDQUFDO1lBQ04sQ0FBQztZQUNELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyx5QkFBeUIsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxLQUFLLDBCQUEwQixJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEVBQUUsS0FBSyxJQUFJLENBQUMseUJBQXlCLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztnQkFDaEssSUFBSSxDQUFDLHlCQUF5QixDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7Z0JBQzVDLENBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFDNUIsR0FBRyxHQUFHLFNBQVMsQ0FBQyxDQUFDLG1LQUFtSztnQkFDcEwsR0FBRyxDQUFDLEtBQUssR0FBRyxVQUFVLENBQUMsQ0FBQyxjQUFjLENBQUMsSUFBSSxjQUFjLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztnQkFDdkUsSUFBSSxDQUFDLHlCQUF5QixDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQzVDO29CQUNFLEtBQUssRUFBRSxHQUFHO29CQUNWLE1BQU0sRUFBRSxDQUFDLENBQUMsY0FBYztvQkFDeEIsU0FBUyxFQUFFLENBQUMsQ0FBQyxTQUFTO2lCQUN2QixDQUNBLENBQUM7WUFDTixDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0FBRUgsQ0FBQztBQUVELGVBQWUsZ0JBQWdCLENBQUMiLCJmaWxlIjoiRGVidWcvTW9kdWxlcy9SZW5kZXJlckRlYnVnZ2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IERlYnVnZ2VyTW9kdWxlQmFzZSBmcm9tIFwiLi9EZWJ1Z2dlck1vZHVsZUJhc2VcIjtcbmltcG9ydCBEZWJ1Z2dlciBmcm9tIFwiLi4vRGVidWdnZXJcIjtcbmltcG9ydCBTY2VuZU1hbmFnZXIgZnJvbSBcIi4uLy4uL0NvcmUvU2NlbmVNYW5hZ2VyXCI7XG5pbXBvcnQgSlRocmVlQ29udGV4dCBmcm9tIFwiLi4vLi4vSlRocmVlQ29udGV4dFwiO1xuaW1wb3J0IENvbnRleHRDb21wb25lbnRzIGZyb20gXCIuLi8uLi9Db250ZXh0Q29tcG9uZW50c1wiO1xuaW1wb3J0IFNjZW5lIGZyb20gXCIuLi8uLi9Db3JlL1NjZW5lXCI7XG5pbXBvcnQgQmFzaWNSZW5kZXJlciBmcm9tIFwiLi4vLi4vQ29yZS9SZW5kZXJlcnMvQmFzaWNSZW5kZXJlclwiO1xuaW1wb3J0IFEgZnJvbSBcInFcIjtcbmltcG9ydCBDYW52YXMgZnJvbSBcIi4uLy4uL0NvcmUvQ2FudmFzL0NhbnZhc1wiO1xuaW1wb3J0IElSZXF1ZXN0QnVmZmVyVGV4dHVyZSBmcm9tIFwiLi9SZW5kZXJlci9JUmVxdWVzdEJ1ZmZlclRleHR1cmVcIjtcbmltcG9ydCBJUmVxdWVzdFNoYWRvd01hcFRleHR1cmUgZnJvbSBcIi4vUmVuZGVyZXIvSVJlcXVlc3RTaGFkb3dNYXBUZXh0dXJlXCI7XG5pbXBvcnQgSVJlcXVlc3RCdWZmZXJUZXh0dXJlUHJvZ3Jlc3MgZnJvbSBcIi4vUmVuZGVyZXIvSVJlcXVlc3RCdWZmZXJUZXh0dXJlUHJvZ3Jlc3NcIjtcbmltcG9ydCBJUmVxdWVzdFNoYWRvd01hcFByb2dyZXNzIGZyb20gXCIuL1JlbmRlcmVyL0lSZXF1ZXN0U2hhZG93TWFwUHJvZ3Jlc3NcIjtcbmNsYXNzIFJlbmRlcmVyRGVidWdnZXIgZXh0ZW5kcyBEZWJ1Z2dlck1vZHVsZUJhc2Uge1xuICBwcml2YXRlIF9idWZmZXJUZXh0dXJlUmVxdWVzdDogSVJlcXVlc3RCdWZmZXJUZXh0dXJlO1xuXG4gIHByaXZhdGUgX3NoYWRvd01hcFJlcXVlc3Q6IElSZXF1ZXN0U2hhZG93TWFwVGV4dHVyZTtcblxuICBwcml2YXRlIF9idWZmZXJUZXh0dXJlUHJvZ3Jlc3NSZXF1ZXN0OiBJUmVxdWVzdEJ1ZmZlclRleHR1cmVQcm9ncmVzcztcblxuICBwcml2YXRlIF9zaGFkb3dNYXBQcm9ncmVzc1JlcXVlc3Q6IElSZXF1ZXN0U2hhZG93TWFwUHJvZ3Jlc3M7XG5cbiAgcHVibGljIGF0dGFjaChkZWJ1ZzogRGVidWdnZXIpOiB2b2lkIHtcbiAgICBjb25zdCBzbSA9IEpUaHJlZUNvbnRleHQuZ2V0Q29udGV4dENvbXBvbmVudDxTY2VuZU1hbmFnZXI+KENvbnRleHRDb21wb25lbnRzLlNjZW5lTWFuYWdlcik7XG4gICAgc20uU2NlbmVzLmZvckVhY2gocyA9PiB7XG4gICAgICB0aGlzLl9hdHRhY2hUb1NjZW5lKHMsIGRlYnVnKTtcbiAgICB9KTtcbiAgICBzbS5vbihcImNoYW5nZVwiLCAoaCkgPT4ge1xuICAgICAgaWYgKGguaXNBZGRpdGlvbmFsQ2hhbmdlKSB7XG4gICAgICAgIHRoaXMuX2F0dGFjaFRvU2NlbmUoaC5jaGFuZ2VkU2NlbmUsIGRlYnVnKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIFRPRE8gYWRkIGNvZGUgZm9yIGRlbGV0ZVxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGdldFNoYWRvd01hcEltYWdlKHJlbmRlcmVySUQ6IHN0cmluZywgZ2VuZXJhdG9yPzogYW55KTogUS5JUHJvbWlzZTxIVE1MSW1hZ2VFbGVtZW50PiB7XG4gICAgY29uc3QgZCA9IFEuZGVmZXI8SFRNTEltYWdlRWxlbWVudD4oKTtcbiAgICB0aGlzLl9zaGFkb3dNYXBSZXF1ZXN0ID0ge1xuICAgICAgZGVmZmVyZWQ6IGQsXG4gICAgICByZW5kZXJlcklEOiByZW5kZXJlcklELFxuICAgICAgZ2VuZXJhdG9yOiBnZW5lcmF0b3JcbiAgICB9O1xuICAgIHJldHVybiBkLnByb21pc2U7XG4gIH1cblxuICBwdWJsaWMgZ2V0U2hhZG93TWFwUHJvZ3Jlc3NJbWFnZShyZW5kZXJlcklEOiBzdHJpbmcsIGdlbmVyYXRvcj86IGFueSk6IFEuSVByb21pc2U8SFRNTEltYWdlRWxlbWVudD4ge1xuICAgIGNvbnN0IGQgPSBRLmRlZmVyPEhUTUxJbWFnZUVsZW1lbnQ+KCk7XG4gICAgdGhpcy5fc2hhZG93TWFwUHJvZ3Jlc3NSZXF1ZXN0ID0ge1xuICAgICAgZGVmZmVyZWQ6IGQsXG4gICAgICByZW5kZXJlcklEOiByZW5kZXJlcklELFxuICAgICAgZ2VuZXJhdG9yOiBnZW5lcmF0b3IsXG4gICAgICBiZWdpbjogZmFsc2VcbiAgICB9O1xuICAgIHJldHVybiBkLnByb21pc2U7XG4gIH1cblxuICBwdWJsaWMgZ2V0VGV4dHVyZUh0bWxJbWFnZShzdGFnZUlEOiBzdHJpbmcsIGJ1ZmZlclRleHR1cmVJRDogc3RyaW5nLCBnZW5lcmF0b3I/OiBhbnkpOiBRLklQcm9taXNlPEhUTUxJbWFnZUVsZW1lbnQ+IHtcbiAgICBjb25zdCBkID0gUS5kZWZlcjxIVE1MSW1hZ2VFbGVtZW50PigpO1xuICAgIHRoaXMuX2J1ZmZlclRleHR1cmVSZXF1ZXN0ID0ge1xuICAgICAgZGVmZmVyZWQ6IGQsXG4gICAgICBzdGFnZUlEOiBzdGFnZUlELFxuICAgICAgYnVmZmVyVGV4dHVyZUlEOiBidWZmZXJUZXh0dXJlSUQsXG4gICAgICBnZW5lcmF0b3I6IGdlbmVyYXRvclxuICAgIH07XG4gICAgcmV0dXJuIGQucHJvbWlzZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRUZXh0dXJlUHJvZ3Jlc3NIdG1sSW1hZ2Uoc3RhZ2VJRDogc3RyaW5nLCBidWZmZXJUZXh0dXJlSUQ6IHN0cmluZywgZ2VuZXJhdG9yPzogYW55KTogUS5JUHJvbWlzZTxIVE1MSW1hZ2VFbGVtZW50PiB7XG4gICAgY29uc3QgZCA9IFEuZGVmZXI8SFRNTEltYWdlRWxlbWVudD4oKTtcbiAgICB0aGlzLl9idWZmZXJUZXh0dXJlUHJvZ3Jlc3NSZXF1ZXN0ID0ge1xuICAgICAgZGVmZmVyZWQ6IGQsXG4gICAgICBzdGFnZUlEOiBzdGFnZUlELFxuICAgICAgYnVmZmVyVGV4dHVyZUlEOiBidWZmZXJUZXh0dXJlSUQsXG4gICAgICBnZW5lcmF0b3I6IGdlbmVyYXRvcixcbiAgICAgIGJlZ2luOiBmYWxzZVxuICAgIH07XG4gICAgcmV0dXJuIGQucHJvbWlzZTtcbiAgfVxuXG4gIHByaXZhdGUgX2F0dGFjaFRvU2NlbmUoc2NlbmU6IFNjZW5lLCBkZWJ1ZzogRGVidWdnZXIpOiB2b2lkIHtcbiAgICBzY2VuZS5SZW5kZXJlcnMuZm9yRWFjaChyID0+IHtcbiAgICAgIHRoaXMuX2F0dGFjaFRvUmVuZGVyZXIociwgZGVidWcpO1xuICAgIH0pO1xuICAgIHNjZW5lLm9uKFwiY2hhbmdlZC1yZW5kZXJlclwiLCAoaCkgPT4ge1xuICAgICAgaWYgKGguaXNBZGRpdGlvbmFsQ2hhbmdlKSB7XG4gICAgICAgIHRoaXMuX2F0dGFjaFRvUmVuZGVyZXIoaC5yZW5kZXJlciwgZGVidWcpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gVE9ETyBhZGQgY29kZSBmb3IgZGVsZXRlXG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIF9jYW52YXNUb2ltZyhyZW5kZXJlcjogQmFzaWNSZW5kZXJlcik6IEhUTUxJbWFnZUVsZW1lbnQge1xuICAgIGNvbnN0IGNhbnZhcyA9IDxDYW52YXM+cmVuZGVyZXIuQ2FudmFzO1xuICAgIGNvbnN0IGltZyA9IG5ldyBJbWFnZShjYW52YXMuY2FudmFzRWxlbWVudC53aWR0aCwgY2FudmFzLmNhbnZhc0VsZW1lbnQuaGVpZ2h0KTtcbiAgICBpbWcuc3JjID0gY2FudmFzLmNhbnZhc0VsZW1lbnQudG9EYXRhVVJMKCk7XG4gICAgcmV0dXJuIGltZztcbiAgfVxuXG4gIHByaXZhdGUgX2F0dGFjaFRvUmVuZGVyZXIocmVuZGVyZXI6IEJhc2ljUmVuZGVyZXIsIGRlYnVnOiBEZWJ1Z2dlcik6IHZvaWQge1xuICAgIGRlYnVnLmRlYnVnZ2VyQVBJLnJlbmRlcmVycy5hZGRSZW5kZXJlcihyZW5kZXJlciwgdGhpcyk7XG4gICAgcmVuZGVyZXIuUmVuZGVyUGF0aEV4ZWN1dG9yLm9uKFwicmVuZGVyZWQtc3RhZ2VcIiwgKHYpID0+IHtcbiAgICAgIGlmICh0aGlzLl9idWZmZXJUZXh0dXJlUmVxdWVzdCAmJiB2LmNvbXBsZXRlZENoYWluLnN0YWdlLklEID09PSB0aGlzLl9idWZmZXJUZXh0dXJlUmVxdWVzdC5zdGFnZUlEKSB7XG4gICAgICAgIGlmICh2LmJ1ZmZlclRleHR1cmVzW3RoaXMuX2J1ZmZlclRleHR1cmVSZXF1ZXN0LmJ1ZmZlclRleHR1cmVJRF0gPT0gbnVsbCkge1xuICAgICAgICAgIHRoaXMuX2J1ZmZlclRleHR1cmVSZXF1ZXN0LmRlZmZlcmVkLnJlc29sdmUodGhpcy5fY2FudmFzVG9pbWcodi5vd25lci5yZW5kZXJlcikpO1xuICAgICAgICAgIHRoaXMuX2J1ZmZlclRleHR1cmVSZXF1ZXN0ID0gbnVsbDtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fYnVmZmVyVGV4dHVyZVJlcXVlc3QuZGVmZmVyZWQucmVzb2x2ZSh2LmJ1ZmZlclRleHR1cmVzW3RoaXMuX2J1ZmZlclRleHR1cmVSZXF1ZXN0LmJ1ZmZlclRleHR1cmVJRF0ud3JhcHBlcnNbMF0uZ2VuZXJhdGVIdG1sSW1hZ2UodGhpcy5fYnVmZmVyVGV4dHVyZVJlcXVlc3QuZ2VuZXJhdG9yKSk7XG4gICAgICAgIHRoaXMuX2J1ZmZlclRleHR1cmVSZXF1ZXN0ID0gbnVsbDtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZW5kZXJlci5SZW5kZXJQYXRoRXhlY3V0b3Iub24oXCJyZW5kZXJlZC1wYXRoXCIsICh2KSA9PiB7XG4gICAgICBpZiAodGhpcy5fc2hhZG93TWFwUmVxdWVzdCAmJiB2Lm93bmVyLnJlbmRlcmVyLklEID09PSB0aGlzLl9zaGFkb3dNYXBSZXF1ZXN0LnJlbmRlcmVySUQpIHtcbiAgICAgICAgLy8gdGhpcy5zaGFkb3dNYXBSZXF1ZXN0LmRlZmZlcmVkLnJlc29sdmUodi5zY2VuZS5MaWdodFJlZ2lzdGVyLnNoYWRvd01hcFJlc291cmNlTWFuYWdlci5zaGFkb3dNYXBUaWxlVGV4dHVyZS53cmFwcGVyc1swXS5nZW5lcmF0ZUh0bWxJbWFnZSh0aGlzLnNoYWRvd01hcFJlcXVlc3QuZ2VuZXJhdG9yKSk7XG4gICAgICAgIHRoaXMuX3NoYWRvd01hcFJlcXVlc3QgPSBudWxsO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuX2J1ZmZlclRleHR1cmVQcm9ncmVzc1JlcXVlc3QgJiYgdGhpcy5fYnVmZmVyVGV4dHVyZVByb2dyZXNzUmVxdWVzdC5iZWdpbikge1xuICAgICAgICB0aGlzLl9idWZmZXJUZXh0dXJlUHJvZ3Jlc3NSZXF1ZXN0LmRlZmZlcmVkLnJlc29sdmUobnVsbCk7XG4gICAgICAgIHRoaXMuX2J1ZmZlclRleHR1cmVQcm9ncmVzc1JlcXVlc3QgPSBudWxsO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuX3NoYWRvd01hcFByb2dyZXNzUmVxdWVzdCAmJiB0aGlzLl9zaGFkb3dNYXBQcm9ncmVzc1JlcXVlc3QuYmVnaW4pIHtcbiAgICAgICAgdGhpcy5fc2hhZG93TWFwUHJvZ3Jlc3NSZXF1ZXN0LmRlZmZlcmVkLnJlc29sdmUobnVsbCk7XG4gICAgICAgIHRoaXMuX3NoYWRvd01hcFByb2dyZXNzUmVxdWVzdCA9IG51bGw7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmVuZGVyZXIuUmVuZGVyUGF0aEV4ZWN1dG9yLm9uKFwicmVuZGVyZWQtb2JqZWN0XCIsICh2KSA9PiB7XG4gICAgICBsZXQgaW1nO1xuICAgICAgaWYgKHRoaXMuX2J1ZmZlclRleHR1cmVQcm9ncmVzc1JlcXVlc3QgJiYgdi5zdGFnZS5JRCA9PT0gdGhpcy5fYnVmZmVyVGV4dHVyZVByb2dyZXNzUmVxdWVzdC5zdGFnZUlEKSB7XG4gICAgICAgIHRoaXMuX2J1ZmZlclRleHR1cmVQcm9ncmVzc1JlcXVlc3QuYmVnaW4gPSB0cnVlO1xuICAgICAgICB2Lm93bmVyLnJlbmRlcmVyLkdMLmZsdXNoKCk7XG4gICAgICAgIGlmICh2LmJ1ZmZlclRleHR1cmVzW3RoaXMuX2J1ZmZlclRleHR1cmVQcm9ncmVzc1JlcXVlc3QuYnVmZmVyVGV4dHVyZUlEXSA9PSBudWxsKSB7XG4gICAgICAgICAgLy8gZm9yIGRlZmF1bHQgYnVmZmVyXG4gICAgICAgICAgaW1nID0gdGhpcy5fY2FudmFzVG9pbWcodi5vd25lci5yZW5kZXJlcik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaW1nID0gdi5idWZmZXJUZXh0dXJlc1t0aGlzLl9idWZmZXJUZXh0dXJlUHJvZ3Jlc3NSZXF1ZXN0LmJ1ZmZlclRleHR1cmVJRF0ud3JhcHBlcnNbMF0uZ2VuZXJhdGVIdG1sSW1hZ2UodGhpcy5fYnVmZmVyVGV4dHVyZVByb2dyZXNzUmVxdWVzdC5nZW5lcmF0b3IpO1xuICAgICAgICB9XG4gICAgICAgIGltZy50aXRsZSA9IGBvYmplY3Q6JHt2LnJlbmRlcmVkT2JqZWN0Lm5hbWV9IHRlY2huaXF1ZToke3YudGVjaG5pcXVlfWA7XG4gICAgICAgIHRoaXMuX2J1ZmZlclRleHR1cmVQcm9ncmVzc1JlcXVlc3QuZGVmZmVyZWQubm90aWZ5KFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGltYWdlOiBpbWcsXG4gICAgICAgICAgICBvYmplY3Q6IHYucmVuZGVyZWRPYmplY3QsXG4gICAgICAgICAgICB0ZWNobmlxdWU6IHYudGVjaG5pcXVlXG4gICAgICAgICAgfVxuICAgICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5fc2hhZG93TWFwUHJvZ3Jlc3NSZXF1ZXN0ICYmIHYuc3RhZ2UuZ2V0VHlwZU5hbWUoKSA9PT0gXCJTaGFkb3dNYXBHZW5lcmF0aW9uU3RhZ2VcIiAmJiB2LnN0YWdlLlJlbmRlcmVyLklEID09PSB0aGlzLl9zaGFkb3dNYXBQcm9ncmVzc1JlcXVlc3QucmVuZGVyZXJJRCkge1xuICAgICAgICB0aGlzLl9zaGFkb3dNYXBQcm9ncmVzc1JlcXVlc3QuYmVnaW4gPSB0cnVlO1xuICAgICAgICB2Lm93bmVyLnJlbmRlcmVyLkdMLmZsdXNoKCk7XG4gICAgICAgIGltZyA9IHVuZGVmaW5lZDsgLy8gdi5yZW5kZXJlZE9iamVjdC5QYXJlbnRTY2VuZS5MaWdodFJlZ2lzdGVyLnNoYWRvd01hcFJlc291cmNlTWFuYWdlci5zaGFkb3dNYXBUaWxlVGV4dHVyZS53cmFwcGVyc1swXS5nZW5lcmF0ZUh0bWxJbWFnZSh0aGlzLnNoYWRvd01hcFByb2dyZXNzUmVxdWVzdC5nZW5lcmF0b3IpO1xuICAgICAgICBpbWcudGl0bGUgPSBgb2JqZWN0OiR7di5yZW5kZXJlZE9iamVjdC5uYW1lfSB0ZWNobmlxdWU6JHt2LnRlY2huaXF1ZX1gO1xuICAgICAgICB0aGlzLl9zaGFkb3dNYXBQcm9ncmVzc1JlcXVlc3QuZGVmZmVyZWQubm90aWZ5KFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGltYWdlOiBpbWcsXG4gICAgICAgICAgICBvYmplY3Q6IHYucmVuZGVyZWRPYmplY3QsXG4gICAgICAgICAgICB0ZWNobmlxdWU6IHYudGVjaG5pcXVlXG4gICAgICAgICAgfVxuICAgICAgICAgICk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxufVxuXG5leHBvcnQgZGVmYXVsdCBSZW5kZXJlckRlYnVnZ2VyO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9

import GomlTreeNodeBase from "../../GomlTreeNodeBase";
class BehaviorNode extends GomlTreeNodeBase {
    constructor() {
        super();
        this._cachedOrder = 1000;
        this._cachedEnabled = undefined;
        this._awakenCache = false;
        this._startCalled = false;
        this._updateDelegate = () => { return; };
        this._startDelegate = () => { return; };
        this._awakeDelegate = () => { return; };
        this._onEnabledDelegate = () => { return; };
        this._onDisabledDelegate = () => { return; };
        this.attributes.defineAttribute({
            "name": {
                value: undefined,
                converter: "string",
                onchanged: this._onNameAttrChanged.bind(this),
            },
            "enabled": {
                value: false,
                converter: "boolean",
                onchanged: this._onEnabledAttrChanged.bind(this),
            },
        });
    }
    get BehaviorName() {
        return this._componentName;
    }
    get awaken() {
        return this._awakenCache;
    }
    get order() {
        return this._cachedOrder;
    }
    get enabled() {
        return this._cachedEnabled;
    }
    set enabled(en) {
        this._cachedEnabled = en;
    }
    updateBehavior(target) {
        if (!this._startCalled) {
            this.start(target);
        }
        this._updateDelegate(target);
    }
    start(target) {
        this._startDelegate(target);
        this._startCalled = true;
    }
    awake(target) {
        this._awakeDelegate(target);
        this._awakenCache = true;
    }
    onEnabled(target) {
        this._onEnabledDelegate(target);
    }
    onDisabled(target) {
        this._onDisabledDelegate(target);
    }
    __onMount() {
        this._componentTarget = this.__parent.ComponentTarget;
        this._initializeBehavior();
    }
    _onNameAttrChanged(attr) {
        this._componentName = attr.Value;
        this._initializeBehavior();
    }
    _onEnabledAttrChanged(attr) {
        if (attr.Value === this.enabled && typeof attr.Value === "undefined") {
            this._cachedEnabled = true;
            this.onEnabled(this._componentTarget);
        }
        if (attr.Value === this.enabled) {
            return;
        }
        if (attr.Value) {
            this.onEnabled(this._componentTarget);
        }
        else {
            this.onDisabled(this._componentTarget);
        }
        this.enabled = attr.Value;
    }
    _initializeBehavior() {
        if (this._componentName && this._componentTarget) {
            const component = this.nodeManager.behaviorRegistry.getBehavior(this._componentName);
            if (component) {
                // load d`efault value of component
                if (typeof component.order !== "undefined") {
                    this._cachedOrder = component.order;
                }
                ;
                let componentEnabled;
                if (typeof component.enabled !== "undefined") {
                    componentEnabled = component.enabled;
                }
                else {
                    componentEnabled = true;
                }
                this.attributes.setValue("enabled", componentEnabled);
                if (typeof component.awake === "function") {
                    this._awakeDelegate = component.awake;
                }
                if (typeof component.update === "function") {
                    this._updateDelegate = component.update;
                }
                if (typeof component.start === "function") {
                    this._startDelegate = component.start;
                }
                if (typeof component.onEnabled === "function") {
                    this._onEnabledDelegate = component.onEnabled;
                }
                if (typeof component.onDisabled === "function") {
                    this._onDisabledDelegate = component.onDisabled;
                }
                // initialize component attributes
                for (let attrKey in component.attributes) {
                    const attr = component.attributes[attrKey];
                    if (BehaviorNode._ignoreNode.indexOf(attrKey) !== -1 || this.attributes.isDefined(attrKey)) {
                        console.error(`attribute name '${attrKey}' is protected attribute name. please change name`);
                        continue;
                    }
                    // create handler
                    this._defineAccessor(attrKey);
                    const attributeContainer = {};
                    attributeContainer[attrKey] = attr;
                    this.attributes.defineAttribute(attributeContainer);
                }
                this._componentTarget.addBehavior(this);
            }
            else {
                console.warn(`component"${this._componentName}" is not found.`);
            }
        }
        else {
            console.warn("component name was not specified");
        }
    }
    // private defineDefaultAccessor(attr: Attr) {
    //   Object.defineProperty(this, attr.name, {
    //     get:
    //     () => {
    //       return attr.value;
    //     },
    //     set: (v) => {
    //       attr.value = v;
    //     }
    //   });
    // }
    _defineAccessor(attrKey) {
        Object.defineProperty(this, attrKey, {
            get: () => {
                return this.attributes.getValue(attrKey);
            },
            set: (v) => {
                this.attributes.setValue(attrKey, v);
            }
        });
    }
}
BehaviorNode._ignoreNode = ["name", "cachedOrder", "cachedEnabled", "children", "parent", "element"];
export default BehaviorNode;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkdvbWwvTm9kZXMvQmVoYXZpb3JzL0JlaGF2aW9yTm9kZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiT0FBTyxnQkFBZ0IsTUFBTSx3QkFBd0I7QUFNckQsMkJBQTJCLGdCQUFnQjtJQWV6QztRQUNFLE9BQU8sQ0FBQztRQU5GLGlCQUFZLEdBQVcsSUFBSSxDQUFDO1FBQzVCLG1CQUFjLEdBQVksU0FBUyxDQUFDO1FBQ3BDLGlCQUFZLEdBQVksS0FBSyxDQUFDO1FBQzlCLGlCQUFZLEdBQVksS0FBSyxDQUFDO1FBc0s5QixvQkFBZSxHQUE4QixRQUFRLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMvRCxtQkFBYyxHQUE4QixRQUFRLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM5RCxtQkFBYyxHQUE4QixRQUFRLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM5RCx1QkFBa0IsR0FBOEIsUUFBUSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEUsd0JBQW1CLEdBQThCLFFBQVEsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBdEt6RSxJQUFJLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQztZQUM5QixNQUFNLEVBQUU7Z0JBQ04sS0FBSyxFQUFFLFNBQVM7Z0JBQ2hCLFNBQVMsRUFBRSxRQUFRO2dCQUNuQixTQUFTLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7YUFDOUM7WUFDRCxTQUFTLEVBQUU7Z0JBQ1QsS0FBSyxFQUFFLEtBQUs7Z0JBQ1osU0FBUyxFQUFFLFNBQVM7Z0JBQ3BCLFNBQVMsRUFBRSxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQzthQUNqRDtTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxJQUFXLFlBQVk7UUFDckIsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUM7SUFDN0IsQ0FBQztJQUVELElBQVcsTUFBTTtRQUNmLE1BQU0sQ0FB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QUFJLENBQUMsa0NBQWtDLENBQUMsQ0FBQztRQUNuRCxDQUFDO0lBQ0gsQ0FBQztJQUVELDhDQUE4QztJQUM5Qyw2Q0FBNkM7SUFDN0MsV0FBVztJQUNYLGNBQWM7SUFDZCwyQkFBMkI7SUFDM0IsU0FBUztJQUNULG9CQUFvQjtJQUNwQix3QkFBd0I7SUFDeEIsUUFBUTtJQUNSLFFBQVE7SUFDUixJQUFJO0lBRUksZUFBZSxDQUFDLE9BQWU7UUFDckMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFO1lBQ25DLEdBQUcsRUFDSDtnQkFDRSxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDM0MsQ0FBQztZQUNELEdBQUcsRUFBRSxDQUFDLENBQUM7Z0JBQ0wsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ3ZDLENBQUM7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDO0FBT0gsQ0FBQztBQXZMZ0Isd0JBQVcsR0FBYSxDQUFDLE1BQU0sRUFBRSxhQUFhLEVBQUUsZUFBZSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsU0FBUyxDQUFDLENBdUxqSDtBQUVELGVBQWUsWUFBWSxDQUFDIiwiZmlsZSI6IkdvbWwvTm9kZXMvQmVoYXZpb3JzL0JlaGF2aW9yTm9kZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBHb21sVHJlZU5vZGVCYXNlIGZyb20gXCIuLi8uLi9Hb21sVHJlZU5vZGVCYXNlXCI7XG5pbXBvcnQge0FjdGlvbjF9IGZyb20gXCIuLi8uLi8uLi9CYXNlL0RlbGVnYXRlc1wiO1xuaW1wb3J0IEdvbWxBdHRyaWJ1dGUgZnJvbSBcIi4uLy4uL0dvbWxBdHRyaWJ1dGVcIjtcbmltcG9ydCBBdHRyaWJ1dGVEZWNsYXJhdGlvbiBmcm9tIFwiLi4vLi4vQXR0cmlidXRlRGVjbGFyYXRpb25cIjtcbmltcG9ydCBCZWhhdmlvcnNOb2RlIGZyb20gXCIuL0JlaGF2aW9yc05vZGVcIjtcblxuY2xhc3MgQmVoYXZpb3JOb2RlIGV4dGVuZHMgR29tbFRyZWVOb2RlQmFzZSB7XG4gIHByaXZhdGUgc3RhdGljIF9pZ25vcmVOb2RlOiBzdHJpbmdbXSA9IFtcIm5hbWVcIiwgXCJjYWNoZWRPcmRlclwiLCBcImNhY2hlZEVuYWJsZWRcIiwgXCJjaGlsZHJlblwiLCBcInBhcmVudFwiLCBcImVsZW1lbnRcIl07XG5cbiAgLyoqXG4gICAqIFRoZSBub2RlIGNvbnRhaW5zIHRoaXMgbW9kdWxlLlxuICAgKi9cbiAgcHJpdmF0ZSBfY29tcG9uZW50VGFyZ2V0OiBHb21sVHJlZU5vZGVCYXNlO1xuXG4gIHByaXZhdGUgX2NvbXBvbmVudE5hbWU6IHN0cmluZztcblxuICBwcml2YXRlIF9jYWNoZWRPcmRlcjogbnVtYmVyID0gMTAwMDtcbiAgcHJpdmF0ZSBfY2FjaGVkRW5hYmxlZDogYm9vbGVhbiA9IHVuZGVmaW5lZDtcbiAgcHJpdmF0ZSBfYXdha2VuQ2FjaGU6IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBfc3RhcnRDYWxsZWQ6IGJvb2xlYW4gPSBmYWxzZTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuYXR0cmlidXRlcy5kZWZpbmVBdHRyaWJ1dGUoe1xuICAgICAgXCJuYW1lXCI6IHtcbiAgICAgICAgdmFsdWU6IHVuZGVmaW5lZCxcbiAgICAgICAgY29udmVydGVyOiBcInN0cmluZ1wiLFxuICAgICAgICBvbmNoYW5nZWQ6IHRoaXMuX29uTmFtZUF0dHJDaGFuZ2VkLmJpbmQodGhpcyksXG4gICAgICB9LFxuICAgICAgXCJlbmFibGVkXCI6IHtcbiAgICAgICAgdmFsdWU6IGZhbHNlLFxuICAgICAgICBjb252ZXJ0ZXI6IFwiYm9vbGVhblwiLFxuICAgICAgICBvbmNoYW5nZWQ6IHRoaXMuX29uRW5hYmxlZEF0dHJDaGFuZ2VkLmJpbmQodGhpcyksXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGdldCBCZWhhdmlvck5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5fY29tcG9uZW50TmFtZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgYXdha2VuKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLl9hd2FrZW5DYWNoZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgb3JkZXIoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5fY2FjaGVkT3JkZXI7XG4gIH1cblxuICBwdWJsaWMgZ2V0IGVuYWJsZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuX2NhY2hlZEVuYWJsZWQ7XG4gIH1cblxuICBwdWJsaWMgc2V0IGVuYWJsZWQoZW46IGJvb2xlYW4pIHtcbiAgICB0aGlzLl9jYWNoZWRFbmFibGVkID0gZW47XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlQmVoYXZpb3IodGFyZ2V0OiBHb21sVHJlZU5vZGVCYXNlKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLl9zdGFydENhbGxlZCkge1xuICAgICAgdGhpcy5zdGFydCh0YXJnZXQpO1xuICAgIH1cbiAgICB0aGlzLl91cGRhdGVEZWxlZ2F0ZSh0YXJnZXQpO1xuICB9XG5cbiAgcHVibGljIHN0YXJ0KHRhcmdldDogR29tbFRyZWVOb2RlQmFzZSk6IHZvaWQge1xuICAgIHRoaXMuX3N0YXJ0RGVsZWdhdGUodGFyZ2V0KTtcbiAgICB0aGlzLl9zdGFydENhbGxlZCA9IHRydWU7XG4gIH1cblxuICBwdWJsaWMgYXdha2UodGFyZ2V0OiBHb21sVHJlZU5vZGVCYXNlKTogdm9pZCB7XG4gICAgdGhpcy5fYXdha2VEZWxlZ2F0ZSh0YXJnZXQpO1xuICAgIHRoaXMuX2F3YWtlbkNhY2hlID0gdHJ1ZTtcbiAgfVxuXG5cbiAgcHVibGljIG9uRW5hYmxlZCh0YXJnZXQ6IEdvbWxUcmVlTm9kZUJhc2UpOiB2b2lkIHtcbiAgICB0aGlzLl9vbkVuYWJsZWREZWxlZ2F0ZSh0YXJnZXQpO1xuICB9XG5cbiAgcHVibGljIG9uRGlzYWJsZWQodGFyZ2V0OiBHb21sVHJlZU5vZGVCYXNlKTogdm9pZCB7XG4gICAgdGhpcy5fb25EaXNhYmxlZERlbGVnYXRlKHRhcmdldCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgX19vbk1vdW50KCk6IHZvaWQge1xuICAgIHRoaXMuX2NvbXBvbmVudFRhcmdldCA9ICg8QmVoYXZpb3JzTm9kZT50aGlzLl9fcGFyZW50KS5Db21wb25lbnRUYXJnZXQ7XG4gICAgdGhpcy5faW5pdGlhbGl6ZUJlaGF2aW9yKCk7XG4gIH1cblxuICBwcml2YXRlIF9vbk5hbWVBdHRyQ2hhbmdlZChhdHRyOiBHb21sQXR0cmlidXRlKTogdm9pZCB7XG4gICAgdGhpcy5fY29tcG9uZW50TmFtZSA9IGF0dHIuVmFsdWU7XG4gICAgdGhpcy5faW5pdGlhbGl6ZUJlaGF2aW9yKCk7XG4gIH1cblxuICBwcml2YXRlIF9vbkVuYWJsZWRBdHRyQ2hhbmdlZChhdHRyOiBHb21sQXR0cmlidXRlKTogdm9pZCB7XG4gICAgaWYgKGF0dHIuVmFsdWUgPT09IHRoaXMuZW5hYmxlZCAmJiB0eXBlb2YgYXR0ci5WYWx1ZSA9PT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgdGhpcy5fY2FjaGVkRW5hYmxlZCA9IHRydWU7XG4gICAgICB0aGlzLm9uRW5hYmxlZCh0aGlzLl9jb21wb25lbnRUYXJnZXQpO1xuICAgIH1cbiAgICBpZiAoYXR0ci5WYWx1ZSA9PT0gdGhpcy5lbmFibGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChhdHRyLlZhbHVlKSB7XG4gICAgICB0aGlzLm9uRW5hYmxlZCh0aGlzLl9jb21wb25lbnRUYXJnZXQpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLm9uRGlzYWJsZWQodGhpcy5fY29tcG9uZW50VGFyZ2V0KTtcbiAgICB9XG4gICAgdGhpcy5lbmFibGVkID0gYXR0ci5WYWx1ZTtcbiAgfVxuXG4gIHByaXZhdGUgX2luaXRpYWxpemVCZWhhdmlvcigpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5fY29tcG9uZW50TmFtZSAmJiB0aGlzLl9jb21wb25lbnRUYXJnZXQpIHtcbiAgICAgIGNvbnN0IGNvbXBvbmVudCA9IHRoaXMubm9kZU1hbmFnZXIuYmVoYXZpb3JSZWdpc3RyeS5nZXRCZWhhdmlvcih0aGlzLl9jb21wb25lbnROYW1lKTtcbiAgICAgIGlmIChjb21wb25lbnQpIHtcbiAgICAgICAgLy8gbG9hZCBkYGVmYXVsdCB2YWx1ZSBvZiBjb21wb25lbnRcbiAgICAgICAgaWYgKHR5cGVvZiBjb21wb25lbnQub3JkZXIgIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgICAgICB0aGlzLl9jYWNoZWRPcmRlciA9IGNvbXBvbmVudC5vcmRlcjtcbiAgICAgICAgfTtcbiAgICAgICAgbGV0IGNvbXBvbmVudEVuYWJsZWQ7XG4gICAgICAgIGlmICh0eXBlb2YgY29tcG9uZW50LmVuYWJsZWQgIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgICAgICBjb21wb25lbnRFbmFibGVkID0gY29tcG9uZW50LmVuYWJsZWQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29tcG9uZW50RW5hYmxlZCA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzLnNldFZhbHVlKFwiZW5hYmxlZFwiLCBjb21wb25lbnRFbmFibGVkKTtcbiAgICAgICAgaWYgKHR5cGVvZiBjb21wb25lbnQuYXdha2UgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgIHRoaXMuX2F3YWtlRGVsZWdhdGUgPSBjb21wb25lbnQuYXdha2U7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGVvZiBjb21wb25lbnQudXBkYXRlID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgICB0aGlzLl91cGRhdGVEZWxlZ2F0ZSA9IGNvbXBvbmVudC51cGRhdGU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGVvZiBjb21wb25lbnQuc3RhcnQgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgIHRoaXMuX3N0YXJ0RGVsZWdhdGUgPSBjb21wb25lbnQuc3RhcnQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGVvZiBjb21wb25lbnQub25FbmFibGVkID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgICB0aGlzLl9vbkVuYWJsZWREZWxlZ2F0ZSA9IGNvbXBvbmVudC5vbkVuYWJsZWQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGVvZiBjb21wb25lbnQub25EaXNhYmxlZCA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgdGhpcy5fb25EaXNhYmxlZERlbGVnYXRlID0gY29tcG9uZW50Lm9uRGlzYWJsZWQ7XG4gICAgICAgIH1cbiAgICAgICAgLy8gaW5pdGlhbGl6ZSBjb21wb25lbnQgYXR0cmlidXRlc1xuICAgICAgICBmb3IgKGxldCBhdHRyS2V5IGluIGNvbXBvbmVudC5hdHRyaWJ1dGVzKSB7XG4gICAgICAgICAgY29uc3QgYXR0ciA9IGNvbXBvbmVudC5hdHRyaWJ1dGVzW2F0dHJLZXldO1xuICAgICAgICAgIGlmIChCZWhhdmlvck5vZGUuX2lnbm9yZU5vZGUuaW5kZXhPZihhdHRyS2V5KSAhPT0gLTEgfHwgdGhpcy5hdHRyaWJ1dGVzLmlzRGVmaW5lZChhdHRyS2V5KSkgey8vIGR1cGxpY2F0ZWQgb3IgcHJvdGVjdGVkIGF0dHJpYnV0ZVxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihgYXR0cmlidXRlIG5hbWUgJyR7YXR0cktleX0nIGlzIHByb3RlY3RlZCBhdHRyaWJ1dGUgbmFtZS4gcGxlYXNlIGNoYW5nZSBuYW1lYCk7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgLy8gY3JlYXRlIGhhbmRsZXJcbiAgICAgICAgICB0aGlzLl9kZWZpbmVBY2Nlc3NvcihhdHRyS2V5KTtcbiAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVDb250YWluZXI6IEF0dHJpYnV0ZURlY2xhcmF0aW9uID0ge307XG4gICAgICAgICAgYXR0cmlidXRlQ29udGFpbmVyW2F0dHJLZXldID0gYXR0cjtcbiAgICAgICAgICB0aGlzLmF0dHJpYnV0ZXMuZGVmaW5lQXR0cmlidXRlKGF0dHJpYnV0ZUNvbnRhaW5lcik7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fY29tcG9uZW50VGFyZ2V0LmFkZEJlaGF2aW9yKHRoaXMpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS53YXJuKGBjb21wb25lbnRcIiR7dGhpcy5fY29tcG9uZW50TmFtZX1cIiBpcyBub3QgZm91bmQuYCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUud2FybihcImNvbXBvbmVudCBuYW1lIHdhcyBub3Qgc3BlY2lmaWVkXCIpO1xuICAgIH1cbiAgfVxuXG4gIC8vIHByaXZhdGUgZGVmaW5lRGVmYXVsdEFjY2Vzc29yKGF0dHI6IEF0dHIpIHtcbiAgLy8gICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgYXR0ci5uYW1lLCB7XG4gIC8vICAgICBnZXQ6XG4gIC8vICAgICAoKSA9PiB7XG4gIC8vICAgICAgIHJldHVybiBhdHRyLnZhbHVlO1xuICAvLyAgICAgfSxcbiAgLy8gICAgIHNldDogKHYpID0+IHtcbiAgLy8gICAgICAgYXR0ci52YWx1ZSA9IHY7XG4gIC8vICAgICB9XG4gIC8vICAgfSk7XG4gIC8vIH1cblxuICBwcml2YXRlIF9kZWZpbmVBY2Nlc3NvcihhdHRyS2V5OiBzdHJpbmcpOiBhbnkge1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBhdHRyS2V5LCB7XG4gICAgICBnZXQ6XG4gICAgICAoKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmF0dHJpYnV0ZXMuZ2V0VmFsdWUoYXR0cktleSk7XG4gICAgICB9LFxuICAgICAgc2V0OiAodikgPT4ge1xuICAgICAgICB0aGlzLmF0dHJpYnV0ZXMuc2V0VmFsdWUoYXR0cktleSwgdik7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIF91cGRhdGVEZWxlZ2F0ZTogQWN0aW9uMTxHb21sVHJlZU5vZGVCYXNlPiA9ICgpID0+IHsgcmV0dXJuOyB9O1xuICBwcml2YXRlIF9zdGFydERlbGVnYXRlOiBBY3Rpb24xPEdvbWxUcmVlTm9kZUJhc2U+ID0gKCkgPT4geyByZXR1cm47IH07XG4gIHByaXZhdGUgX2F3YWtlRGVsZWdhdGU6IEFjdGlvbjE8R29tbFRyZWVOb2RlQmFzZT4gPSAoKSA9PiB7IHJldHVybjsgfTtcbiAgcHJpdmF0ZSBfb25FbmFibGVkRGVsZWdhdGU6IEFjdGlvbjE8R29tbFRyZWVOb2RlQmFzZT4gPSAoKSA9PiB7IHJldHVybjsgfTtcbiAgcHJpdmF0ZSBfb25EaXNhYmxlZERlbGVnYXRlOiBBY3Rpb24xPEdvbWxUcmVlTm9kZUJhc2U+ID0gKCkgPT4geyByZXR1cm47IH07XG59XG5cbmV4cG9ydCBkZWZhdWx0IEJlaGF2aW9yTm9kZTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==

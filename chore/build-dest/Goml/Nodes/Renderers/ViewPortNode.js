import CoreRelatedNodeBase from "../../CoreRelatedNodeBase";
import Rectangle from "../../../Math/Rectangle";
import RendererFactory from "../../../Core/Renderers/RendererFactory";
class ViewPortNode extends CoreRelatedNodeBase {
    constructor() {
        super();
        this.attributes.defineAttribute({
            "cam": {
                value: undefined,
                converter: "string",
                onchanged: this._onCamAttrChanged.bind(this),
            },
            "width": {
                value: 640,
                converter: "float",
                onchanged: (attr) => {
                    this._width = attr.Value;
                    this._updateViewportArea();
                    attr.done();
                },
            },
            "height": {
                value: 480,
                converter: "float",
                onchanged: (attr) => {
                    this._height = attr.Value;
                    this._updateViewportArea();
                    attr.done();
                },
            },
            "left": {
                value: 0,
                converter: "float",
                onchanged: (attr) => {
                    this._left = attr.Value;
                    this._updateViewportArea();
                    attr.done();
                },
            },
            "top": {
                value: 0,
                converter: "float",
                onchanged: (attr) => {
                    this._top = attr.Value;
                    this._updateViewportArea();
                    attr.done();
                },
            },
            "backgroundType": {
                value: "color",
                converter: "string",
                onchanged: (attr) => {
                    if (attr.Value !== "skybox" && this._skyBoxStageChain) {
                        // this.targetRenderer.renderPath.deleteStage(this.skyBoxStageChain); TODO fix this
                        this._skyBoxStageChain = null;
                    }
                    attr.done();
                },
            },
            "skybox": {
                value: null,
                converter: "string",
                onchanged: this._onSkyboxAttrChanged.bind(this),
            },
            "config": {
                converter: "string",
                value: "default",
                onchanged: this._onConfigAttrChanged.bind(this),
            },
            "name": {
                converter: "string",
                value: undefined,
                onchanged: (attr) => {
                    this.target.name = attr.Value;
                    attr.done();
                }
            },
        });
    }
    __onMount() {
        super.__onMount();
    }
    _onConfigAttrChanged(attr) {
        if (this.__parent.getTypeName() !== "CanvasNode") {
            throw Error("viewport must be the direct child of canvas");
        }
        this._parentCanvas = this.__parent;
        const defaultRect = this._parentCanvas.target.region;
        this.target = RendererFactory.generateRenderer(this._parentCanvas.target, defaultRect, attr.Value);
        attr.done();
    }
    _onCamAttrChanged(attr) {
        this._resolveCamera(attr.Value, attr.done.bind(attr));
    }
    _onSkyboxAttrChanged(attr) {
        if (this.attributes.getValue("backgroundType") === "skybox") {
            this.nodeImport("jthree.resource.TextureCube", attr.Value, (node) => {
                if (node) {
                    if (!this._skyBoxStageChain) {
                        this._skyBoxStageChain = {
                            buffers: {
                                OUT: "main"
                            },
                            stage: "jthree.basic.skybox",
                            variables: {}
                        };
                        this.target.renderPath.insertWithIndex(0, this._skyBoxStageChain);
                    }
                    this._skyBoxStageChain.variables["skybox"] = node.target;
                    attr.done();
                }
                else {
                    attr.done();
                }
            });
        }
        else {
            attr.done();
        }
    }
    _updateViewportArea() {
        // console.log("updateViewportArea");
        if (this._parentCanvas) {
            if (this._parentCanvas.canvasFrames.container) {
                // when canvas HTMLElement is applied
                const frame = this._parentCanvas.canvasFrames.container;
                const W = frame.clientWidth;
                const H = frame.clientHeight;
                const left = this._left > 1 ? this._left : W * this._left;
                const top = this._top > 1 ? this._top : H * this._top;
                const width = this._width > 1 ? this._width : W * this._width;
                const height = this._height > 1 ? this._height : H * this._height;
                this.target.region = new Rectangle(left, top, width, height);
            }
            else {
                // when canvas HTMLElement is not applied
                this.target.region = new Rectangle(this._left, this._top, this._width, this._height);
            }
            if (this.target.Camera.getTypeName() === "PerspectiveCamera") {
                this.target.Camera.Aspect = this._width / this._height;
            }
        }
    }
    _resolveCamera(cam, done) {
        this.nodeImport("jthree.scene.camera", cam, (cameraNode) => {
            //
            // remove camera here
            //
            if (cameraNode) {
                if (cameraNode.ContainedSceneNode != null) {
                    this.target.Camera = cameraNode.target;
                    const scene = cameraNode.ContainedSceneNode.target;
                    scene.addRenderer(this.target);
                    this._updateViewportArea();
                }
                else {
                    console.error("cant retrieve scene!");
                }
            }
            done();
        });
    }
}
export default ViewPortNode;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkdvbWwvTm9kZXMvUmVuZGVyZXJzL1ZpZXdQb3J0Tm9kZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiT0FDTyxtQkFBbUIsTUFBTSwyQkFBMkI7T0FHcEQsU0FBUyxNQUFNLHlCQUF5QjtPQU14QyxlQUFlLE1BQU0seUNBQXlDO0FBR3JFLDJCQUEyQixtQkFBbUI7SUFXNUM7UUFDRSxPQUFPLENBQUM7UUFDUixJQUFJLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQztZQUM5QixLQUFLLEVBQUU7Z0JBQ0wsS0FBSyxFQUFFLFNBQVM7Z0JBQ2hCLFNBQVMsRUFBRSxRQUFRO2dCQUNuQixTQUFTLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7YUFDN0M7WUFDRCxPQUFPLEVBQUU7Z0JBQ1AsS0FBSyxFQUFFLEdBQUc7Z0JBQ1YsU0FBUyxFQUFFLE9BQU87Z0JBQ2xCLFNBQVMsRUFBRSxDQUFDLElBQUk7b0JBQ2QsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO29CQUN6QixJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztvQkFDM0IsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUNkLENBQUM7YUFDRjtZQUNELFFBQVEsRUFBRTtnQkFDUixLQUFLLEVBQUUsR0FBRztnQkFDVixTQUFTLEVBQUUsT0FBTztnQkFDbEIsU0FBUyxFQUFFLENBQUMsSUFBSTtvQkFDZCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7b0JBQzFCLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO29CQUMzQixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ2QsQ0FBQzthQUNGO1lBQ0QsTUFBTSxFQUFFO2dCQUNOLEtBQUssRUFBRSxDQUFDO2dCQUNSLFNBQVMsRUFBRSxPQUFPO2dCQUNsQixTQUFTLEVBQUUsQ0FBQyxJQUFJO29CQUNkLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFD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RSxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7SUFFTyxjQUFjLENBQUMsR0FBVyxFQUFFLElBQWdCO1FBQ2xELElBQUksQ0FBQyxVQUFVLENBQUMscUJBQXFCLEVBQUUsR0FBRyxFQUFFLENBQUMsVUFBa0M7WUFDN0UsRUFBRTtZQUNGLHFCQUFxQjtZQUNyQixFQUFFO1lBQ0YsRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztnQkFDZixFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsa0JBQWtCLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztvQkFDMUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQztvQkFDdkMsTUFBTSxLQUFLLEdBQVUsVUFBVSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQztvQkFDMUQsS0FBSyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7b0JBQy9CLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO2dCQUM3QixDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNOLE9BQU8sQ0FBQyxLQUFLLENBQUMsc0JBQXNCLENBQUMsQ0FBQztnQkFDeEMsQ0FBQztZQUNILENBQUM7WUFDRCxJQUFJLEVBQUUsQ0FBQztRQUNULENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztBQUNILENBQUM7QUFFRCxlQUFlLFlBQVksQ0FBQyIsImZpbGUiOiJHb21sL05vZGVzL1JlbmRlcmVycy9WaWV3UG9ydE5vZGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQ2FtZXJhIGZyb20gXCIuLi8uLi8uLi9Db3JlL1NjZW5lT2JqZWN0cy9DYW1lcmEvQ2FtZXJhXCI7XG5pbXBvcnQgQ29yZVJlbGF0ZWROb2RlQmFzZSBmcm9tIFwiLi4vLi4vQ29yZVJlbGF0ZWROb2RlQmFzZVwiO1xuaW1wb3J0IFN0YWdlQ2hhaW5UZW1wbGF0ZSBmcm9tIFwiLi4vLi4vLi4vQ29yZS9SZW5kZXJlcnMvU3RhZ2VDaGFpblRlbXBsYXRlXCI7XG5pbXBvcnQgQmFzaWNSZW5kZXJlciBmcm9tIFwiLi4vLi4vLi4vQ29yZS9SZW5kZXJlcnMvQmFzaWNSZW5kZXJlclwiO1xuaW1wb3J0IFJlY3RhbmdsZSBmcm9tIFwiLi4vLi4vLi4vTWF0aC9SZWN0YW5nbGVcIjtcbmltcG9ydCBTY2VuZSBmcm9tIFwiLi4vLi4vLi4vQ29yZS9TY2VuZVwiO1xuaW1wb3J0IENhbWVyYU5vZGVCYXNlIGZyb20gXCIuLi9TY2VuZU9iamVjdHMvQ2FtZXJhcy9DYW1lcmFOb2RlQmFzZVwiO1xuaW1wb3J0IENhbnZhc05vZGUgZnJvbSBcIi4uL0NhbnZhc2VzL0NhbnZhc05vZGVcIjtcbmltcG9ydCBQZXJzcGVjdGl2ZUNhbWVyYSBmcm9tIFwiLi4vLi4vLi4vQ29yZS9TY2VuZU9iamVjdHMvQ2FtZXJhL1BlcnNwZWN0aXZlQ2FtZXJhXCI7XG5pbXBvcnQgQ3ViZVRleHR1cmVOb2RlIGZyb20gXCIuLi9UZXh0dXJlL0N1YmVUZXh0dXJlTm9kZVwiO1xuaW1wb3J0IFJlbmRlcmVyRmFjdG9yeSBmcm9tIFwiLi4vLi4vLi4vQ29yZS9SZW5kZXJlcnMvUmVuZGVyZXJGYWN0b3J5XCI7XG5pbXBvcnQgR29tbEF0dHJpYnV0ZSBmcm9tIFwiLi4vLi4vR29tbEF0dHJpYnV0ZVwiO1xuXG5jbGFzcyBWaWV3UG9ydE5vZGUgZXh0ZW5kcyBDb3JlUmVsYXRlZE5vZGVCYXNlPEJhc2ljUmVuZGVyZXI+IHtcbiAgcHJpdmF0ZSBfbGVmdDogbnVtYmVyO1xuICBwcml2YXRlIF90b3A6IG51bWJlcjtcbiAgcHJpdmF0ZSBfd2lkdGg6IG51bWJlcjtcbiAgcHJpdmF0ZSBfaGVpZ2h0OiBudW1iZXI7XG5cbiAgcHJpdmF0ZSBfc2t5Qm94U3RhZ2VDaGFpbjogU3RhZ2VDaGFpblRlbXBsYXRlO1xuXG4gIHByaXZhdGUgX3BhcmVudENhbnZhczogQ2FudmFzTm9kZTtcblxuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5hdHRyaWJ1dGVzLmRlZmluZUF0dHJpYnV0ZSh7XG4gICAgICBcImNhbVwiOiB7XG4gICAgICAgIHZhbHVlOiB1bmRlZmluZWQsXG4gICAgICAgIGNvbnZlcnRlcjogXCJzdHJpbmdcIixcbiAgICAgICAgb25jaGFuZ2VkOiB0aGlzLl9vbkNhbUF0dHJDaGFuZ2VkLmJpbmQodGhpcyksXG4gICAgICB9LFxuICAgICAgXCJ3aWR0aFwiOiB7XG4gICAgICAgIHZhbHVlOiA2NDAsXG4gICAgICAgIGNvbnZlcnRlcjogXCJmbG9hdFwiLFxuICAgICAgICBvbmNoYW5nZWQ6IChhdHRyKSA9PiB7XG4gICAgICAgICAgdGhpcy5fd2lkdGggPSBhdHRyLlZhbHVlO1xuICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpZXdwb3J0QXJlYSgpO1xuICAgICAgICAgIGF0dHIuZG9uZSgpO1xuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIFwiaGVpZ2h0XCI6IHtcbiAgICAgICAgdmFsdWU6IDQ4MCxcbiAgICAgICAgY29udmVydGVyOiBcImZsb2F0XCIsXG4gICAgICAgIG9uY2hhbmdlZDogKGF0dHIpID0+IHtcbiAgICAgICAgICB0aGlzLl9oZWlnaHQgPSBhdHRyLlZhbHVlO1xuICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpZXdwb3J0QXJlYSgpO1xuICAgICAgICAgIGF0dHIuZG9uZSgpO1xuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIFwibGVmdFwiOiB7XG4gICAgICAgIHZhbHVlOiAwLFxuICAgICAgICBjb252ZXJ0ZXI6IFwiZmxvYXRcIixcbiAgICAgICAgb25jaGFuZ2VkOiAoYXR0cikgPT4ge1xuICAgICAgICAgIHRoaXMuX2xlZnQgPSBhdHRyLlZhbHVlO1xuICAgICAgICAgIHRoaXMuX3VwZGF0ZVZpZXdwb3J0QXJlYSgpO1xuICAgICAgICAgIGF0dHIuZG9uZSgpO1xuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIFwidG9wXCI6IHtcbiAgICAgICAgdmFsdWU6IDAsXG4gICAgICAgIGNvbnZlcnRlcjogXCJmbG9hdFwiLFxuICAgICAgICBvbmNoYW5nZWQ6IChhdHRyKSA9PiB7XG4gICAgICAgICAgdGhpcy5fdG9wID0gYXR0ci5WYWx1ZTtcbiAgICAgICAgICB0aGlzLl91cGRhdGVWaWV3cG9ydEFyZWEoKTtcbiAgICAgICAgICBhdHRyLmRvbmUoKTtcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBcImJhY2tncm91bmRUeXBlXCI6IHtcbiAgICAgICAgdmFsdWU6IFwiY29sb3JcIixcbiAgICAgICAgY29udmVydGVyOiBcInN0cmluZ1wiLFxuICAgICAgICBvbmNoYW5nZWQ6IChhdHRyKSA9PiB7XG4gICAgICAgICAgaWYgKGF0dHIuVmFsdWUgIT09IFwic2t5Ym94XCIgJiYgdGhpcy5fc2t5Qm94U3RhZ2VDaGFpbikge1xuICAgICAgICAgICAgLy8gdGhpcy50YXJnZXRSZW5kZXJlci5yZW5kZXJQYXRoLmRlbGV0ZVN0YWdlKHRoaXMuc2t5Qm94U3RhZ2VDaGFpbik7IFRPRE8gZml4IHRoaXNcbiAgICAgICAgICAgIHRoaXMuX3NreUJveFN0YWdlQ2hhaW4gPSBudWxsO1xuICAgICAgICAgIH1cbiAgICAgICAgICBhdHRyLmRvbmUoKTtcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBcInNreWJveFwiOiB7XG4gICAgICAgIHZhbHVlOiBudWxsLFxuICAgICAgICBjb252ZXJ0ZXI6IFwic3RyaW5nXCIsXG4gICAgICAgIG9uY2hhbmdlZDogdGhpcy5fb25Ta3lib3hBdHRyQ2hhbmdlZC5iaW5kKHRoaXMpLFxuICAgICAgfSxcbiAgICAgIFwiY29uZmlnXCI6IHtcbiAgICAgICAgY29udmVydGVyOiBcInN0cmluZ1wiLFxuICAgICAgICB2YWx1ZTogXCJkZWZhdWx0XCIsXG4gICAgICAgIG9uY2hhbmdlZDogdGhpcy5fb25Db25maWdBdHRyQ2hhbmdlZC5iaW5kKHRoaXMpLFxuICAgICAgfSxcbiAgICAgIFwibmFtZVwiOiB7XG4gICAgICAgIGNvbnZlcnRlcjogXCJzdHJpbmdcIixcbiAgICAgICAgdmFsdWU6IHVuZGVmaW5lZCxcbiAgICAgICAgb25jaGFuZ2VkOiAoYXR0cikgPT4ge1xuICAgICAgICAgIHRoaXMudGFyZ2V0Lm5hbWUgPSBhdHRyLlZhbHVlO1xuICAgICAgICAgIGF0dHIuZG9uZSgpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9fb25Nb3VudCgpOiB2b2lkIHtcbiAgICBzdXBlci5fX29uTW91bnQoKTtcbiAgfVxuXG4gIHByaXZhdGUgX29uQ29uZmlnQXR0ckNoYW5nZWQoYXR0cjogR29tbEF0dHJpYnV0ZSk6IHZvaWQge1xuICAgIGlmICh0aGlzLl9fcGFyZW50LmdldFR5cGVOYW1lKCkgIT09IFwiQ2FudmFzTm9kZVwiKSB7XG4gICAgICB0aHJvdyBFcnJvcihcInZpZXdwb3J0IG11c3QgYmUgdGhlIGRpcmVjdCBjaGlsZCBvZiBjYW52YXNcIik7XG4gICAgfVxuICAgIHRoaXMuX3BhcmVudENhbnZhcyA9IDxDYW52YXNOb2RlPnRoaXMuX19wYXJlbnQ7XG4gICAgY29uc3QgZGVmYXVsdFJlY3QgPSB0aGlzLl9wYXJlbnRDYW52YXMudGFyZ2V0LnJlZ2lvbjtcbiAgICB0aGlzLnRhcmdldCA9IFJlbmRlcmVyRmFjdG9yeS5nZW5lcmF0ZVJlbmRlcmVyKHRoaXMuX3BhcmVudENhbnZhcy50YXJnZXQsIGRlZmF1bHRSZWN0LCBhdHRyLlZhbHVlKTtcbiAgICBhdHRyLmRvbmUoKTtcbiAgfVxuXG4gIHByaXZhdGUgX29uQ2FtQXR0ckNoYW5nZWQoYXR0cjogR29tbEF0dHJpYnV0ZSk6IHZvaWQge1xuICAgIHRoaXMuX3Jlc29sdmVDYW1lcmEoYXR0ci5WYWx1ZSwgYXR0ci5kb25lLmJpbmQoYXR0cikpO1xuICB9XG5cbiAgcHJpdmF0ZSBfb25Ta3lib3hBdHRyQ2hhbmdlZChhdHRyKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuYXR0cmlidXRlcy5nZXRWYWx1ZShcImJhY2tncm91bmRUeXBlXCIpID09PSBcInNreWJveFwiKSB7XG4gICAgICB0aGlzLm5vZGVJbXBvcnQoXCJqdGhyZWUucmVzb3VyY2UuVGV4dHVyZUN1YmVcIiwgYXR0ci5WYWx1ZSwgKG5vZGU6IEN1YmVUZXh0dXJlTm9kZSkgPT4ge1xuICAgICAgICBpZiAobm9kZSkge1xuICAgICAgICAgIGlmICghdGhpcy5fc2t5Qm94U3RhZ2VDaGFpbikge1xuICAgICAgICAgICAgdGhpcy5fc2t5Qm94U3RhZ2VDaGFpbiA9IHtcbiAgICAgICAgICAgICAgYnVmZmVyczoge1xuICAgICAgICAgICAgICAgIE9VVDogXCJtYWluXCJcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgc3RhZ2U6IFwianRocmVlLmJhc2ljLnNreWJveFwiLFxuICAgICAgICAgICAgICB2YXJpYWJsZXM6IHt9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdGhpcy50YXJnZXQucmVuZGVyUGF0aC5pbnNlcnRXaXRoSW5kZXgoMCwgdGhpcy5fc2t5Qm94U3RhZ2VDaGFpbik7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMuX3NreUJveFN0YWdlQ2hhaW4udmFyaWFibGVzW1wic2t5Ym94XCJdID0gbm9kZS50YXJnZXQ7XG4gICAgICAgICAgYXR0ci5kb25lKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYXR0ci5kb25lKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBhdHRyLmRvbmUoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF91cGRhdGVWaWV3cG9ydEFyZWEoKTogdm9pZCB7XG4gICAgLy8gY29uc29sZS5sb2coXCJ1cGRhdGVWaWV3cG9ydEFyZWFcIik7XG4gICAgaWYgKHRoaXMuX3BhcmVudENhbnZhcykgeyAvLyDjgZPjgZPkvZXjgoTjgaPjgabjgovjgpPjgaDjgaPjgZFcbiAgICAgIGlmICh0aGlzLl9wYXJlbnRDYW52YXMuY2FudmFzRnJhbWVzLmNvbnRhaW5lcikge1xuICAgICAgICAvLyB3aGVuIGNhbnZhcyBIVE1MRWxlbWVudCBpcyBhcHBsaWVkXG4gICAgICAgIGNvbnN0IGZyYW1lID0gdGhpcy5fcGFyZW50Q2FudmFzLmNhbnZhc0ZyYW1lcy5jb250YWluZXI7XG4gICAgICAgIGNvbnN0IFcgPSBmcmFtZS5jbGllbnRXaWR0aDtcbiAgICAgICAgY29uc3QgSCA9IGZyYW1lLmNsaWVudEhlaWdodDtcbiAgICAgICAgY29uc3QgbGVmdCA9IHRoaXMuX2xlZnQgPiAxID8gdGhpcy5fbGVmdCA6IFcgKiB0aGlzLl9sZWZ0O1xuICAgICAgICBjb25zdCB0b3AgPSB0aGlzLl90b3AgPiAxID8gdGhpcy5fdG9wIDogSCAqIHRoaXMuX3RvcDtcbiAgICAgICAgY29uc3Qgd2lkdGggPSB0aGlzLl93aWR0aCA+IDEgPyB0aGlzLl93aWR0aCA6IFcgKiB0aGlzLl93aWR0aDtcbiAgICAgICAgY29uc3QgaGVpZ2h0ID0gdGhpcy5faGVpZ2h0ID4gMSA/IHRoaXMuX2hlaWdodCA6IEggKiB0aGlzLl9oZWlnaHQ7XG4gICAgICAgIHRoaXMudGFyZ2V0LnJlZ2lvbiA9IG5ldyBSZWN0YW5nbGUobGVmdCwgdG9wLCB3aWR0aCwgaGVpZ2h0KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIHdoZW4gY2FudmFzIEhUTUxFbGVtZW50IGlzIG5vdCBhcHBsaWVkXG4gICAgICAgIHRoaXMudGFyZ2V0LnJlZ2lvbiA9IG5ldyBSZWN0YW5nbGUodGhpcy5fbGVmdCwgdGhpcy5fdG9wLCB0aGlzLl93aWR0aCwgdGhpcy5faGVpZ2h0KTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLnRhcmdldC5DYW1lcmEuZ2V0VHlwZU5hbWUoKSA9PT0gXCJQZXJzcGVjdGl2ZUNhbWVyYVwiKSB7XG4gICAgICAgICg8UGVyc3BlY3RpdmVDYW1lcmE+dGhpcy50YXJnZXQuQ2FtZXJhKS5Bc3BlY3QgPSB0aGlzLl93aWR0aCAvIHRoaXMuX2hlaWdodDtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9yZXNvbHZlQ2FtZXJhKGNhbTogc3RyaW5nLCBkb25lOiAoKSA9PiB2b2lkKTogdm9pZCB7XG4gICAgdGhpcy5ub2RlSW1wb3J0KFwianRocmVlLnNjZW5lLmNhbWVyYVwiLCBjYW0sIChjYW1lcmFOb2RlOiBDYW1lcmFOb2RlQmFzZTxDYW1lcmE+KSA9PiB7XG4gICAgICAvL1xuICAgICAgLy8gcmVtb3ZlIGNhbWVyYSBoZXJlXG4gICAgICAvL1xuICAgICAgaWYgKGNhbWVyYU5vZGUpIHtcbiAgICAgICAgaWYgKGNhbWVyYU5vZGUuQ29udGFpbmVkU2NlbmVOb2RlICE9IG51bGwpIHsgLy8gaWYgdGhlcmUgd2FzIHNwZWNpZmllZCBjYW1lcmEgYW5kIHRoZXJlIGlzIFNjZW5lXG4gICAgICAgICAgdGhpcy50YXJnZXQuQ2FtZXJhID0gY2FtZXJhTm9kZS50YXJnZXQ7XG4gICAgICAgICAgY29uc3Qgc2NlbmU6IFNjZW5lID0gY2FtZXJhTm9kZS5Db250YWluZWRTY2VuZU5vZGUudGFyZ2V0O1xuICAgICAgICAgIHNjZW5lLmFkZFJlbmRlcmVyKHRoaXMudGFyZ2V0KTtcbiAgICAgICAgICB0aGlzLl91cGRhdGVWaWV3cG9ydEFyZWEoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKFwiY2FudCByZXRyaWV2ZSBzY2VuZSFcIik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGRvbmUoKTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBWaWV3UG9ydE5vZGU7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=

import JThreeObject from "../Base/JThreeObject";
import Vector3 from "./Vector3";
import { vec3, quat } from "gl-matrix";
import Matrix from "./Matrix";
/**
* The class to maniplate quaternion.
* Basically,you don't need to operate raw element.
* You consider to use some of useful methods without editing raw element forcelly.
* Each element will be represented as (w;x,y,z)
* (1,i,j,k) is base axis for quaternion. (i,j,k is pure imaginary number)
* (w;x,y,z) means w*1+x*i+y*j+z*k
*
*/
class Quaternion extends JThreeObject {
    /**
    * Constructor by specifing each elements.
    */
    constructor(rawElements) {
        super();
        this.rawElements = rawElements;
    }
    static equals(q1, q2) {
        for (let i = 0; i < 4; i++) {
            if (q1.rawElements[i] !== q2.rawElements[i]) {
                return false;
            }
        }
        return true;
    }
    /**
    * Calculate add result of two quaternion
    */
    static add(q1, q2) {
        const newQuat = quat.create();
        return new Quaternion(quat.add(newQuat, q1.rawElements, q2.rawElements));
    }
    /**
    * Calculate multiply result of two quaternion
    */
    static multiply(q1, q2) {
        const newQuat = quat.create();
        return new Quaternion(quat.mul(newQuat, q1.rawElements, q2.rawElements));
    }
    /**
    * Calculate the rotation quaternion represented as pair of angle and axis.
    */
    static angleAxis(angle, axis) {
        const axisVec = vec3.create();
        axisVec[0] = axis.X;
        axisVec[1] = axis.Y;
        axisVec[2] = axis.Z;
        const newQuat = quat.create();
        return new Quaternion(quat.setAxisAngle(newQuat, axisVec, +angle));
    }
    static euler(x, y, z) {
        return Quaternion.multiply(Quaternion.angleAxis(z, Vector3.ZUnit), Quaternion.multiply(Quaternion.angleAxis(x, Vector3.XUnit), Quaternion.angleAxis(y, Vector3.YUnit)));
    }
    static eulerXYZ(x, y, z) {
        return Quaternion.multiply(Quaternion.angleAxis(z, Vector3.ZUnit), Quaternion.multiply(Quaternion.angleAxis(y, Vector3.YUnit), Quaternion.angleAxis(x, Vector3.XUnit)));
    }
    static slerp(q1, q2, t) {
        const newQuat = quat.create();
        return new Quaternion(quat.slerp(newQuat, q1.rawElements, q2.rawElements, +t));
    }
    /**
     * Returns the angle in degrees between two rotations q1 and q2.
     * @param q1 the quaternion represents begin angle.
     * @param q2 the quaternion represents end angle.
     * @returns {number} angle represented in radians.
     */
    static angle(q1, q2) {
        let delta = Quaternion.multiply(q2, q1.inverse());
        delta = delta.normalize();
        return 2 * Math.acos(delta.W);
    }
    static fromToRotation(from, to) {
        const crossed = Vector3.cross(from.normalized, to.normalized);
        const angle = Vector3.dot(from.normalized, to.normalized);
        return Quaternion.angleAxis(angle, crossed);
    }
    static lookRotation(forward, upVec) {
        upVec = upVec || Vector3.YUnit;
        const normalizedForward = forward.normalized;
        const upForwardCross = Vector3.cross(upVec, normalizedForward).normalized;
        const thirdAxis = Vector3.cross(normalizedForward, upForwardCross);
        const m00 = upForwardCross.X;
        const m01 = upForwardCross.Y;
        const m02 = upForwardCross.Z;
        const m10 = thirdAxis.X;
        const m11 = thirdAxis.Y;
        const m12 = thirdAxis.Z;
        const m20 = normalizedForward.X;
        const m21 = normalizedForward.Y;
        const m22 = normalizedForward.Z;
        const num8 = m00 + m11 + m22;
        if (num8 > 0) {
            const num = Math.sqrt(1 + num8);
            return new Quaternion([(m12 - m21) * 0.5 / num, (m20 - m02) * 0.5 / num, (m01 - m10) * 0.5 / num, num / 2]);
        }
        if (m00 >= m11 && m00 >= m22) {
            const num7 = Math.sqrt(1 + m00 - m11 - m22);
            return new Quaternion([(m01 + m10) * 0.5 / num7, (m02 + m20) * 0.5 / num7, (m12 - m21) * 0.5 / num7, num7 / 2]);
        }
        if (m11 > m22) {
            const num6 = Math.sqrt(1 + m11 - m00 - m22);
            return new Quaternion([(m10 + m01) * 0, 5 / num6, 0.5 * num6, (m21 + m12) * 0.5 / num6, (m20 - m02) * 0.5 / num6]);
        }
        const num5 = Math.sqrt(1 + m22 - m00 - m11);
        return new Quaternion([(m20 + m02) * 0.5 / num5, (m21 + m12) * 0.5 / num5, 0.5 * num5, (m01 - m10) * 0.5 / num5]);
    }
    static get Identity() {
        return new Quaternion(quat.create());
    }
    get eularAngles() {
        const eular = this.factoringQuaternionZXY();
        return new Vector3(eular.x, eular.y, eular.z);
    }
    set eularAngles(v) {
        this.rawElements = Quaternion.euler(v.X, v.Y, v.Z).rawElements;
    }
    /**
    * Getter for X.
    */
    get X() {
        return this.rawElements[0];
    }
    /**
    * Getter for Y.
    */
    get Y() {
        return this.rawElements[1];
    }
    /**
    * Getter for Z.
    */
    get Z() {
        return this.rawElements[2];
    }
    /**
    * Getter for W.
    */
    get W() {
        return this.rawElements[3];
    }
    /**
    * Getter for imaginary part vector.
    * It returns the vector (x,y,z)
    */
    get ImaginaryPart() {
        return new Vector3(this.X, this.Y, this.Z);
    }
    /**
    * Get the conjugate of this quaternion
    */
    get Conjugate() {
        const newQuat = quat.create();
        return new Quaternion(quat.conjugate(newQuat, this.rawElements));
    }
    /**
    * Get the length
    */
    get Length() {
        return quat.len(this.rawElements);
    }
    equalWith(q) {
        return Quaternion.equals(this, q);
    }
    /**
    * Get normalized quaternion
    */
    normalize() {
        const newQuat = quat.create();
        return new Quaternion(quat.normalize(newQuat, this.rawElements));
    }
    inverse() {
        const newQuat = quat.create();
        return new Quaternion(quat.invert(newQuat, this.rawElements));
    }
    toAngleAxisString() {
        const angle = 2 * Math.acos(this.W);
        const imm = Math.sqrt(1 - this.W * this.W);
        if (angle !== 180 && angle !== 0) {
            return `axis(${angle},${this.X / imm},${this.Y / imm},${this.Z / imm})`;
        }
        else if (angle === 0) {
            return `axis(${angle},0,1,0)`;
        }
        else {
            return `axis(180d,${this.X},${this.Y},${this.Z})`;
        }
    }
    toString() {
        return this.toAngleAxisString();
    }
    factoringQuaternionZXY() {
        const result = { x: 0, y: 0, z: 0 };
        const mat = Matrix.rotationQuaternion(this);
        const sx = mat.rawElements[6];
        if (Math.abs(sx) < 1 - 1.0E-4) {
            result.x = Math.asin(sx);
            result.z = Math.atan2(-mat.rawElements[4], mat.rawElements[5]);
            result.y = Math.atan2(-mat.rawElements[2], mat.rawElements[10]);
        }
        else {
            result.y = 0;
            result.x = Math.PI / 2 * sx;
            result.z = Math.atan2(mat.rawElements[1], mat.rawElements[0]);
        }
        return result;
    }
    factoringQuaternionXYZ() {
        const result = { x: 0, y: 0, z: 0 };
        const mat = Matrix.rotationQuaternion(this);
        const sy = -mat.rawElements[2];
        if (Math.abs(sy) < 1 - 1.0E-4) {
            result.x = Math.atan2(mat.rawElements[6], mat.rawElements[10]);
            result.y = Math.asin(sy);
            result.z = Math.atan2(mat.rawElements[1], mat.rawElements[0]);
        }
        else {
            result.x = 0;
            result.y = Math.PI / 2 * sy;
            result.z = Math.atan2(-mat.rawElements[4], mat.rawElements[5]);
        }
        return result;
    }
}
export default Quaternion;

//# sourceMappingURL=data:application/json;base64,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VSxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsRUFBRSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxHQUFHLEdBQUcsR0FBRyxFQUFFLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUcsR0FBRyxHQUFHLEVBQUUsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDOUcsQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLEdBQUcsSUFBSSxHQUFHLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDN0IsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQztZQUM1QyxNQUFNLENBQUMsSUFBSSxVQUFVLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxHQUFHLEdBQUcsSUFBSSxFQUFFLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUcsR0FBRyxJQUFJLEVBQUUsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsR0FBRyxHQUFHLElBQUksRUFBRSxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsSCxDQUFDO1FBQ0QsRUFBRSxDQUFDLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDZCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxHQUFHLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDO1lBQzVDLE1BQU0sQ0FBQyxJQUFJLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxFQUFFLEdBQUcsR0FBRyxJQUFJLEVBQUUsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsR0FBRyxHQUFHLElBQUksRUFBRSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNySCxDQUFDO1FBQ0QsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQztRQUM1QyxNQUFNLENBQUMsSUFBSSxVQUFVLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxHQUFHLEdBQUcsSUFBSSxFQUFFLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUcsR0FBRyxJQUFJLEVBQUUsR0FBRyxHQUFHLElBQUksRUFBRSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUNwSCxDQUFDO0lBRUQsV0FBa0IsUUFBUTtRQUN4QixNQUFNLENBQUMsSUFBSSxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUVELElBQVcsV0FBVztRQUNwQixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztRQUM1QyxNQUFNLENBQUMsSUFBSSxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNoRCxDQUFDO0lBRUQsSUFBVyxXQUFXLENBQUMsQ0FBVTtRQUMvQixJQUFJLENBQUMsV0FBVyxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUM7SUFDakUsQ0FBQztJQUVEOztNQUVFO0lBQ0YsSUFBVyxDQUFDO1FBQ1YsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDN0IsQ0FBQztJQUVEOztNQUVFO0lBQ0YsSUFBVyxDQUFDO1FBQ1YsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDN0IsQ0FBQztJQUVEOztNQUVFO0lBQ0YsSUFBVyxDQUFDO1FBQ1YsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDN0IsQ0FBQztJQUVEOztNQUVFO0lBQ0YsSUFBVyxDQUFDO1FBQ1YsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDN0IsQ0FBQztJQUVEOzs7TUFHRTtJQUNGLElBQVcsYUFBYTtRQUN0QixNQUFNLENBQUMsSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRUQ7O01BRUU7SUFDRixJQUFXLFNBQVM7UUFDbEIsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQzlCLE1BQU0sQ0FBQyxJQUFJLFVBQVUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztJQUNuRSxDQUFDO0lBRUQ7O01BRUU7SUFDRixJQUFXLE1BQU07UUFDZixNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVNLFNBQVMsQ0FBQyxDQUFhO1FBQzVCLE1BQU0sQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRUQ7O01BRUU7SUFDSyxTQUFTO1FBQ2QsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQzlCLE1BQU0sQ0FBQyxJQUFJLFVBQVUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztJQUNuRSxDQUFDO0lBR00sT0FBTztRQUNaLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUM5QixNQUFNLENBQUMsSUFBSSxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7SUFDaEUsQ0FBQztJQUVNLGlCQUFpQjtRQUN0QixNQUFNLEtBQUssR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDcEMsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDM0MsRUFBRSxDQUFDLENBQUMsS0FBSyxLQUFLLEdBQUcsSUFBSSxLQUFLLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNqQyxNQUFNLENBQUMsUUFBUSxLQUFLLElBQUksSUFBSSxDQUFDLENBQUMsR0FBRyxHQUFHLElBQUksSUFBSSxDQUFDLENBQUMsR0FBRyxHQUFHLElBQUksSUFBSSxDQUFDLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztRQUMxRSxDQUFDO1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3ZCLE1BQU0sQ0FBQyxRQUFRLEtBQUssU0FBUyxDQUFDO1FBQ2hDLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLE1BQU0sQ0FBQyxhQUFhLElBQUksQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUM7UUFDcEQsQ0FBQztJQUNILENBQUM7SUFFTSxRQUFRO1FBQ2IsTUFBTSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO0lBQ2xDLENBQUM7SUFFTSxzQkFBc0I7UUFDM0IsTUFBTSxNQUFNLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDO1FBQ3BDLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1QyxNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzlCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDOUIsTUFBTSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3pCLE1BQU0sQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQy9ELE1BQU0sQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ2xFLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2IsTUFBTSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsRUFBRSxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDNUIsTUFBTSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2hFLENBQUM7UUFDRCxNQUFNLENBQUMsTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFHTSxzQkFBc0I7UUFDM0IsTUFBTSxNQUFNLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDO1FBQ3BDLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1QyxNQUFNLEVBQUUsR0FBRyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDL0IsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUM5QixNQUFNLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDL0QsTUFBTSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3pCLE1BQU0sQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNoRSxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNiLE1BQU0sQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEVBQUUsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQzVCLE1BQU0sQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2pFLENBQUM7UUFDRCxNQUFNLENBQUMsTUFBTSxDQUFDO0lBQ2hCLENBQUM7QUFDSCxDQUFDO0FBRUQsZUFBZSxVQUFVLENBQUMiLCJmaWxlIjoiTWF0aC9RdWF0ZXJuaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEpUaHJlZU9iamVjdCBmcm9tIFwiLi4vQmFzZS9KVGhyZWVPYmplY3RcIjtcbmltcG9ydCBWZWN0b3IzIGZyb20gXCIuL1ZlY3RvcjNcIjtcbmltcG9ydCB7R0xNLCB2ZWMzLCBxdWF0fSBmcm9tIFwiZ2wtbWF0cml4XCI7XG5pbXBvcnQgTWF0cml4IGZyb20gXCIuL01hdHJpeFwiO1xuLyoqXG4qIFRoZSBjbGFzcyB0byBtYW5pcGxhdGUgcXVhdGVybmlvbi5cbiogQmFzaWNhbGx5LHlvdSBkb24ndCBuZWVkIHRvIG9wZXJhdGUgcmF3IGVsZW1lbnQuXG4qIFlvdSBjb25zaWRlciB0byB1c2Ugc29tZSBvZiB1c2VmdWwgbWV0aG9kcyB3aXRob3V0IGVkaXRpbmcgcmF3IGVsZW1lbnQgZm9yY2VsbHkuXG4qIEVhY2ggZWxlbWVudCB3aWxsIGJlIHJlcHJlc2VudGVkIGFzICh3O3gseSx6KVxuKiAoMSxpLGosaykgaXMgYmFzZSBheGlzIGZvciBxdWF0ZXJuaW9uLiAoaSxqLGsgaXMgcHVyZSBpbWFnaW5hcnkgbnVtYmVyKVxuKiAodzt4LHkseikgbWVhbnMgdyoxK3gqaSt5KmoreiprXG4qXG4qL1xuY2xhc3MgUXVhdGVybmlvbiBleHRlbmRzIEpUaHJlZU9iamVjdCB7XG5cbiAgcHVibGljIHJhd0VsZW1lbnRzOiBHTE0uSUFycmF5O1xuXG4gIC8qKlxuICAqIENvbnN0cnVjdG9yIGJ5IHNwZWNpZmluZyBlYWNoIGVsZW1lbnRzLlxuICAqL1xuICBjb25zdHJ1Y3RvcihyYXdFbGVtZW50czogR0xNLklBcnJheSkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5yYXdFbGVtZW50cyA9IHJhd0VsZW1lbnRzO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBlcXVhbHMocTE6IFF1YXRlcm5pb24sIHEyOiBRdWF0ZXJuaW9uKTogYm9vbGVhbiB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHtcbiAgICAgIGlmIChxMS5yYXdFbGVtZW50c1tpXSAhPT0gcTIucmF3RWxlbWVudHNbaV0pIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG5cbiAgLyoqXG4gICogQ2FsY3VsYXRlIGFkZCByZXN1bHQgb2YgdHdvIHF1YXRlcm5pb25cbiAgKi9cbiAgcHVibGljIHN0YXRpYyBhZGQocTE6IFF1YXRlcm5pb24sIHEyOiBRdWF0ZXJuaW9uKTogUXVhdGVybmlvbiB7XG4gICAgY29uc3QgbmV3UXVhdCA9IHF1YXQuY3JlYXRlKCk7XG5cbiAgICByZXR1cm4gbmV3IFF1YXRlcm5pb24ocXVhdC5hZGQobmV3UXVhdCwgcTEucmF3RWxlbWVudHMsIHEyLnJhd0VsZW1lbnRzKSk7XG4gIH1cblxuICAvKipcbiAgKiBDYWxjdWxhdGUgbXVsdGlwbHkgcmVzdWx0IG9mIHR3byBxdWF0ZXJuaW9uXG4gICovXG4gIHB1YmxpYyBzdGF0aWMgbXVsdGlwbHkocTE6IFF1YXRlcm5pb24sIHEyOiBRdWF0ZXJuaW9uKTogUXVhdGVybmlvbiB7XG4gICAgY29uc3QgbmV3UXVhdCA9IHF1YXQuY3JlYXRlKCk7XG4gICAgcmV0dXJuIG5ldyBRdWF0ZXJuaW9uKHF1YXQubXVsKG5ld1F1YXQsIHExLnJhd0VsZW1lbnRzLCBxMi5yYXdFbGVtZW50cykpO1xuICB9XG5cbiAgLyoqXG4gICogQ2FsY3VsYXRlIHRoZSByb3RhdGlvbiBxdWF0ZXJuaW9uIHJlcHJlc2VudGVkIGFzIHBhaXIgb2YgYW5nbGUgYW5kIGF4aXMuXG4gICovXG4gIHB1YmxpYyBzdGF0aWMgYW5nbGVBeGlzKGFuZ2xlOiBudW1iZXIsIGF4aXM6IFZlY3RvcjMpOiBRdWF0ZXJuaW9uIHtcbiAgICBjb25zdCBheGlzVmVjID0gdmVjMy5jcmVhdGUoKTtcbiAgICBheGlzVmVjWzBdID0gYXhpcy5YO1xuICAgIGF4aXNWZWNbMV0gPSBheGlzLlk7XG4gICAgYXhpc1ZlY1syXSA9IGF4aXMuWjtcbiAgICBjb25zdCBuZXdRdWF0ID0gcXVhdC5jcmVhdGUoKTtcbiAgICByZXR1cm4gbmV3IFF1YXRlcm5pb24ocXVhdC5zZXRBeGlzQW5nbGUobmV3UXVhdCwgYXhpc1ZlYywgK2FuZ2xlKSk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGV1bGVyKHg6IG51bWJlciwgeTogbnVtYmVyLCB6OiBudW1iZXIpOiBRdWF0ZXJuaW9uIHtcbiAgICByZXR1cm4gUXVhdGVybmlvbi5tdWx0aXBseShRdWF0ZXJuaW9uLmFuZ2xlQXhpcyh6LCBWZWN0b3IzLlpVbml0KSwgUXVhdGVybmlvbi5tdWx0aXBseShRdWF0ZXJuaW9uLmFuZ2xlQXhpcyh4LCBWZWN0b3IzLlhVbml0KSwgUXVhdGVybmlvbi5hbmdsZUF4aXMoeSwgVmVjdG9yMy5ZVW5pdCkpKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZXVsZXJYWVooeDogbnVtYmVyLCB5OiBudW1iZXIsIHo6IG51bWJlcik6IFF1YXRlcm5pb24ge1xuICAgIHJldHVybiBRdWF0ZXJuaW9uLm11bHRpcGx5KFF1YXRlcm5pb24uYW5nbGVBeGlzKHosIFZlY3RvcjMuWlVuaXQpLCBRdWF0ZXJuaW9uLm11bHRpcGx5KFF1YXRlcm5pb24uYW5nbGVBeGlzKHksIFZlY3RvcjMuWVVuaXQpLCBRdWF0ZXJuaW9uLmFuZ2xlQXhpcyh4LCBWZWN0b3IzLlhVbml0KSkpO1xuICB9XG5cblxuICBwdWJsaWMgc3RhdGljIHNsZXJwKHExOiBRdWF0ZXJuaW9uLCBxMjogUXVhdGVybmlvbiwgdDogbnVtYmVyKTogUXVhdGVybmlvbiB7XG4gICAgY29uc3QgbmV3UXVhdCA9IHF1YXQuY3JlYXRlKCk7XG4gICAgcmV0dXJuIG5ldyBRdWF0ZXJuaW9uKHF1YXQuc2xlcnAobmV3UXVhdCwgcTEucmF3RWxlbWVudHMsIHEyLnJhd0VsZW1lbnRzLCArdCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIGFuZ2xlIGluIGRlZ3JlZXMgYmV0d2VlbiB0d28gcm90YXRpb25zIHExIGFuZCBxMi5cbiAgICogQHBhcmFtIHExIHRoZSBxdWF0ZXJuaW9uIHJlcHJlc2VudHMgYmVnaW4gYW5nbGUuXG4gICAqIEBwYXJhbSBxMiB0aGUgcXVhdGVybmlvbiByZXByZXNlbnRzIGVuZCBhbmdsZS5cbiAgICogQHJldHVybnMge251bWJlcn0gYW5nbGUgcmVwcmVzZW50ZWQgaW4gcmFkaWFucy5cbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgYW5nbGUocTE6IFF1YXRlcm5pb24sIHEyOiBRdWF0ZXJuaW9uKTogbnVtYmVyIHtcbiAgICBsZXQgZGVsdGEgPSBRdWF0ZXJuaW9uLm11bHRpcGx5KHEyLCBxMS5pbnZlcnNlKCkpO1xuICAgIGRlbHRhID0gZGVsdGEubm9ybWFsaXplKCk7XG4gICAgcmV0dXJuIDIgKiBNYXRoLmFjb3MoZGVsdGEuVyk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGZyb21Ub1JvdGF0aW9uKGZyb206IFZlY3RvcjMsIHRvOiBWZWN0b3IzKTogUXVhdGVybmlvbiB7XG4gICAgY29uc3QgY3Jvc3NlZCA9IFZlY3RvcjMuY3Jvc3MoZnJvbS5ub3JtYWxpemVkLCB0by5ub3JtYWxpemVkKTtcbiAgICBjb25zdCBhbmdsZSA9IFZlY3RvcjMuZG90KGZyb20ubm9ybWFsaXplZCwgdG8ubm9ybWFsaXplZCk7XG4gICAgcmV0dXJuIFF1YXRlcm5pb24uYW5nbGVBeGlzKGFuZ2xlLCBjcm9zc2VkKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgbG9va1JvdGF0aW9uKGZvcndhcmQ6IFZlY3RvcjMsIHVwVmVjPzogVmVjdG9yMyk6IFF1YXRlcm5pb24ge1xuICAgIHVwVmVjID0gdXBWZWMgfHwgVmVjdG9yMy5ZVW5pdDtcbiAgICBjb25zdCBub3JtYWxpemVkRm9yd2FyZCA9IGZvcndhcmQubm9ybWFsaXplZDtcbiAgICBjb25zdCB1cEZvcndhcmRDcm9zcyA9IFZlY3RvcjMuY3Jvc3ModXBWZWMsIG5vcm1hbGl6ZWRGb3J3YXJkKS5ub3JtYWxpemVkO1xuICAgIGNvbnN0IHRoaXJkQXhpcyA9IFZlY3RvcjMuY3Jvc3Mobm9ybWFsaXplZEZvcndhcmQsIHVwRm9yd2FyZENyb3NzKTtcbiAgICBjb25zdCBtMDAgPSB1cEZvcndhcmRDcm9zcy5YO1xuICAgIGNvbnN0IG0wMSA9IHVwRm9yd2FyZENyb3NzLlk7XG4gICAgY29uc3QgbTAyID0gdXBGb3J3YXJkQ3Jvc3MuWjtcbiAgICBjb25zdCBtMTAgPSB0aGlyZEF4aXMuWDtcbiAgICBjb25zdCBtMTEgPSB0aGlyZEF4aXMuWTtcbiAgICBjb25zdCBtMTIgPSB0aGlyZEF4aXMuWjtcbiAgICBjb25zdCBtMjAgPSBub3JtYWxpemVkRm9yd2FyZC5YO1xuICAgIGNvbnN0IG0yMSA9IG5vcm1hbGl6ZWRGb3J3YXJkLlk7XG4gICAgY29uc3QgbTIyID0gbm9ybWFsaXplZEZvcndhcmQuWjtcblxuICAgIGNvbnN0IG51bTggPSBtMDAgKyBtMTEgKyBtMjI7XG5cbiAgICBpZiAobnVtOCA+IDApIHtcbiAgICAgIGNvbnN0IG51bSA9IE1hdGguc3FydCgxICsgbnVtOCk7XG4gICAgICByZXR1cm4gbmV3IFF1YXRlcm5pb24oWyhtMTIgLSBtMjEpICogMC41IC8gbnVtLCAobTIwIC0gbTAyKSAqIDAuNSAvIG51bSwgKG0wMSAtIG0xMCkgKiAwLjUgLyBudW0sIG51bSAvIDJdKTtcbiAgICB9XG4gICAgaWYgKG0wMCA+PSBtMTEgJiYgbTAwID49IG0yMikge1xuICAgICAgY29uc3QgbnVtNyA9IE1hdGguc3FydCgxICsgbTAwIC0gbTExIC0gbTIyKTtcbiAgICAgIHJldHVybiBuZXcgUXVhdGVybmlvbihbKG0wMSArIG0xMCkgKiAwLjUgLyBudW03LCAobTAyICsgbTIwKSAqIDAuNSAvIG51bTcsIChtMTIgLSBtMjEpICogMC41IC8gbnVtNywgbnVtNyAvIDJdKTtcbiAgICB9XG4gICAgaWYgKG0xMSA+IG0yMikge1xuICAgICAgY29uc3QgbnVtNiA9IE1hdGguc3FydCgxICsgbTExIC0gbTAwIC0gbTIyKTtcbiAgICAgIHJldHVybiBuZXcgUXVhdGVybmlvbihbKG0xMCArIG0wMSkgKiAwLCA1IC8gbnVtNiwgMC41ICogbnVtNiwgKG0yMSArIG0xMikgKiAwLjUgLyBudW02LCAobTIwIC0gbTAyKSAqIDAuNSAvIG51bTZdKTtcbiAgICB9XG4gICAgY29uc3QgbnVtNSA9IE1hdGguc3FydCgxICsgbTIyIC0gbTAwIC0gbTExKTtcbiAgICByZXR1cm4gbmV3IFF1YXRlcm5pb24oWyhtMjAgKyBtMDIpICogMC41IC8gbnVtNSwgKG0yMSArIG0xMikgKiAwLjUgLyBudW01LCAwLjUgKiBudW01LCAobTAxIC0gbTEwKSAqIDAuNSAvIG51bTVdKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZ2V0IElkZW50aXR5KCk6IFF1YXRlcm5pb24ge1xuICAgIHJldHVybiBuZXcgUXVhdGVybmlvbihxdWF0LmNyZWF0ZSgpKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgZXVsYXJBbmdsZXMoKSB7XG4gICAgY29uc3QgZXVsYXIgPSB0aGlzLmZhY3RvcmluZ1F1YXRlcm5pb25aWFkoKTtcbiAgICByZXR1cm4gbmV3IFZlY3RvcjMoZXVsYXIueCwgZXVsYXIueSwgZXVsYXIueik7XG4gIH1cblxuICBwdWJsaWMgc2V0IGV1bGFyQW5nbGVzKHY6IFZlY3RvcjMpIHtcbiAgICB0aGlzLnJhd0VsZW1lbnRzID0gUXVhdGVybmlvbi5ldWxlcih2LlgsIHYuWSwgdi5aKS5yYXdFbGVtZW50cztcbiAgfVxuXG4gIC8qKlxuICAqIEdldHRlciBmb3IgWC5cbiAgKi9cbiAgcHVibGljIGdldCBYKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMucmF3RWxlbWVudHNbMF07XG4gIH1cblxuICAvKipcbiAgKiBHZXR0ZXIgZm9yIFkuXG4gICovXG4gIHB1YmxpYyBnZXQgWSgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLnJhd0VsZW1lbnRzWzFdO1xuICB9XG5cbiAgLyoqXG4gICogR2V0dGVyIGZvciBaLlxuICAqL1xuICBwdWJsaWMgZ2V0IFooKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5yYXdFbGVtZW50c1syXTtcbiAgfVxuXG4gIC8qKlxuICAqIEdldHRlciBmb3IgVy5cbiAgKi9cbiAgcHVibGljIGdldCBXKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMucmF3RWxlbWVudHNbM107XG4gIH1cblxuICAvKipcbiAgKiBHZXR0ZXIgZm9yIGltYWdpbmFyeSBwYXJ0IHZlY3Rvci5cbiAgKiBJdCByZXR1cm5zIHRoZSB2ZWN0b3IgKHgseSx6KVxuICAqL1xuICBwdWJsaWMgZ2V0IEltYWdpbmFyeVBhcnQoKTogVmVjdG9yMyB7XG4gICAgcmV0dXJuIG5ldyBWZWN0b3IzKHRoaXMuWCwgdGhpcy5ZLCB0aGlzLlopO1xuICB9XG5cbiAgLyoqXG4gICogR2V0IHRoZSBjb25qdWdhdGUgb2YgdGhpcyBxdWF0ZXJuaW9uXG4gICovXG4gIHB1YmxpYyBnZXQgQ29uanVnYXRlKCk6IFF1YXRlcm5pb24ge1xuICAgIGNvbnN0IG5ld1F1YXQgPSBxdWF0LmNyZWF0ZSgpO1xuICAgIHJldHVybiBuZXcgUXVhdGVybmlvbihxdWF0LmNvbmp1Z2F0ZShuZXdRdWF0LCB0aGlzLnJhd0VsZW1lbnRzKSk7XG4gIH1cblxuICAvKipcbiAgKiBHZXQgdGhlIGxlbmd0aFxuICAqL1xuICBwdWJsaWMgZ2V0IExlbmd0aCgpOiBudW1iZXIge1xuICAgIHJldHVybiBxdWF0Lmxlbih0aGlzLnJhd0VsZW1lbnRzKTtcbiAgfVxuXG4gIHB1YmxpYyBlcXVhbFdpdGgocTogUXVhdGVybmlvbik6IGJvb2xlYW4ge1xuICAgIHJldHVybiBRdWF0ZXJuaW9uLmVxdWFscyh0aGlzLCBxKTtcbiAgfVxuXG4gIC8qKlxuICAqIEdldCBub3JtYWxpemVkIHF1YXRlcm5pb25cbiAgKi9cbiAgcHVibGljIG5vcm1hbGl6ZSgpOiBRdWF0ZXJuaW9uIHtcbiAgICBjb25zdCBuZXdRdWF0ID0gcXVhdC5jcmVhdGUoKTtcbiAgICByZXR1cm4gbmV3IFF1YXRlcm5pb24ocXVhdC5ub3JtYWxpemUobmV3UXVhdCwgdGhpcy5yYXdFbGVtZW50cykpO1xuICB9XG5cblxuICBwdWJsaWMgaW52ZXJzZSgpOiBRdWF0ZXJuaW9uIHtcbiAgICBjb25zdCBuZXdRdWF0ID0gcXVhdC5jcmVhdGUoKTtcbiAgICByZXR1cm4gbmV3IFF1YXRlcm5pb24ocXVhdC5pbnZlcnQobmV3UXVhdCwgdGhpcy5yYXdFbGVtZW50cykpO1xuICB9XG5cbiAgcHVibGljIHRvQW5nbGVBeGlzU3RyaW5nKCk6IHN0cmluZyB7XG4gICAgY29uc3QgYW5nbGUgPSAyICogTWF0aC5hY29zKHRoaXMuVyk7XG4gICAgY29uc3QgaW1tID0gTWF0aC5zcXJ0KDEgLSB0aGlzLlcgKiB0aGlzLlcpO1xuICAgIGlmIChhbmdsZSAhPT0gMTgwICYmIGFuZ2xlICE9PSAwKSB7IC8vIGF2b2lkIHNpbmd1bGFyaXRpZXNcbiAgICAgIHJldHVybiBgYXhpcygke2FuZ2xlfSwke3RoaXMuWCAvIGltbX0sJHt0aGlzLlkgLyBpbW19LCR7dGhpcy5aIC8gaW1tfSlgO1xuICAgIH0gZWxzZSBpZiAoYW5nbGUgPT09IDApIHtcbiAgICAgIHJldHVybiBgYXhpcygke2FuZ2xlfSwwLDEsMClgO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gYGF4aXMoMTgwZCwke3RoaXMuWH0sJHt0aGlzLll9LCR7dGhpcy5afSlgO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyB0b1N0cmluZygpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnRvQW5nbGVBeGlzU3RyaW5nKCk7XG4gIH1cblxuICBwdWJsaWMgZmFjdG9yaW5nUXVhdGVybmlvblpYWSgpOiB7IHg6IG51bWJlciwgeTogbnVtYmVyLCB6OiBudW1iZXIgfSB7XG4gICAgY29uc3QgcmVzdWx0ID0geyB4OiAwLCB5OiAwLCB6OiAwIH07XG4gICAgY29uc3QgbWF0ID0gTWF0cml4LnJvdGF0aW9uUXVhdGVybmlvbih0aGlzKTtcbiAgICBjb25zdCBzeCA9IG1hdC5yYXdFbGVtZW50c1s2XTtcbiAgICBpZiAoTWF0aC5hYnMoc3gpIDwgMSAtIDEuMEUtNCkge1xuICAgICAgcmVzdWx0LnggPSBNYXRoLmFzaW4oc3gpO1xuICAgICAgcmVzdWx0LnogPSBNYXRoLmF0YW4yKC1tYXQucmF3RWxlbWVudHNbNF0sIG1hdC5yYXdFbGVtZW50c1s1XSk7XG4gICAgICByZXN1bHQueSA9IE1hdGguYXRhbjIoLW1hdC5yYXdFbGVtZW50c1syXSwgbWF0LnJhd0VsZW1lbnRzWzEwXSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlc3VsdC55ID0gMDtcbiAgICAgIHJlc3VsdC54ID0gTWF0aC5QSSAvIDIgKiBzeDtcbiAgICAgIHJlc3VsdC56ID0gTWF0aC5hdGFuMihtYXQucmF3RWxlbWVudHNbMV0sIG1hdC5yYXdFbGVtZW50c1swXSk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuXG4gIHB1YmxpYyBmYWN0b3JpbmdRdWF0ZXJuaW9uWFlaKCk6IHsgeDogbnVtYmVyLCB5OiBudW1iZXIsIHo6IG51bWJlciB9IHtcbiAgICBjb25zdCByZXN1bHQgPSB7IHg6IDAsIHk6IDAsIHo6IDAgfTtcbiAgICBjb25zdCBtYXQgPSBNYXRyaXgucm90YXRpb25RdWF0ZXJuaW9uKHRoaXMpO1xuICAgIGNvbnN0IHN5ID0gLW1hdC5yYXdFbGVtZW50c1syXTtcbiAgICBpZiAoTWF0aC5hYnMoc3kpIDwgMSAtIDEuMEUtNCkge1xuICAgICAgcmVzdWx0LnggPSBNYXRoLmF0YW4yKG1hdC5yYXdFbGVtZW50c1s2XSwgbWF0LnJhd0VsZW1lbnRzWzEwXSk7XG4gICAgICByZXN1bHQueSA9IE1hdGguYXNpbihzeSk7XG4gICAgICByZXN1bHQueiA9IE1hdGguYXRhbjIobWF0LnJhd0VsZW1lbnRzWzFdLCBtYXQucmF3RWxlbWVudHNbMF0pO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXN1bHQueCA9IDA7XG4gICAgICByZXN1bHQueSA9IE1hdGguUEkgLyAyICogc3k7XG4gICAgICByZXN1bHQueiA9IE1hdGguYXRhbjIoLW1hdC5yYXdFbGVtZW50c1s0XSwgbWF0LnJhd0VsZW1lbnRzWzVdKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBRdWF0ZXJuaW9uO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9

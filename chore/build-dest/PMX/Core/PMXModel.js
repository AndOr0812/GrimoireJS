import AsyncLoader from "../../Core/Resources/AsyncLoader";
import PMXPrimaryBufferMaterial from "./Materials/PMXPrimaryBufferMaterial";
import PMXCoreInitializer from "./PMXCoreInitializer";
import PMXHitAreaMaterial from "./Materials/PMXHitAreaMaterial";
import SceneObject from "../../Core/SceneObjects/SceneObject";
import PMXModelData from "../PMXData";
import PMXGeometry from "./PMXGeometry";
import PMXMaterial from "./Materials/PMXMaterial";
import PMXSkeleton from "./PMXSkeleton";
import PMXMorphManager from "./PMXMorphManager";
import PMXShadowMapMaterial from "./Materials/PMXShadowMapMaterial";
import PMXTextureManager from "./PMXTextureManager";
import Q from "q";
class PMXModel extends SceneObject {
    constructor(pmx, resourceDirectory) {
        super();
        this.loadingTextureCount = 0;
        this.loadedTextureCount = 0;
        this.loaded = false;
        this._materialDictionary = {};
        PMXCoreInitializer.init();
        this.on("load", () => { this.loaded = true; });
        this._modelData = pmx;
        this.modelDirectory = resourceDirectory;
        this.pmxTextureManager = new PMXTextureManager(this);
        this.__geometry = new PMXGeometry(pmx);
        this.skeleton = new PMXSkeleton(this);
        this._pmxMaterials = new Array(pmx.Materials.length);
        this.name = pmx.Header.modelName;
        let offset = 0;
        for (let materialCount = 0; materialCount < pmx.Materials.length; materialCount++) {
            const currentMat = pmx.Materials[materialCount];
            const mat = new PMXMaterial(this, materialCount, offset);
            this.addMaterial(mat);
            this.addMaterial(new PMXPrimaryBufferMaterial(mat));
            this.addMaterial(new PMXShadowMapMaterial(mat));
            this.addMaterial(new PMXHitAreaMaterial(mat));
            this._pmxMaterials[materialCount] = mat;
            this._materialDictionary[currentMat.materialName] = mat;
            offset += currentMat.vertexCount;
        }
        this._morphManager = new PMXMorphManager(this);
    }
    static loadFromUrl(url) {
        const directory = url.substr(0, url.lastIndexOf("/") + 1);
        return PMXModel._loadDataFromUrl(url, directory).then((modelData) => {
            const deferred = Q.defer();
            const model = new PMXModel(modelData, directory);
            if (model.loaded) {
                process.nextTick(() => {
                    deferred.resolve(model);
                });
            }
            else {
                model.on("load", () => {
                    deferred.resolve(model);
                });
            }
            return deferred.promise;
        }, (err) => {
            return err;
        });
    }
    /**
     * Request model data to specified url.
     * @param  {string}                   url the url pmx model being placed.
     * @return {Q.IPromise<PMXModelData>}     the promise object for loading.
     */
    static _loadDataFromUrl(url, directory) {
        return PMXModel._asyncLoader.fetch(url, (path) => {
            const deferred = Q.defer();
            const xhr = new XMLHttpRequest();
            xhr.open("GET", path, true);
            xhr.setRequestHeader("Accept", "*/*");
            xhr.responseType = "arraybuffer";
            xhr.onload = () => {
                const pmx = new PMXModelData(xhr.response, directory);
                deferred.resolve(pmx);
            };
            xhr.onerror = (err) => {
                deferred.reject(err);
            };
            xhr.send(null);
            return deferred.promise;
        });
    }
    getPMXMaterialByName(name) {
        return this._materialDictionary[name];
    }
    getPMXMaterialByIndex(index) {
        return this._pmxMaterials[index];
    }
    get ModelData() {
        return this._modelData;
    }
    get Materials() {
        return this._pmxMaterials;
    }
    get MorphManager() {
        return this._morphManager;
    }
    update() {
        this._morphManager.applyMorph();
        this.skeleton.updateMatricies();
    }
}
PMXModel._asyncLoader = new AsyncLoader();
export default PMXModel;

//# sourceMappingURL=data:application/json;base64,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LElBQUksQ0FBQyxRQUFRLENBQUMsZUFBZSxFQUFFLENBQUM7SUFDbEMsQ0FBQztBQUNILENBQUM7QUF0SGdCLHFCQUFZLEdBQThCLElBQUksV0FBVyxFQUFnQixDQXNIekY7QUFFRCxlQUFlLFFBQVEsQ0FBQyIsImZpbGUiOiJQTVgvQ29yZS9QTVhNb2RlbC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBBc3luY0xvYWRlciBmcm9tIFwiLi4vLi4vQ29yZS9SZXNvdXJjZXMvQXN5bmNMb2FkZXJcIjtcbmltcG9ydCBQTVhQcmltYXJ5QnVmZmVyTWF0ZXJpYWwgZnJvbSBcIi4vTWF0ZXJpYWxzL1BNWFByaW1hcnlCdWZmZXJNYXRlcmlhbFwiO1xuaW1wb3J0IFBNWENvcmVJbml0aWFsaXplciBmcm9tIFwiLi9QTVhDb3JlSW5pdGlhbGl6ZXJcIjtcbmltcG9ydCBQTVhIaXRBcmVhTWF0ZXJpYWwgZnJvbSBcIi4vTWF0ZXJpYWxzL1BNWEhpdEFyZWFNYXRlcmlhbFwiO1xuaW1wb3J0IFNjZW5lT2JqZWN0IGZyb20gXCIuLi8uLi9Db3JlL1NjZW5lT2JqZWN0cy9TY2VuZU9iamVjdFwiO1xuaW1wb3J0IFBNWE1vZGVsRGF0YSBmcm9tIFwiLi4vUE1YRGF0YVwiO1xuaW1wb3J0IFBNWEdlb21ldHJ5IGZyb20gXCIuL1BNWEdlb21ldHJ5XCI7XG5pbXBvcnQgUE1YTWF0ZXJpYWwgZnJvbSBcIi4vTWF0ZXJpYWxzL1BNWE1hdGVyaWFsXCI7XG5pbXBvcnQgUE1YU2tlbGV0b24gZnJvbSBcIi4vUE1YU2tlbGV0b25cIjtcbmltcG9ydCBQTVhNb3JwaE1hbmFnZXIgZnJvbSBcIi4vUE1YTW9ycGhNYW5hZ2VyXCI7XG5pbXBvcnQgUE1YU2hhZG93TWFwTWF0ZXJpYWwgZnJvbSBcIi4vTWF0ZXJpYWxzL1BNWFNoYWRvd01hcE1hdGVyaWFsXCI7XG5pbXBvcnQgUE1YVGV4dHVyZU1hbmFnZXIgZnJvbSBcIi4vUE1YVGV4dHVyZU1hbmFnZXJcIjtcbmltcG9ydCBRIGZyb20gXCJxXCI7XG5jbGFzcyBQTVhNb2RlbCBleHRlbmRzIFNjZW5lT2JqZWN0IHtcblxuICBwcml2YXRlIHN0YXRpYyBfYXN5bmNMb2FkZXI6IEFzeW5jTG9hZGVyPFBNWE1vZGVsRGF0YT4gPSBuZXcgQXN5bmNMb2FkZXI8UE1YTW9kZWxEYXRhPigpO1xuXG4gIHB1YmxpYyBza2VsZXRvbjogUE1YU2tlbGV0b247XG5cbiAgcHVibGljIGxvYWRpbmdUZXh0dXJlQ291bnQ6IG51bWJlciA9IDA7XG5cbiAgcHVibGljIGxvYWRlZFRleHR1cmVDb3VudDogbnVtYmVyID0gMDtcblxuICBwdWJsaWMgcG14VGV4dHVyZU1hbmFnZXI6IFBNWFRleHR1cmVNYW5hZ2VyO1xuXG4gIHB1YmxpYyBtb2RlbERpcmVjdG9yeTogc3RyaW5nO1xuXG4gIHB1YmxpYyBsb2FkZWQ6IGJvb2xlYW4gPSBmYWxzZTtcblxuICBwcml2YXRlIF9tb3JwaE1hbmFnZXI6IFBNWE1vcnBoTWFuYWdlcjtcblxuICBwcml2YXRlIF9tYXRlcmlhbERpY3Rpb25hcnk6IHsgW21hdGVyaWFsTmFtZTogc3RyaW5nXTogUE1YTWF0ZXJpYWwgfSA9IHt9O1xuXG4gIHByaXZhdGUgX3BteE1hdGVyaWFsczogUE1YTWF0ZXJpYWxbXTtcblxuICBwcml2YXRlIF9tb2RlbERhdGE6IFBNWE1vZGVsRGF0YTtcblxuXG4gIGNvbnN0cnVjdG9yKHBteDogUE1YTW9kZWxEYXRhLCByZXNvdXJjZURpcmVjdG9yeTogc3RyaW5nKSB7XG4gICAgc3VwZXIoKTtcbiAgICBQTVhDb3JlSW5pdGlhbGl6ZXIuaW5pdCgpO1xuICAgIHRoaXMub24oXCJsb2FkXCIsICgpID0+IHsgdGhpcy5sb2FkZWQgPSB0cnVlOyB9KTtcbiAgICB0aGlzLl9tb2RlbERhdGEgPSBwbXg7XG4gICAgdGhpcy5tb2RlbERpcmVjdG9yeSA9IHJlc291cmNlRGlyZWN0b3J5O1xuICAgIHRoaXMucG14VGV4dHVyZU1hbmFnZXIgPSBuZXcgUE1YVGV4dHVyZU1hbmFnZXIodGhpcyk7XG4gICAgdGhpcy5fX2dlb21ldHJ5ID0gbmV3IFBNWEdlb21ldHJ5KHBteCk7XG4gICAgdGhpcy5za2VsZXRvbiA9IG5ldyBQTVhTa2VsZXRvbih0aGlzKTtcbiAgICB0aGlzLl9wbXhNYXRlcmlhbHMgPSBuZXcgQXJyYXkocG14Lk1hdGVyaWFscy5sZW5ndGgpO1xuICAgIHRoaXMubmFtZSA9IHBteC5IZWFkZXIubW9kZWxOYW1lO1xuICAgIGxldCBvZmZzZXQgPSAwO1xuICAgIGZvciAobGV0IG1hdGVyaWFsQ291bnQgPSAwOyBtYXRlcmlhbENvdW50IDwgcG14Lk1hdGVyaWFscy5sZW5ndGg7IG1hdGVyaWFsQ291bnQrKykge1xuICAgICAgY29uc3QgY3VycmVudE1hdCA9IHBteC5NYXRlcmlhbHNbbWF0ZXJpYWxDb3VudF07XG4gICAgICBjb25zdCBtYXQgPSBuZXcgUE1YTWF0ZXJpYWwodGhpcywgbWF0ZXJpYWxDb3VudCwgb2Zmc2V0KTtcbiAgICAgIHRoaXMuYWRkTWF0ZXJpYWwobWF0KTtcbiAgICAgIHRoaXMuYWRkTWF0ZXJpYWwobmV3IFBNWFByaW1hcnlCdWZmZXJNYXRlcmlhbChtYXQpKTtcbiAgICAgIHRoaXMuYWRkTWF0ZXJpYWwobmV3IFBNWFNoYWRvd01hcE1hdGVyaWFsKG1hdCkpO1xuICAgICAgdGhpcy5hZGRNYXRlcmlhbChuZXcgUE1YSGl0QXJlYU1hdGVyaWFsKG1hdCkpO1xuICAgICAgdGhpcy5fcG14TWF0ZXJpYWxzW21hdGVyaWFsQ291bnRdID0gbWF0O1xuICAgICAgdGhpcy5fbWF0ZXJpYWxEaWN0aW9uYXJ5W2N1cnJlbnRNYXQubWF0ZXJpYWxOYW1lXSA9IG1hdDtcbiAgICAgIG9mZnNldCArPSBjdXJyZW50TWF0LnZlcnRleENvdW50O1xuICAgIH1cbiAgICB0aGlzLl9tb3JwaE1hbmFnZXIgPSBuZXcgUE1YTW9ycGhNYW5hZ2VyKHRoaXMpO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBsb2FkRnJvbVVybCh1cmw6IHN0cmluZyk6IFEuSVByb21pc2U8UE1YTW9kZWw+IHtcbiAgICBjb25zdCBkaXJlY3RvcnkgPSB1cmwuc3Vic3RyKDAsIHVybC5sYXN0SW5kZXhPZihcIi9cIikgKyAxKTtcbiAgICByZXR1cm4gUE1YTW9kZWwuX2xvYWREYXRhRnJvbVVybCh1cmwsIGRpcmVjdG9yeSkudGhlbjxQTVhNb2RlbD4oKG1vZGVsRGF0YSkgPT4ge1xuICAgICAgY29uc3QgZGVmZXJyZWQgPSBRLmRlZmVyPFBNWE1vZGVsPigpO1xuICAgICAgY29uc3QgbW9kZWwgPSBuZXcgUE1YTW9kZWwobW9kZWxEYXRhLCBkaXJlY3RvcnkpO1xuICAgICAgaWYgKG1vZGVsLmxvYWRlZCkge1xuICAgICAgICBwcm9jZXNzLm5leHRUaWNrKCgpID0+IHtcbiAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKG1vZGVsKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBtb2RlbC5vbihcImxvYWRcIiwgKCkgPT4ge1xuICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUobW9kZWwpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xuICAgIH0sIChlcnIpID0+IHtcbiAgICAgIHJldHVybiBlcnI7XG4gICAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXF1ZXN0IG1vZGVsIGRhdGEgdG8gc3BlY2lmaWVkIHVybC5cbiAgICogQHBhcmFtICB7c3RyaW5nfSAgICAgICAgICAgICAgICAgICB1cmwgdGhlIHVybCBwbXggbW9kZWwgYmVpbmcgcGxhY2VkLlxuICAgKiBAcmV0dXJuIHtRLklQcm9taXNlPFBNWE1vZGVsRGF0YT59ICAgICB0aGUgcHJvbWlzZSBvYmplY3QgZm9yIGxvYWRpbmcuXG4gICAqL1xuICBwcml2YXRlIHN0YXRpYyBfbG9hZERhdGFGcm9tVXJsKHVybDogc3RyaW5nLCBkaXJlY3Rvcnk6IHN0cmluZyk6IFEuSVByb21pc2U8UE1YTW9kZWxEYXRhPiB7XG4gICAgcmV0dXJuIFBNWE1vZGVsLl9hc3luY0xvYWRlci5mZXRjaCh1cmwsIChwYXRoKSA9PiB7XG4gICAgICBjb25zdCBkZWZlcnJlZCA9IFEuZGVmZXI8UE1YTW9kZWxEYXRhPigpO1xuICAgICAgY29uc3QgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gICAgICB4aHIub3BlbihcIkdFVFwiLCBwYXRoLCB0cnVlKTtcbiAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKFwiQWNjZXB0XCIsIFwiKi8qXCIpO1xuICAgICAgeGhyLnJlc3BvbnNlVHlwZSA9IFwiYXJyYXlidWZmZXJcIjtcbiAgICAgIHhoci5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHBteCA9IG5ldyBQTVhNb2RlbERhdGEoeGhyLnJlc3BvbnNlLCBkaXJlY3RvcnkpO1xuICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHBteCk7XG4gICAgICB9O1xuICAgICAgeGhyLm9uZXJyb3IgPSAoZXJyKSA9PiB7XG4gICAgICAgIGRlZmVycmVkLnJlamVjdChlcnIpO1xuICAgICAgfTtcbiAgICAgIHhoci5zZW5kKG51bGwpO1xuICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0UE1YTWF0ZXJpYWxCeU5hbWUobmFtZTogc3RyaW5nKTogUE1YTWF0ZXJpYWwge1xuICAgIHJldHVybiB0aGlzLl9tYXRlcmlhbERpY3Rpb25hcnlbbmFtZV07XG4gIH1cblxuICBwdWJsaWMgZ2V0UE1YTWF0ZXJpYWxCeUluZGV4KGluZGV4OiBudW1iZXIpOiBQTVhNYXRlcmlhbCB7XG4gICAgcmV0dXJuIHRoaXMuX3BteE1hdGVyaWFsc1tpbmRleF07XG4gIH1cblxuICBwdWJsaWMgZ2V0IE1vZGVsRGF0YSgpOiBQTVhNb2RlbERhdGEge1xuICAgIHJldHVybiB0aGlzLl9tb2RlbERhdGE7XG4gIH1cblxuXG4gIHB1YmxpYyBnZXQgTWF0ZXJpYWxzKCk6IFBNWE1hdGVyaWFsW10ge1xuICAgIHJldHVybiB0aGlzLl9wbXhNYXRlcmlhbHM7XG4gIH1cblxuICBwdWJsaWMgZ2V0IE1vcnBoTWFuYWdlcigpOiBQTVhNb3JwaE1hbmFnZXIge1xuICAgIHJldHVybiB0aGlzLl9tb3JwaE1hbmFnZXI7XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlKCk6IHZvaWQge1xuICAgIHRoaXMuX21vcnBoTWFuYWdlci5hcHBseU1vcnBoKCk7XG4gICAgdGhpcy5za2VsZXRvbi51cGRhdGVNYXRyaWNpZXMoKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBQTVhNb2RlbDtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==

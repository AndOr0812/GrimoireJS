import GomlTreeNodeBase from "../../Goml/GomlTreeNodeBase";
import VMDData from "../Parser/VMDData";
import Vector3 from "../../Math/Vector3";
import Quaternion from "../../Math/Quaternion";
import JThreeContext from "../../JThreeContext";
import ContextComponents from "../../ContextComponents";
class VMDNode extends GomlTreeNodeBase {
    constructor() {
        super();
        this._autoSpeed = 0;
        this._lastTime = null;
        this._frame = 0;
        this.attributes.defineAttribute({
            "src": {
                value: "",
                converter: "string",
                onchanged: this._onSrcAttrChanged,
            },
            "frame": {
                value: 0,
                converter: "float",
                onchanged: this._onFrameAttrChanged,
            },
            "enabled": {
                value: false,
                converter: "boolean",
                onchanged: (attr) => {
                    this._enabled = attr.Value;
                    attr.done();
                },
            },
            "autoSpeed": {
                value: "0",
                converter: "float",
                onchanged: (attr) => {
                    this._autoSpeed = attr.Value;
                    attr.done();
                },
            }
        });
    }
    __onMount() {
        super.__onMount();
        this._targetPMX = this.__parent;
        this._targetPMX.on("loaded", () => { this.attributes.updateValue(); });
    }
    update() {
        if (this._enabled && this._autoSpeed !== 0) {
            const timer = JThreeContext.getContextComponent(ContextComponents.Timer);
            if (this._lastTime === null) {
                this._lastTime = timer.time;
                return;
            }
            else {
                const dt = timer.time - this._lastTime;
                this._lastTime = timer.time;
                this.attributes.setValue("frame", this._frame + dt / 1000 * 30 * this._autoSpeed);
            }
        }
    }
    _onSrcAttrChanged(attr) {
        if (!attr.Value || attr.Value === this._lastURL) {
            attr.done();
            return;
        }
        if (this._vmdLoadingDeferred) {
            this._vmdLoadingDeferred.resolve(null);
            attr.done();
        }
        this._vmdLoadingDeferred = JThreeContext.getContextComponent(ContextComponents.ResourceLoader).getResourceLoadingDeffered();
        VMDData.loadFromUrl(attr.Value).then((data) => {
            this._lastURL = attr.Value;
            this._targetVMD = data;
            this._vmdLoadingDeferred.resolve(null);
            attr.done();
        });
    }
    _onFrameAttrChanged(attr) {
        this._frame = Math.max(0, attr.Value);
        if (!this.attributes.getValue("enabled")) {
            attr.done();
            return;
        }
        if (this._targetPMX.PMXModelReady && this._targetVMD) {
            for (let boneName in this._targetVMD.Motions) {
                let bone;
                if (bone = this._targetPMX.PMXModel.skeleton.getBoneByName(boneName)) {
                    const current = this._targetVMD.getBoneFrame(this._frame, boneName);
                    bone.Transformer.userTranslation = new Vector3(current.position);
                    bone.Transformer.userRotation = new Quaternion(current.rotation);
                }
            }
            for (let morphName in this._targetVMD.Morphs) {
                let morph;
                if (morph = this._targetPMX.PMXModel.MorphManager.getMorphByName(morphName)) {
                    const morphCurrent = this._targetVMD.getMorphFrame(this._frame, morphName);
                    if (morph) {
                        morph.Progress = morphCurrent.value;
                    }
                }
            }
            attr.done();
        }
        else {
            attr.done();
        }
    }
}
export default VMDNode;

//# sourceMappingURL=data:application/json;base64,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QUM7WUFDRCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDZCxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztBQUNILENBQUM7QUFFRCxlQUFlLE9BQU8sQ0FBQyIsImZpbGUiOiJWTUQvR29tbC9WTUROb2RlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEdvbWxUcmVlTm9kZUJhc2UgZnJvbSBcIi4uLy4uL0dvbWwvR29tbFRyZWVOb2RlQmFzZVwiO1xuaW1wb3J0IFBNWE5vZGUgZnJvbSBcIi4uLy4uL1BNWC9Hb21sL1BNWE5vZGVcIjtcbmltcG9ydCBQTVhCb25lIGZyb20gXCIuLi8uLi9QTVgvQ29yZS9QTVhCb25lXCI7XG5pbXBvcnQgVk1ERGF0YSBmcm9tIFwiLi4vUGFyc2VyL1ZNRERhdGFcIjtcbmltcG9ydCBWZWN0b3IzIGZyb20gXCIuLi8uLi9NYXRoL1ZlY3RvcjNcIjtcbmltcG9ydCBRdWF0ZXJuaW9uIGZyb20gXCIuLi8uLi9NYXRoL1F1YXRlcm5pb25cIjtcbmltcG9ydCBQTVhNb3JwaCBmcm9tIFwiLi4vLi4vUE1YL0NvcmUvUE1YTW9ycGhcIjtcbmltcG9ydCBQTVhCb25lVHJhbnNmb3JtZXIgZnJvbSBcIi4uLy4uL1BNWC9Db3JlL1BNWEJvbmVUcmFuc2Zvcm1lclwiO1xuaW1wb3J0IEpUaHJlZUNvbnRleHQgZnJvbSBcIi4uLy4uL0pUaHJlZUNvbnRleHRcIjtcbmltcG9ydCBDb250ZXh0Q29tcG9uZW50cyBmcm9tIFwiLi4vLi4vQ29udGV4dENvbXBvbmVudHNcIjtcbmltcG9ydCBUaW1lciBmcm9tIFwiLi4vLi4vQ29yZS9UaW1lclwiO1xuaW1wb3J0IFEgZnJvbSBcInFcIjtcbmltcG9ydCBSZXNvdXJjZUxvYWRlciBmcm9tIFwiLi4vLi4vQ29yZS9SZXNvdXJjZUxvYWRlclwiO1xuXG5jbGFzcyBWTUROb2RlIGV4dGVuZHMgR29tbFRyZWVOb2RlQmFzZSB7XG4gIHByaXZhdGUgX3RhcmdldFBNWDogUE1YTm9kZTtcblxuICBwcml2YXRlIF90YXJnZXRWTUQ6IFZNRERhdGE7XG5cbiAgcHJpdmF0ZSBfbGFzdFVSTDogc3RyaW5nO1xuXG4gIHByaXZhdGUgX2VuYWJsZWQ6IGJvb2xlYW47XG5cbiAgcHJpdmF0ZSBfYXV0b1NwZWVkOiBudW1iZXIgPSAwO1xuXG4gIHByaXZhdGUgX2xhc3RUaW1lOiBudW1iZXIgPSBudWxsO1xuXG4gIHByaXZhdGUgX2ZyYW1lOiBudW1iZXIgPSAwO1xuXG4gIHByaXZhdGUgX3ZtZExvYWRpbmdEZWZlcnJlZDogUS5EZWZlcnJlZDx2b2lkPjtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuYXR0cmlidXRlcy5kZWZpbmVBdHRyaWJ1dGUoe1xuICAgICAgXCJzcmNcIjoge1xuICAgICAgICB2YWx1ZTogXCJcIixcbiAgICAgICAgY29udmVydGVyOiBcInN0cmluZ1wiLFxuICAgICAgICBvbmNoYW5nZWQ6IHRoaXMuX29uU3JjQXR0ckNoYW5nZWQsXG4gICAgICB9LFxuICAgICAgXCJmcmFtZVwiOiB7XG4gICAgICAgIHZhbHVlOiAwLFxuICAgICAgICBjb252ZXJ0ZXI6IFwiZmxvYXRcIixcbiAgICAgICAgb25jaGFuZ2VkOiB0aGlzLl9vbkZyYW1lQXR0ckNoYW5nZWQsXG4gICAgICB9LFxuICAgICAgXCJlbmFibGVkXCI6IHtcbiAgICAgICAgdmFsdWU6IGZhbHNlLFxuICAgICAgICBjb252ZXJ0ZXI6IFwiYm9vbGVhblwiLFxuICAgICAgICBvbmNoYW5nZWQ6IChhdHRyKSA9PiB7XG4gICAgICAgICAgdGhpcy5fZW5hYmxlZCA9IGF0dHIuVmFsdWU7XG4gICAgICAgICAgYXR0ci5kb25lKCk7XG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgXCJhdXRvU3BlZWRcIjoge1xuICAgICAgICB2YWx1ZTogXCIwXCIsXG4gICAgICAgIGNvbnZlcnRlcjogXCJmbG9hdFwiLFxuICAgICAgICBvbmNoYW5nZWQ6IChhdHRyKSA9PiB7XG4gICAgICAgICAgdGhpcy5fYXV0b1NwZWVkID0gYXR0ci5WYWx1ZTtcbiAgICAgICAgICBhdHRyLmRvbmUoKTtcbiAgICAgICAgfSxcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByb3RlY3RlZCBfX29uTW91bnQoKTogdm9pZCB7XG4gICAgc3VwZXIuX19vbk1vdW50KCk7XG4gICAgdGhpcy5fdGFyZ2V0UE1YID0gPFBNWE5vZGU+dGhpcy5fX3BhcmVudDtcbiAgICB0aGlzLl90YXJnZXRQTVgub24oXCJsb2FkZWRcIiwgKCkgPT4geyB0aGlzLmF0dHJpYnV0ZXMudXBkYXRlVmFsdWUoKTsgfSk7XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLl9lbmFibGVkICYmIHRoaXMuX2F1dG9TcGVlZCAhPT0gMCkge1xuICAgICAgY29uc3QgdGltZXIgPSBKVGhyZWVDb250ZXh0LmdldENvbnRleHRDb21wb25lbnQ8VGltZXI+KENvbnRleHRDb21wb25lbnRzLlRpbWVyKTtcbiAgICAgIGlmICh0aGlzLl9sYXN0VGltZSA9PT0gbnVsbCkge1xuICAgICAgICB0aGlzLl9sYXN0VGltZSA9IHRpbWVyLnRpbWU7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IGR0ID0gdGltZXIudGltZSAtIHRoaXMuX2xhc3RUaW1lO1xuICAgICAgICB0aGlzLl9sYXN0VGltZSA9IHRpbWVyLnRpbWU7XG4gICAgICAgIHRoaXMuYXR0cmlidXRlcy5zZXRWYWx1ZShcImZyYW1lXCIsIHRoaXMuX2ZyYW1lICsgZHQgLyAxMDAwICogMzAgKiB0aGlzLl9hdXRvU3BlZWQpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX29uU3JjQXR0ckNoYW5nZWQoYXR0cik6IHZvaWQge1xuICAgIGlmICghYXR0ci5WYWx1ZSB8fCBhdHRyLlZhbHVlID09PSB0aGlzLl9sYXN0VVJMKSB7XG4gICAgICBhdHRyLmRvbmUoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHRoaXMuX3ZtZExvYWRpbmdEZWZlcnJlZCkge1xuICAgICAgdGhpcy5fdm1kTG9hZGluZ0RlZmVycmVkLnJlc29sdmUobnVsbCk7XG4gICAgICBhdHRyLmRvbmUoKTtcbiAgICB9XG4gICAgdGhpcy5fdm1kTG9hZGluZ0RlZmVycmVkID0gSlRocmVlQ29udGV4dC5nZXRDb250ZXh0Q29tcG9uZW50PFJlc291cmNlTG9hZGVyPihDb250ZXh0Q29tcG9uZW50cy5SZXNvdXJjZUxvYWRlcikuZ2V0UmVzb3VyY2VMb2FkaW5nRGVmZmVyZWQ8dm9pZD4oKTtcbiAgICBWTUREYXRhLmxvYWRGcm9tVXJsKGF0dHIuVmFsdWUpLnRoZW4oKGRhdGEpID0+IHtcbiAgICAgIHRoaXMuX2xhc3RVUkwgPSBhdHRyLlZhbHVlO1xuICAgICAgdGhpcy5fdGFyZ2V0Vk1EID0gZGF0YTtcbiAgICAgIHRoaXMuX3ZtZExvYWRpbmdEZWZlcnJlZC5yZXNvbHZlKG51bGwpO1xuICAgICAgYXR0ci5kb25lKCk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIF9vbkZyYW1lQXR0ckNoYW5nZWQoYXR0cik6IHZvaWQge1xuICAgIHRoaXMuX2ZyYW1lID0gTWF0aC5tYXgoMCwgYXR0ci5WYWx1ZSk7XG4gICAgaWYgKCF0aGlzLmF0dHJpYnV0ZXMuZ2V0VmFsdWUoXCJlbmFibGVkXCIpKSB7XG4gICAgICBhdHRyLmRvbmUoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHRoaXMuX3RhcmdldFBNWC5QTVhNb2RlbFJlYWR5ICYmIHRoaXMuX3RhcmdldFZNRCkge1xuICAgICAgZm9yIChsZXQgYm9uZU5hbWUgaW4gdGhpcy5fdGFyZ2V0Vk1ELk1vdGlvbnMpIHtcbiAgICAgICAgbGV0IGJvbmU6IFBNWEJvbmU7XG4gICAgICAgIGlmIChib25lID0gdGhpcy5fdGFyZ2V0UE1YLlBNWE1vZGVsLnNrZWxldG9uLmdldEJvbmVCeU5hbWUoYm9uZU5hbWUpKSB7XG4gICAgICAgICAgY29uc3QgY3VycmVudCA9IHRoaXMuX3RhcmdldFZNRC5nZXRCb25lRnJhbWUodGhpcy5fZnJhbWUsIGJvbmVOYW1lKTtcbiAgICAgICAgICAoPFBNWEJvbmVUcmFuc2Zvcm1lcj5ib25lLlRyYW5zZm9ybWVyKS51c2VyVHJhbnNsYXRpb24gPSBuZXcgVmVjdG9yMyhjdXJyZW50LnBvc2l0aW9uKTtcbiAgICAgICAgICAoPFBNWEJvbmVUcmFuc2Zvcm1lcj5ib25lLlRyYW5zZm9ybWVyKS51c2VyUm90YXRpb24gPSBuZXcgUXVhdGVybmlvbihjdXJyZW50LnJvdGF0aW9uKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgZm9yIChsZXQgbW9ycGhOYW1lIGluIHRoaXMuX3RhcmdldFZNRC5Nb3JwaHMpIHtcbiAgICAgICAgbGV0IG1vcnBoOiBQTVhNb3JwaDtcbiAgICAgICAgaWYgKG1vcnBoID0gdGhpcy5fdGFyZ2V0UE1YLlBNWE1vZGVsLk1vcnBoTWFuYWdlci5nZXRNb3JwaEJ5TmFtZShtb3JwaE5hbWUpKSB7XG4gICAgICAgICAgY29uc3QgbW9ycGhDdXJyZW50ID0gdGhpcy5fdGFyZ2V0Vk1ELmdldE1vcnBoRnJhbWUodGhpcy5fZnJhbWUsIG1vcnBoTmFtZSk7XG4gICAgICAgICAgaWYgKG1vcnBoKSB7XG4gICAgICAgICAgICBtb3JwaC5Qcm9ncmVzcyA9IG1vcnBoQ3VycmVudC52YWx1ZTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGF0dHIuZG9uZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhdHRyLmRvbmUoKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgVk1ETm9kZTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==

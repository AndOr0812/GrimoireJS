import AsyncLoader from "../../Core/Resources/AsyncLoader";
import { quat } from "gl-matrix";
import BezierCurve from "./BezierCurve";
import Q from "q";
class VMDData {
    constructor(data) {
        this._offset = 0;
        this._reader = new DataView(data, 0, data.byteLength);
        this._loadHeader();
        this._loadMotion();
        this._loadMorph();
    }
    static loadFromUrl(url) {
        return VMDData._asyncLoader.fetch(url, (path) => {
            const d = Q.defer();
            const oReq = new XMLHttpRequest();
            oReq.open("GET", path, true);
            oReq.setRequestHeader("Accept", "*/*");
            oReq.responseType = "arraybuffer";
            oReq.onload = () => {
                const data = new VMDData(oReq.response);
                d.resolve(data);
            };
            oReq.onerror = (err) => {
                d.reject(err);
            };
            oReq.send(null);
            return d.promise;
        });
    }
    get Motions() {
        return this._motions;
    }
    get Morphs() {
        return this._morphs;
    }
    getBoneFrame(frame, boneName) {
        const frames = this._motions[boneName];
        if (typeof frames === "undefined") {
            return null;
        }
        else {
            const index = this._binaryframeSearch(frames, frame);
            if (index + 1 < frames.length) {
                const nextFrame = frames[index + 1];
                const currentFrame = frames[index];
                const progress = (frame - currentFrame.frameNumber) / (nextFrame.frameNumber - currentFrame.frameNumber);
                return {
                    frameNumber: frame,
                    position: this._complementBoneTranslation(currentFrame.position, nextFrame.position, progress, currentFrame.interpolation),
                    rotation: quat.slerp([0, 0, 0, 0], currentFrame.rotation, nextFrame.rotation, currentFrame.interpolation[3].evaluate(progress))
                };
            }
            else {
                return {
                    frameNumber: frame,
                    position: frames[index].position,
                    rotation: frames[index].rotation
                };
            }
        }
    }
    getMorphFrame(frame, morphName) {
        const frames = this._morphs[morphName];
        if (typeof frames === "undefined") {
            return null;
        }
        else {
            const index = this._binaryframeSearch(frames, frame);
            if (index + 1 < frames.length) {
                const nextFrame = frames[index + 1];
                const currentFrame = frames[index];
                const progress = (frame - currentFrame.frameNumber) / (nextFrame.frameNumber - currentFrame.frameNumber);
                return {
                    frameNumber: frame,
                    value: currentFrame.morphValue + (nextFrame.morphValue - currentFrame.morphValue) * progress,
                };
            }
            else {
                return {
                    frameNumber: frame,
                    value: frames[index].morphValue,
                };
            }
        }
    }
    _loadHeader() {
        this._header
            = {
                header: this._loadString(30),
                modelName: this._loadString(20)
            };
    }
    _loadMotion() {
        this._motions = {};
        const frameCount = this._readUint32();
        for (let i = 0; i < frameCount; i++) {
            const frameName = this._loadString(15);
            const data = {
                frameNumber: this._readUint32(),
                position: [this._readFloat32(), this._readFloat32(), -this._readFloat32()],
                rotation: [-this._readFloat32(), -this._readFloat32(), this._readFloat32(), this._readFloat32()],
                interpolation: this._loadInterpolation()
            };
            if (typeof this._motions[frameName] === "undefined") {
                this._motions[frameName] = [];
            }
            this._motions[frameName].push(data);
        }
        for (let motion in this._motions) {
            this._motions[motion].sort((i1, i2) => i1.frameNumber - i2.frameNumber);
        }
    }
    _loadMorph() {
        this._morphs = {};
        const frameCount = this._readUint32();
        for (let i = 0; i < frameCount; i++) {
            const frameName = this._loadString(15);
            const data = {
                frameNumber: this._readUint32(),
                morphValue: this._readFloat32()
            };
            if (typeof this._morphs[frameName] === "undefined") {
                this._morphs[frameName] = [];
            }
            this._morphs[frameName].push(data);
        }
        for (let morph in this._morphs) {
            this._morphs[morph].sort((i1, i2) => i1.frameNumber - i2.frameNumber);
        }
    }
    _loadBytes(byteLength) {
        let isPadding = false;
        const arr = [];
        for (let i = 0; i < byteLength; i++) {
            const current = this._readUint8();
            if (current === 0x00) {
                isPadding = true;
            }
            if (!isPadding) {
                arr.push(current);
            }
        }
        return new Uint8Array(arr);
    }
    _loadString(length) {
        const decoder = new TextDecoder("shift-jis");
        return decoder.decode(this._loadBytes(length));
    }
    _loadInterpolation() {
        const interpolation = new Array(4);
        for (let i = 0; i < 4; i++) {
            interpolation[i] = new Array(4);
            for (let j = 0; j < 4; j++) {
                interpolation[i][j] = new Array(4);
            }
        }
        for (let i = 0; i < 4; i++) {
            for (let j = 0; j < 4; j++) {
                for (let k = 0; k < 4; k++) {
                    interpolation[i][j][k] = this._readUint8();
                }
            }
        }
        const result = new Array(4);
        for (let i = 0; i < 4; i++) {
            result[i] = new BezierCurve(interpolation[0][0][i] / 128.0, interpolation[0][1][i] / 128.0, interpolation[0][2][i] / 128.0, interpolation[0][3][i] / 128);
        }
        return result;
    }
    _binaryframeSearch(source, frame) {
        let minIndex = 0;
        let maxIndex = source.length - 1;
        let currentIndex = -1;
        let currentElement;
        if (source.length === 1) {
            return 0;
        }
        while (minIndex <= maxIndex) {
            currentIndex = (minIndex + maxIndex) / 2 | 0;
            currentElement = source[currentIndex];
            if (currentElement.frameNumber < frame) {
                if (currentIndex + 1 < source.length && source[currentIndex + 1].frameNumber > frame) {
                    return currentIndex;
                }
                minIndex = currentIndex + 1;
            }
            else if (currentElement.frameNumber > frame) {
                maxIndex = currentIndex - 1;
                if (currentIndex - 1 >= 0 && source[currentIndex - 1].frameNumber < frame) {
                    return currentIndex - 1;
                }
            }
            else {
                return currentIndex;
            }
        }
        return currentIndex;
    }
    _complementBoneTranslation(begin, end, progress, bezierCurves) {
        const result = [0, 0, 0]; // TODO optimize this
        for (let i = 0; i < 3; i++) {
            result[i] = begin[i] + (end[i] - begin[i]) * bezierCurves[i].evaluate(progress);
        }
        return result;
    }
    _readUint8() {
        const result = this._reader.getUint8(this._offset);
        this._offset += 1;
        return result;
    }
    _readUint32() {
        const result = this._reader.getUint32(this._offset, true);
        this._offset += 4;
        return result;
    }
    _readFloat32() {
        const result = this._reader.getFloat32(this._offset, true);
        this._offset += 4;
        return result;
    }
}
VMDData._asyncLoader = new AsyncLoader();
export default VMDData;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlZNRC9QYXJzZXIvVk1ERGF0YS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiT0FBTyxXQUFXLE1BQU0sa0NBQWtDO09BT25ELEVBQUMsSUFBSSxFQUFDLE1BQU0sV0FBVztPQUN2QixXQUFXLE1BQU0sZUFBZTtPQUNoQyxDQUFDLE1BQU0sR0FBRztBQUVqQjtJQWNFLFlBQVksSUFBaUI7UUFGckIsWUFBTyxHQUFXLENBQUMsQ0FBQztRQUcxQixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3RELElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNuQixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQ3BCLENBQUM7SUFFRCxPQUFjLFdBQVcsQ0FBQyxHQUFXO1FBQ25DLE1BQU0sQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJO1lBQzFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQVcsQ0FBQztZQUM3QixNQUFNLElBQUksR0FBRyxJQUFJLGNBQWMsRUFBRSxDQUFDO1lBQ2xDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztZQUM3QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3ZDLElBQUksQ0FBQyxZQUFZLEdBQUcsYUFBYSxDQUFDO1lBQ2xDLElBQUksQ0FBQyxNQUFNLEdBQUc7Z0JBQ1osTUFBTSxJQUFJLEdBQUcsSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUN4QyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2xCLENBQUMsQ0FBQztZQUNGLElBQUksQ0FBQyxPQUFPLEdB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a1AvRTtBQUVELGVBQWUsT0FBTyxDQUFDIiwiZmlsZSI6IlZNRC9QYXJzZXIvVk1ERGF0YS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBBc3luY0xvYWRlciBmcm9tIFwiLi4vLi4vQ29yZS9SZXNvdXJjZXMvQXN5bmNMb2FkZXJcIjtcbmltcG9ydCBWTURIZWFkZXIgZnJvbSBcIi4vVk1ESGVhZGVyXCI7XG5pbXBvcnQgVk1ETW90aW9ucyBmcm9tIFwiLi9WTURNb3Rpb25zXCI7XG5pbXBvcnQgVk1ETW9ycGhzIGZyb20gXCIuL1ZNRE1vcnBoc1wiO1xuaW1wb3J0IFZNREZyYW1lRGF0YSBmcm9tIFwiLi9WTURGcmFtZURhdGFcIjtcbmltcG9ydCBWTURCb25lU3RhdHVzIGZyb20gXCIuL1ZNREJvbmVTdGF0dXNcIjtcbmltcG9ydCBWTURNb3JwaFN0YXR1cyBmcm9tIFwiLi9WTURNb3JwaFN0YXR1c1wiO1xuaW1wb3J0IHtxdWF0fSBmcm9tIFwiZ2wtbWF0cml4XCI7XG5pbXBvcnQgQmV6aWVyQ3VydmUgZnJvbSBcIi4vQmV6aWVyQ3VydmVcIjtcbmltcG9ydCBRIGZyb20gXCJxXCI7XG5cbmNsYXNzIFZNRERhdGEge1xuXG4gIHByaXZhdGUgc3RhdGljIF9hc3luY0xvYWRlcjogQXN5bmNMb2FkZXI8Vk1ERGF0YT4gPSBuZXcgQXN5bmNMb2FkZXI8Vk1ERGF0YT4oKTtcblxuICBwcml2YXRlIF9yZWFkZXI6IERhdGFWaWV3O1xuXG4gIHByaXZhdGUgX2hlYWRlcjogVk1ESGVhZGVyO1xuXG4gIHByaXZhdGUgX21vdGlvbnM6IFZNRE1vdGlvbnM7XG5cbiAgcHJpdmF0ZSBfbW9ycGhzOiBWTURNb3JwaHM7XG5cbiAgcHJpdmF0ZSBfb2Zmc2V0OiBudW1iZXIgPSAwO1xuXG4gIGNvbnN0cnVjdG9yKGRhdGE6IEFycmF5QnVmZmVyKSB7XG4gICAgdGhpcy5fcmVhZGVyID0gbmV3IERhdGFWaWV3KGRhdGEsIDAsIGRhdGEuYnl0ZUxlbmd0aCk7XG4gICAgdGhpcy5fbG9hZEhlYWRlcigpO1xuICAgIHRoaXMuX2xvYWRNb3Rpb24oKTtcbiAgICB0aGlzLl9sb2FkTW9ycGgoKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgbG9hZEZyb21VcmwodXJsOiBzdHJpbmcpOiBRLklQcm9taXNlPFZNRERhdGE+IHtcbiAgICByZXR1cm4gVk1ERGF0YS5fYXN5bmNMb2FkZXIuZmV0Y2godXJsLCAocGF0aCkgPT4ge1xuICAgICAgY29uc3QgZCA9IFEuZGVmZXI8Vk1ERGF0YT4oKTtcbiAgICAgIGNvbnN0IG9SZXEgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICAgIG9SZXEub3BlbihcIkdFVFwiLCBwYXRoLCB0cnVlKTtcbiAgICAgIG9SZXEuc2V0UmVxdWVzdEhlYWRlcihcIkFjY2VwdFwiLCBcIiovKlwiKTtcbiAgICAgIG9SZXEucmVzcG9uc2VUeXBlID0gXCJhcnJheWJ1ZmZlclwiO1xuICAgICAgb1JlcS5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBuZXcgVk1ERGF0YShvUmVxLnJlc3BvbnNlKTtcbiAgICAgICAgZC5yZXNvbHZlKGRhdGEpO1xuICAgICAgfTtcbiAgICAgIG9SZXEub25lcnJvciA9IChlcnIpID0+IHtcbiAgICAgICAgZC5yZWplY3QoZXJyKTtcbiAgICAgIH07XG4gICAgICBvUmVxLnNlbmQobnVsbCk7XG4gICAgICByZXR1cm4gZC5wcm9taXNlO1xuICAgIH0pO1xuICB9XG5cblxuICBwdWJsaWMgZ2V0IE1vdGlvbnMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX21vdGlvbnM7XG4gIH1cblxuICBwdWJsaWMgZ2V0IE1vcnBocygpIHtcbiAgICByZXR1cm4gdGhpcy5fbW9ycGhzO1xuICB9XG5cbiAgcHVibGljIGdldEJvbmVGcmFtZShmcmFtZTogbnVtYmVyLCBib25lTmFtZTogc3RyaW5nKTogVk1EQm9uZVN0YXR1cyB7XG4gICAgY29uc3QgZnJhbWVzID0gdGhpcy5fbW90aW9uc1tib25lTmFtZV07XG4gICAgaWYgKHR5cGVvZiBmcmFtZXMgPT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBpbmRleCA9IHRoaXMuX2JpbmFyeWZyYW1lU2VhcmNoKGZyYW1lcywgZnJhbWUpO1xuICAgICAgaWYgKGluZGV4ICsgMSA8IGZyYW1lcy5sZW5ndGgpIHtcbiAgICAgICAgY29uc3QgbmV4dEZyYW1lID0gZnJhbWVzW2luZGV4ICsgMV07XG4gICAgICAgIGNvbnN0IGN1cnJlbnRGcmFtZSA9IGZyYW1lc1tpbmRleF07XG4gICAgICAgIGNvbnN0IHByb2dyZXNzID0gKGZyYW1lIC0gY3VycmVudEZyYW1lLmZyYW1lTnVtYmVyKSAvIChuZXh0RnJhbWUuZnJhbWVOdW1iZXIgLSBjdXJyZW50RnJhbWUuZnJhbWVOdW1iZXIpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGZyYW1lTnVtYmVyOiBmcmFtZSxcbiAgICAgICAgICBwb3NpdGlvbjogdGhpcy5fY29tcGxlbWVudEJvbmVUcmFuc2xhdGlvbihjdXJyZW50RnJhbWUucG9zaXRpb24sIG5leHRGcmFtZS5wb3NpdGlvbiwgcHJvZ3Jlc3MsIGN1cnJlbnRGcmFtZS5pbnRlcnBvbGF0aW9uKSxcbiAgICAgICAgICByb3RhdGlvbjogPG51bWJlcltdPnF1YXQuc2xlcnAoWzAsIDAsIDAsIDBdLCBjdXJyZW50RnJhbWUucm90YXRpb24sIG5leHRGcmFtZS5yb3RhdGlvbiwgY3VycmVudEZyYW1lLmludGVycG9sYXRpb25bM10uZXZhbHVhdGUocHJvZ3Jlc3MpKVxuICAgICAgICB9O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBmcmFtZU51bWJlcjogZnJhbWUsXG4gICAgICAgICAgcG9zaXRpb246IGZyYW1lc1tpbmRleF0ucG9zaXRpb24sXG4gICAgICAgICAgcm90YXRpb246IGZyYW1lc1tpbmRleF0ucm90YXRpb25cbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZ2V0TW9ycGhGcmFtZShmcmFtZTogbnVtYmVyLCBtb3JwaE5hbWU6IHN0cmluZyk6IFZNRE1vcnBoU3RhdHVzIHtcbiAgICBjb25zdCBmcmFtZXMgPSB0aGlzLl9tb3JwaHNbbW9ycGhOYW1lXTtcbiAgICBpZiAodHlwZW9mIGZyYW1lcyA9PT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5fYmluYXJ5ZnJhbWVTZWFyY2goZnJhbWVzLCBmcmFtZSk7XG4gICAgICBpZiAoaW5kZXggKyAxIDwgZnJhbWVzLmxlbmd0aCkge1xuICAgICAgICBjb25zdCBuZXh0RnJhbWUgPSBmcmFtZXNbaW5kZXggKyAxXTtcbiAgICAgICAgY29uc3QgY3VycmVudEZyYW1lID0gZnJhbWVzW2luZGV4XTtcbiAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSAoZnJhbWUgLSBjdXJyZW50RnJhbWUuZnJhbWVOdW1iZXIpIC8gKG5leHRGcmFtZS5mcmFtZU51bWJlciAtIGN1cnJlbnRGcmFtZS5mcmFtZU51bWJlcik7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgZnJhbWVOdW1iZXI6IGZyYW1lLFxuICAgICAgICAgIHZhbHVlOiBjdXJyZW50RnJhbWUubW9ycGhWYWx1ZSArIChuZXh0RnJhbWUubW9ycGhWYWx1ZSAtIGN1cnJlbnRGcmFtZS5tb3JwaFZhbHVlKSAqIHByb2dyZXNzLFxuICAgICAgICB9O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBmcmFtZU51bWJlcjogZnJhbWUsXG4gICAgICAgICAgdmFsdWU6IGZyYW1lc1tpbmRleF0ubW9ycGhWYWx1ZSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuXG4gIHByaXZhdGUgX2xvYWRIZWFkZXIoKTogdm9pZCB7XG4gICAgdGhpcy5faGVhZGVyXG4gICAgPSB7XG4gICAgICBoZWFkZXI6IHRoaXMuX2xvYWRTdHJpbmcoMzApLFxuICAgICAgbW9kZWxOYW1lOiB0aGlzLl9sb2FkU3RyaW5nKDIwKVxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIF9sb2FkTW90aW9uKCk6IHZvaWQge1xuICAgIHRoaXMuX21vdGlvbnMgPSB7fTtcbiAgICBjb25zdCBmcmFtZUNvdW50ID0gdGhpcy5fcmVhZFVpbnQzMigpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZnJhbWVDb3VudDsgaSsrKSB7XG4gICAgICBjb25zdCBmcmFtZU5hbWUgPSB0aGlzLl9sb2FkU3RyaW5nKDE1KTtcbiAgICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICAgIGZyYW1lTnVtYmVyOiB0aGlzLl9yZWFkVWludDMyKCksXG4gICAgICAgIHBvc2l0aW9uOiBbdGhpcy5fcmVhZEZsb2F0MzIoKSwgdGhpcy5fcmVhZEZsb2F0MzIoKSwgLXRoaXMuX3JlYWRGbG9hdDMyKCldLFxuICAgICAgICByb3RhdGlvbjogWy10aGlzLl9yZWFkRmxvYXQzMigpLCAtdGhpcy5fcmVhZEZsb2F0MzIoKSwgdGhpcy5fcmVhZEZsb2F0MzIoKSwgdGhpcy5fcmVhZEZsb2F0MzIoKV0sXG4gICAgICAgIGludGVycG9sYXRpb246IHRoaXMuX2xvYWRJbnRlcnBvbGF0aW9uKClcbiAgICAgIH07XG4gICAgICBpZiAodHlwZW9mIHRoaXMuX21vdGlvbnNbZnJhbWVOYW1lXSA9PT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgICB0aGlzLl9tb3Rpb25zW2ZyYW1lTmFtZV0gPSBbXTtcbiAgICAgIH1cbiAgICAgIHRoaXMuX21vdGlvbnNbZnJhbWVOYW1lXS5wdXNoKGRhdGEpO1xuICAgIH1cbiAgICBmb3IgKGxldCBtb3Rpb24gaW4gdGhpcy5fbW90aW9ucykgeyAvLyBzb3J0IGVhY2ggYm9uZSBmcmFtZXNcbiAgICAgIHRoaXMuX21vdGlvbnNbbW90aW9uXS5zb3J0KChpMSwgaTIpID0+IGkxLmZyYW1lTnVtYmVyIC0gaTIuZnJhbWVOdW1iZXIpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX2xvYWRNb3JwaCgpOiB2b2lkIHtcbiAgICB0aGlzLl9tb3JwaHMgPSB7fTtcbiAgICBjb25zdCBmcmFtZUNvdW50ID0gdGhpcy5fcmVhZFVpbnQzMigpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZnJhbWVDb3VudDsgaSsrKSB7XG4gICAgICBjb25zdCBmcmFtZU5hbWUgPSB0aGlzLl9sb2FkU3RyaW5nKDE1KTtcbiAgICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICAgIGZyYW1lTnVtYmVyOiB0aGlzLl9yZWFkVWludDMyKCksXG4gICAgICAgIG1vcnBoVmFsdWU6IHRoaXMuX3JlYWRGbG9hdDMyKClcbiAgICAgIH07XG4gICAgICBpZiAodHlwZW9mIHRoaXMuX21vcnBoc1tmcmFtZU5hbWVdID09PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICAgIHRoaXMuX21vcnBoc1tmcmFtZU5hbWVdID0gW107XG4gICAgICB9XG4gICAgICB0aGlzLl9tb3JwaHNbZnJhbWVOYW1lXS5wdXNoKGRhdGEpO1xuICAgIH1cbiAgICBmb3IgKGxldCBtb3JwaCBpbiB0aGlzLl9tb3JwaHMpIHtcbiAgICAgIHRoaXMuX21vcnBoc1ttb3JwaF0uc29ydCgoaTEsIGkyKSA9PiBpMS5mcmFtZU51bWJlciAtIGkyLmZyYW1lTnVtYmVyKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9sb2FkQnl0ZXMoYnl0ZUxlbmd0aDogbnVtYmVyKTogVWludDhBcnJheSB7XG4gICAgbGV0IGlzUGFkZGluZyA9IGZhbHNlO1xuICAgIGNvbnN0IGFyciA9IFtdO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYnl0ZUxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBjdXJyZW50ID0gdGhpcy5fcmVhZFVpbnQ4KCk7XG4gICAgICBpZiAoY3VycmVudCA9PT0gMHgwMCkge1xuICAgICAgICBpc1BhZGRpbmcgPSB0cnVlO1xuICAgICAgfVxuICAgICAgaWYgKCFpc1BhZGRpbmcpIHtcbiAgICAgICAgYXJyLnB1c2goY3VycmVudCk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBuZXcgVWludDhBcnJheShhcnIpO1xuICB9XG5cbiAgcHJpdmF0ZSBfbG9hZFN0cmluZyhsZW5ndGg6IG51bWJlcik6IGFueSB7XG4gICAgY29uc3QgZGVjb2RlciA9IG5ldyBUZXh0RGVjb2RlcihcInNoaWZ0LWppc1wiKTtcbiAgICByZXR1cm4gZGVjb2Rlci5kZWNvZGUodGhpcy5fbG9hZEJ5dGVzKGxlbmd0aCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBfbG9hZEludGVycG9sYXRpb24oKTogQmV6aWVyQ3VydmVbXSB7XG4gICAgY29uc3QgaW50ZXJwb2xhdGlvbiA9IG5ldyBBcnJheSg0KTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykge1xuICAgICAgaW50ZXJwb2xhdGlvbltpXSA9IG5ldyBBcnJheSg0KTtcbiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgNDsgaisrKSB7XG4gICAgICAgIGludGVycG9sYXRpb25baV1bal0gPSBuZXcgQXJyYXkoNCk7XG4gICAgICB9XG4gICAgfVxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB7XG4gICAgICBmb3IgKGxldCBqID0gMDsgaiA8IDQ7IGorKykge1xuICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IDQ7IGsrKykge1xuICAgICAgICAgIGludGVycG9sYXRpb25baV1bal1ba10gPSB0aGlzLl9yZWFkVWludDgoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXkoNCk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHtcbiAgICAgIHJlc3VsdFtpXSA9IG5ldyBCZXppZXJDdXJ2ZShpbnRlcnBvbGF0aW9uWzBdWzBdW2ldIC8gMTI4LjAsIGludGVycG9sYXRpb25bMF1bMV1baV0gLyAxMjguMCwgaW50ZXJwb2xhdGlvblswXVsyXVtpXSAvIDEyOC4wLCBpbnRlcnBvbGF0aW9uWzBdWzNdW2ldIC8gMTI4KTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHByaXZhdGUgX2JpbmFyeWZyYW1lU2VhcmNoKHNvdXJjZTogVk1ERnJhbWVEYXRhW10sIGZyYW1lOiBudW1iZXIpOiBudW1iZXIge1xuICAgIGxldCBtaW5JbmRleCA9IDA7XG4gICAgbGV0IG1heEluZGV4ID0gc291cmNlLmxlbmd0aCAtIDE7XG4gICAgbGV0IGN1cnJlbnRJbmRleCA9IC0xO1xuICAgIGxldCBjdXJyZW50RWxlbWVudDogVk1ERnJhbWVEYXRhO1xuICAgIGlmIChzb3VyY2UubGVuZ3RoID09PSAxKSB7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG4gICAgd2hpbGUgKG1pbkluZGV4IDw9IG1heEluZGV4KSB7XG4gICAgICBjdXJyZW50SW5kZXggPSAobWluSW5kZXggKyBtYXhJbmRleCkgLyAyIHwgMDtcbiAgICAgIGN1cnJlbnRFbGVtZW50ID0gc291cmNlW2N1cnJlbnRJbmRleF07XG5cbiAgICAgIGlmIChjdXJyZW50RWxlbWVudC5mcmFtZU51bWJlciA8IGZyYW1lKSB7XG4gICAgICAgIGlmIChjdXJyZW50SW5kZXggKyAxIDwgc291cmNlLmxlbmd0aCAmJiBzb3VyY2VbY3VycmVudEluZGV4ICsgMV0uZnJhbWVOdW1iZXIgPiBmcmFtZSkge1xuICAgICAgICAgIHJldHVybiBjdXJyZW50SW5kZXg7XG4gICAgICAgIH1cbiAgICAgICAgbWluSW5kZXggPSBjdXJyZW50SW5kZXggKyAxO1xuICAgICAgfSBlbHNlIGlmIChjdXJyZW50RWxlbWVudC5mcmFtZU51bWJlciA+IGZyYW1lKSB7XG4gICAgICAgIG1heEluZGV4ID0gY3VycmVudEluZGV4IC0gMTtcbiAgICAgICAgaWYgKGN1cnJlbnRJbmRleCAtIDEgPj0gMCAmJiBzb3VyY2VbY3VycmVudEluZGV4IC0gMV0uZnJhbWVOdW1iZXIgPCBmcmFtZSkge1xuICAgICAgICAgIHJldHVybiBjdXJyZW50SW5kZXggLSAxO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gY3VycmVudEluZGV4O1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gY3VycmVudEluZGV4O1xuICB9XG5cblxuICBwcml2YXRlIF9jb21wbGVtZW50Qm9uZVRyYW5zbGF0aW9uKGJlZ2luOiBudW1iZXJbXSwgZW5kOiBudW1iZXJbXSwgcHJvZ3Jlc3M6IG51bWJlciwgYmV6aWVyQ3VydmVzOiBCZXppZXJDdXJ2ZVtdKTogbnVtYmVyW10ge1xuICAgIGNvbnN0IHJlc3VsdCA9IFswLCAwLCAwXTsgLy8gVE9ETyBvcHRpbWl6ZSB0aGlzXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCAzOyBpKyspIHtcbiAgICAgIHJlc3VsdFtpXSA9IGJlZ2luW2ldICsgKGVuZFtpXSAtIGJlZ2luW2ldKSAqIGJlemllckN1cnZlc1tpXS5ldmFsdWF0ZShwcm9ncmVzcyk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuXG4gIHByaXZhdGUgX3JlYWRVaW50OCgpOiBudW1iZXIge1xuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuX3JlYWRlci5nZXRVaW50OCh0aGlzLl9vZmZzZXQpO1xuICAgIHRoaXMuX29mZnNldCArPSAxO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBwcml2YXRlIF9yZWFkVWludDMyKCk6IG51bWJlciB7XG4gICAgY29uc3QgcmVzdWx0ID0gdGhpcy5fcmVhZGVyLmdldFVpbnQzMih0aGlzLl9vZmZzZXQsIHRydWUpO1xuICAgIHRoaXMuX29mZnNldCArPSA0O1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBwcml2YXRlIF9yZWFkRmxvYXQzMigpOiBudW1iZXIge1xuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuX3JlYWRlci5nZXRGbG9hdDMyKHRoaXMuX29mZnNldCwgdHJ1ZSk7XG4gICAgdGhpcy5fb2Zmc2V0ICs9IDQ7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBWTUREYXRhO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9

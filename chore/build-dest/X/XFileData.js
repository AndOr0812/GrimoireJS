import ImageLoader from "../Core/Resources/ImageLoader";
import Vector3 from "../Math/Vector3";
import Vector4 from "../Math/Vector4";
import AsyncLoader from "../Core/Resources/AsyncLoader";
import Q from "q";
class XFileData {
    constructor(dataSource, directory) {
        this.materials = [];
        this._dataSource = dataSource;
        this._directory = directory;
        const meshSection = this._sliceSection(dataSource, "Mesh", 0);
        const meshMaterialSection = this._sliceSection(meshSection, "MeshMaterialList", 0);
        this._parsePositions(meshSection);
        this._parseTexCoords(this._sliceSection(meshSection, "MeshTextureCoords", 0));
        this._parseMaterials(meshMaterialSection);
        this._parseFaces(meshSection, meshMaterialSection);
        this._generateNormals();
        this._prepareForUsing();
    }
    static loadFile(src) {
        const directory = src.substr(0, src.lastIndexOf("/") + 1);
        return this._loader.fetch(src, (absPath) => {
            const deferred = Q.defer();
            const xhr = new XMLHttpRequest();
            xhr.open("GET", absPath, true);
            xhr.setRequestHeader("Accept", "text");
            xhr.onload = () => {
                deferred.resolve(new XFileData(xhr.responseText, directory));
            };
            xhr.onerror = (err) => {
                deferred.reject(err);
            };
            xhr.send(null);
            return deferred.promise;
        });
    }
    _sliceSection(source, sectionName, offset) {
        const regex = new RegExp(`([^{template}]\\s+)${sectionName}\\s*\\{`, "g");
        let found = regex.exec(source);
        for (let i = 0; i < offset; i++) {
            found = regex.exec(source);
        }
        if (!found) {
            return undefined;
        }
        let bracketCount = 0;
        let index = found.index;
        while (true) {
            const nextEndBlacket = source.indexOf("}", index);
            const nextBeginBlacket = source.indexOf("{", index);
            if (nextEndBlacket < 0 && nextBeginBlacket < 0) {
                throw new Error("Unmatch blacket!!");
            }
            if (nextBeginBlacket < 0) {
                // This means this blacket is end of this section
                index = nextEndBlacket + 1;
                break;
            }
            else if (nextBeginBlacket < nextEndBlacket) {
                index = nextBeginBlacket + 1;
                bracketCount++;
            }
            else {
                index = nextEndBlacket + 1;
                bracketCount--;
            }
            if (bracketCount === 0) {
                break;
            }
        }
        return source.substring(found.index + found[1].length, index);
    }
    _parsePositions(meshSection) {
        const positionRegex = /([-\.\d]+);\s*([-\.\d]+);\s*([-\.\d]+);\s*/g;
        let regexResult;
        let positionCache = [];
        while ((regexResult = positionRegex.exec(meshSection))) {
            positionCache.push(parseFloat(regexResult[1]), parseFloat(regexResult[2]), parseFloat(regexResult[3]));
        }
        this.positions = new Float32Array(positionCache);
    }
    _parseFaces(meshSection, meshMaterialListSection) {
        const faceRegex = /[34];(\d+),(\d+),(\d+)(?:,(\d+))?;/g;
        let faceRegexResult;
        let faceCache = [];
        const materialIndexRegex = /(\d+)/g;
        let materialGroupCount = parseInt(materialIndexRegex.exec(meshMaterialListSection)[1], 10);
        const matIndiciesCount = parseInt(materialIndexRegex.exec(meshMaterialListSection)[1], 10);
        for (let i = 0; i < materialGroupCount; i++) {
            faceCache[i] = [];
        }
        for (let i = 0; i < matIndiciesCount; i++) {
            faceRegexResult = faceRegex.exec(meshSection);
            const materialIndex = parseInt(materialIndexRegex.exec(meshMaterialListSection)[1], 10);
            if (faceRegexResult[4]) {
                const f1 = parseInt(faceRegexResult[1], 10), f2 = parseInt(faceRegexResult[2], 10), f3 = parseInt(faceRegexResult[3], 10), f4 = parseInt(faceRegexResult[4], 10);
                faceCache[materialIndex].push(f1, f2, f4, f2, f3, f4);
            }
            else {
                faceCache[materialIndex].push(parseInt(faceRegexResult[1], 10), parseInt(faceRegexResult[2], 10), parseInt(faceRegexResult[3], 10));
            }
        }
        // Reduce unused materials
        for (let i = 0; i < faceCache.length; i++) {
            if (faceCache[i].length === 0) {
                faceCache.splice(i, 1);
                this.materials.splice(i, 1);
                i--;
            }
        }
        // Set face count for materials
        let offset = 0;
        for (let i = 0; i < faceCache.length; i++) {
            this.materials[i].indexOffset = offset;
            offset += this.materials[i].indexCount = faceCache[i].length;
        }
        // Concat face Array
        let concattedFaceArray = [];
        for (let i = 0; i < faceCache.length; i++) {
            concattedFaceArray = concattedFaceArray.concat(faceCache[i]);
        }
        this.indicies = new Uint32Array(concattedFaceArray);
    }
    _parseMaterials(meshMaterialSection) {
        let materialSection;
        let materialIndex = 0;
        while ((materialSection = this._sliceSection(meshMaterialSection, "Material", materialIndex))) {
            const numberRegex = /([-\.\d]+);/;
            const foundNumbers = new Array(11);
            for (let i = 0; i < 11; i++) {
                const regexResult = numberRegex.exec(materialSection);
                foundNumbers[i] = parseFloat(regexResult[1]);
            }
            const textureSection = this._sliceSection(materialSection, "TextureFilename", 0);
            let texturePath;
            if (textureSection) {
                texturePath = /"([^"]+)"/.exec(textureSection)[1].replace(/\\/g, "/");
                texturePath = texturePath.replace(".tga", ".tga.png");
            }
            this.materials[materialIndex] = {
                faceColor: new Vector4(foundNumbers[0], foundNumbers[1], foundNumbers[2], foundNumbers[3]),
                power: foundNumbers[4],
                specularColor: new Vector3(foundNumbers[5], foundNumbers[6], foundNumbers[7]),
                emissiveColor: new Vector3(foundNumbers[8], foundNumbers[9], foundNumbers[10]),
                texture: texturePath ? this._directory + texturePath : undefined,
                indexCount: undefined,
                indexOffset: undefined
            };
            materialIndex++;
        }
    }
    _parseTexCoords(meshTextureSection) {
        const texCoordRegex = /([-\.\d]+);([-\.\d]+);/g;
        let regexResult;
        let texCoordCache = [];
        while ((regexResult = texCoordRegex.exec(meshTextureSection))) {
            texCoordCache.push(parseFloat(regexResult[1]), parseFloat(regexResult[2]));
        }
        this.texCoords = new Float32Array(texCoordCache);
    }
    _prepareForUsing() {
        // Load textures
        for (let i = 0; i < this.materials.length; i++) {
            if (this.materials[i].texture) {
                ImageLoader.loadImage(this.materials[i].texture);
            }
        }
    }
    _generateNormals() {
        let normalCache = [];
        for (let i = 0; i < this.indicies.length; i += 3) {
            const f1i = this.indicies[i];
            const f2i = this.indicies[i + 1];
            const f3i = this.indicies[i + 2];
            const normal = this._generateNormal(f1i, f2i, f3i);
            normalCache[3 * f1i] = normalCache[3 * f2i] = normalCache[3 * f3i] = normal[0];
            normalCache[3 * f1i + 1] = normalCache[3 * f2i + 1] = normalCache[3 * f3i + 1] = normal[1];
            normalCache[3 * f1i + 2] = normalCache[3 * f2i + 2] = normalCache[3 * f3i + 2] = normal[2];
        }
        this.normals = new Float32Array(normalCache);
    }
    _generateNormal(p1Index, p2Index, p3Index) {
        const p1x = this.positions[3 * p1Index];
        const p1y = this.positions[3 * p1Index + 1];
        const p1z = this.positions[3 * p1Index + 2];
        const p2x = this.positions[3 * p2Index];
        const p2y = this.positions[3 * p2Index + 1];
        const p2z = this.positions[3 * p2Index + 2];
        const p3x = this.positions[3 * p3Index];
        const p3y = this.positions[3 * p3Index + 1];
        const p3z = this.positions[3 * p3Index + 2];
        const ret = [(p2y - p1y) * (p3z - p1z) - (p2z - p1z) * (p3y - p1y),
            (p2z - p1z) * (p3x - p1x) - (p2x - p1x) * (p3z - p1z),
            (p2x - p1x) * (p3y - p1y) - (p2y - p1y) * (p3x - p1x)];
        const length = Math.sqrt(ret[0] * ret[0] + ret[1] * ret[1] + ret[2] * ret[2]);
        ret[0] /= length;
        ret[1] /= length;
        ret[2] /= length;
        return ret;
    }
}
XFileData._loader = new AsyncLoader();
export default XFileData;

//# sourceMappingURL=data:application/json;base64,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QUcsR0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQy9FLFdBQVcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMzRixXQUFXLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxXQUFXLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxXQUFXLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDN0YsQ0FBQztRQUNELElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxZQUFZLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUVPLGVBQWUsQ0FBQyxPQUFlLEVBQUUsT0FBZSxFQUFFLE9BQWU7UUFDdkUsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEdBQUcsT0FBTyxDQUFDLENBQUM7UUFBQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxPQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFBQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxPQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDbEksTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEdBQUcsT0FBTyxDQUFDLENBQUM7UUFBQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxPQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFBQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxPQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDbEksTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEdBQUcsT0FBTyxDQUFDLENBQUM7UUFBQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxPQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFBQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxPQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDbEksTUFBTSxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7WUFDOUQsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO1lBQ3ZELENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDekQsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzlFLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxNQUFNLENBQUM7UUFBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDO1FBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLE1BQU0sQ0FBQztRQUNyRCxNQUFNLENBQUMsR0FBRyxDQUFDO0lBQ2IsQ0FBQztBQUNILENBQUM7QUEvTWdCLGlCQUFPLEdBQTJCLElBQUksV0FBVyxFQUFhLENBK005RTtBQUVELGVBQWUsU0FBUyxDQUFDIiwiZmlsZSI6IlgvWEZpbGVEYXRhLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEltYWdlTG9hZGVyIGZyb20gXCIuLi9Db3JlL1Jlc291cmNlcy9JbWFnZUxvYWRlclwiO1xuaW1wb3J0IFZlY3RvcjMgZnJvbSBcIi4uL01hdGgvVmVjdG9yM1wiO1xuaW1wb3J0IFZlY3RvcjQgZnJvbSBcIi4uL01hdGgvVmVjdG9yNFwiO1xuaW1wb3J0IElYTWF0ZXJpYWwgZnJvbSBcIi4vSVhNYXRlcmlhbERhdGFcIjtcbmltcG9ydCBBc3luY0xvYWRlciBmcm9tIFwiLi4vQ29yZS9SZXNvdXJjZXMvQXN5bmNMb2FkZXJcIjtcbmltcG9ydCBRIGZyb20gXCJxXCI7XG5jbGFzcyBYRmlsZURhdGEge1xuXG4gIHByaXZhdGUgc3RhdGljIF9sb2FkZXI6IEFzeW5jTG9hZGVyPFhGaWxlRGF0YT4gPSBuZXcgQXN5bmNMb2FkZXI8WEZpbGVEYXRhPigpO1xuXG4gIHB1YmxpYyBwb3NpdGlvbnM6IEZsb2F0MzJBcnJheTtcblxuICBwdWJsaWMgdGV4Q29vcmRzOiBGbG9hdDMyQXJyYXk7XG5cbiAgcHVibGljIGluZGljaWVzOiBVaW50MzJBcnJheTtcblxuICBwdWJsaWMgbm9ybWFsczogRmxvYXQzMkFycmF5O1xuXG4gIHB1YmxpYyBtYXRlcmlhbHM6IElYTWF0ZXJpYWxbXSA9IFtdO1xuXG4gIHByaXZhdGUgX2RhdGFTb3VyY2U6IHN0cmluZztcblxuICBwcml2YXRlIF9kaXJlY3Rvcnk6IHN0cmluZztcblxuICBwdWJsaWMgc3RhdGljIGxvYWRGaWxlKHNyYzogc3RyaW5nKTogUS5JUHJvbWlzZTxYRmlsZURhdGE+IHtcbiAgICBjb25zdCBkaXJlY3RvcnkgPSBzcmMuc3Vic3RyKDAsIHNyYy5sYXN0SW5kZXhPZihcIi9cIikgKyAxKTtcbiAgICByZXR1cm4gdGhpcy5fbG9hZGVyLmZldGNoKHNyYywgKGFic1BhdGgpID0+IHtcbiAgICAgIGNvbnN0IGRlZmVycmVkID0gUS5kZWZlcjxYRmlsZURhdGE+KCk7XG4gICAgICBjb25zdCB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICAgIHhoci5vcGVuKFwiR0VUXCIsIGFic1BhdGgsIHRydWUpO1xuICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoXCJBY2NlcHRcIiwgXCJ0ZXh0XCIpO1xuICAgICAgeGhyLm9ubG9hZCA9ICgpID0+IHtcbiAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShuZXcgWEZpbGVEYXRhKHhoci5yZXNwb25zZVRleHQsIGRpcmVjdG9yeSkpO1xuICAgICAgfTtcbiAgICAgIHhoci5vbmVycm9yID0gKGVycikgPT4ge1xuICAgICAgICBkZWZlcnJlZC5yZWplY3QoZXJyKTtcbiAgICAgIH07XG4gICAgICB4aHIuc2VuZChudWxsKTtcbiAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xuICAgIH0pO1xuICB9XG5cbiAgY29uc3RydWN0b3IoZGF0YVNvdXJjZTogc3RyaW5nLCBkaXJlY3Rvcnk6IHN0cmluZykge1xuICAgIHRoaXMuX2RhdGFTb3VyY2UgPSBkYXRhU291cmNlO1xuICAgIHRoaXMuX2RpcmVjdG9yeSA9IGRpcmVjdG9yeTtcbiAgICBjb25zdCBtZXNoU2VjdGlvbiA9IHRoaXMuX3NsaWNlU2VjdGlvbihkYXRhU291cmNlLCBcIk1lc2hcIiwgMCk7XG4gICAgY29uc3QgbWVzaE1hdGVyaWFsU2VjdGlvbiA9IHRoaXMuX3NsaWNlU2VjdGlvbihtZXNoU2VjdGlvbiwgXCJNZXNoTWF0ZXJpYWxMaXN0XCIsIDApO1xuICAgIHRoaXMuX3BhcnNlUG9zaXRpb25zKG1lc2hTZWN0aW9uKTtcbiAgICB0aGlzLl9wYXJzZVRleENvb3Jkcyh0aGlzLl9zbGljZVNlY3Rpb24obWVzaFNlY3Rpb24sIFwiTWVzaFRleHR1cmVDb29yZHNcIiwgMCkpO1xuICAgIHRoaXMuX3BhcnNlTWF0ZXJpYWxzKG1lc2hNYXRlcmlhbFNlY3Rpb24pO1xuICAgIHRoaXMuX3BhcnNlRmFjZXMobWVzaFNlY3Rpb24sIG1lc2hNYXRlcmlhbFNlY3Rpb24pO1xuICAgIHRoaXMuX2dlbmVyYXRlTm9ybWFscygpO1xuICAgIHRoaXMuX3ByZXBhcmVGb3JVc2luZygpO1xuICB9XG5cbiAgcHJpdmF0ZSBfc2xpY2VTZWN0aW9uKHNvdXJjZTogc3RyaW5nLCBzZWN0aW9uTmFtZTogc3RyaW5nLCBvZmZzZXQ6IG51bWJlcik6IHN0cmluZyB7XG4gICAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKGAoW157dGVtcGxhdGV9XVxcXFxzKykke3NlY3Rpb25OYW1lfVxcXFxzKlxcXFx7YCwgXCJnXCIpO1xuICAgIGxldCBmb3VuZCA9IHJlZ2V4LmV4ZWMoc291cmNlKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG9mZnNldDsgaSsrKSB7XG4gICAgICBmb3VuZCA9IHJlZ2V4LmV4ZWMoc291cmNlKTtcbiAgICB9XG4gICAgaWYgKCFmb3VuZCkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgbGV0IGJyYWNrZXRDb3VudCA9IDA7XG4gICAgbGV0IGluZGV4ID0gZm91bmQuaW5kZXg7XG4gICAgd2hpbGUgKHRydWUpIHtcbiAgICAgIGNvbnN0IG5leHRFbmRCbGFja2V0ID0gc291cmNlLmluZGV4T2YoXCJ9XCIsIGluZGV4KTtcbiAgICAgIGNvbnN0IG5leHRCZWdpbkJsYWNrZXQgPSBzb3VyY2UuaW5kZXhPZihcIntcIiwgaW5kZXgpO1xuICAgICAgaWYgKG5leHRFbmRCbGFja2V0IDwgMCAmJiBuZXh0QmVnaW5CbGFja2V0IDwgMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbm1hdGNoIGJsYWNrZXQhIVwiKTtcbiAgICAgIH1cbiAgICAgIGlmIChuZXh0QmVnaW5CbGFja2V0IDwgMCkge1xuICAgICAgICAvLyBUaGlzIG1lYW5zIHRoaXMgYmxhY2tldCBpcyBlbmQgb2YgdGhpcyBzZWN0aW9uXG4gICAgICAgIGluZGV4ID0gbmV4dEVuZEJsYWNrZXQgKyAxO1xuICAgICAgICBicmVhaztcbiAgICAgIH0gZWxzZSBpZiAobmV4dEJlZ2luQmxhY2tldCA8IG5leHRFbmRCbGFja2V0KSB7XG4gICAgICAgIGluZGV4ID0gbmV4dEJlZ2luQmxhY2tldCArIDE7XG4gICAgICAgIGJyYWNrZXRDb3VudCsrO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaW5kZXggPSBuZXh0RW5kQmxhY2tldCArIDE7XG4gICAgICAgIGJyYWNrZXRDb3VudC0tO1xuICAgICAgfVxuICAgICAgaWYgKGJyYWNrZXRDb3VudCA9PT0gMCkge1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHNvdXJjZS5zdWJzdHJpbmcoZm91bmQuaW5kZXggKyBmb3VuZFsxXS5sZW5ndGgsIGluZGV4KTtcbiAgfVxuXG4gIHByaXZhdGUgX3BhcnNlUG9zaXRpb25zKG1lc2hTZWN0aW9uOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCBwb3NpdGlvblJlZ2V4ID0gLyhbLVxcLlxcZF0rKTtcXHMqKFstXFwuXFxkXSspO1xccyooWy1cXC5cXGRdKyk7XFxzKi9nO1xuICAgIGxldCByZWdleFJlc3VsdDtcbiAgICBsZXQgcG9zaXRpb25DYWNoZSA9IFtdO1xuICAgIHdoaWxlICgocmVnZXhSZXN1bHQgPSBwb3NpdGlvblJlZ2V4LmV4ZWMobWVzaFNlY3Rpb24pKSkge1xuICAgICAgcG9zaXRpb25DYWNoZS5wdXNoKHBhcnNlRmxvYXQocmVnZXhSZXN1bHRbMV0pLCBwYXJzZUZsb2F0KHJlZ2V4UmVzdWx0WzJdKSwgcGFyc2VGbG9hdChyZWdleFJlc3VsdFszXSkpO1xuICAgIH1cbiAgICB0aGlzLnBvc2l0aW9ucyA9IG5ldyBGbG9hdDMyQXJyYXkocG9zaXRpb25DYWNoZSk7XG4gIH1cblxuICBwcml2YXRlIF9wYXJzZUZhY2VzKG1lc2hTZWN0aW9uOiBzdHJpbmcsIG1lc2hNYXRlcmlhbExpc3RTZWN0aW9uOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCBmYWNlUmVnZXggPSAvWzM0XTsoXFxkKyksKFxcZCspLChcXGQrKSg/OiwoXFxkKykpPzsvZztcbiAgICBsZXQgZmFjZVJlZ2V4UmVzdWx0O1xuICAgIGxldCBmYWNlQ2FjaGU6IG51bWJlcltdW10gPSBbXTtcbiAgICBjb25zdCBtYXRlcmlhbEluZGV4UmVnZXggPSAvKFxcZCspL2c7XG4gICAgbGV0IG1hdGVyaWFsR3JvdXBDb3VudCA9IHBhcnNlSW50KG1hdGVyaWFsSW5kZXhSZWdleC5leGVjKG1lc2hNYXRlcmlhbExpc3RTZWN0aW9uKVsxXSwgMTApO1xuICAgIGNvbnN0IG1hdEluZGljaWVzQ291bnQgPSBwYXJzZUludChtYXRlcmlhbEluZGV4UmVnZXguZXhlYyhtZXNoTWF0ZXJpYWxMaXN0U2VjdGlvbilbMV0sIDEwKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1hdGVyaWFsR3JvdXBDb3VudDsgaSsrKSB7XG4gICAgICBmYWNlQ2FjaGVbaV0gPSBbXTtcbiAgICB9XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtYXRJbmRpY2llc0NvdW50OyBpKyspIHtcbiAgICAgIGZhY2VSZWdleFJlc3VsdCA9IGZhY2VSZWdleC5leGVjKG1lc2hTZWN0aW9uKTtcbiAgICAgIGNvbnN0IG1hdGVyaWFsSW5kZXggPSBwYXJzZUludChtYXRlcmlhbEluZGV4UmVnZXguZXhlYyhtZXNoTWF0ZXJpYWxMaXN0U2VjdGlvbilbMV0sIDEwKTtcbiAgICAgIGlmIChmYWNlUmVnZXhSZXN1bHRbNF0pIHtcbiAgICAgICAgY29uc3QgZjEgPSBwYXJzZUludChmYWNlUmVnZXhSZXN1bHRbMV0sIDEwKSwgZjIgPSBwYXJzZUludChmYWNlUmVnZXhSZXN1bHRbMl0sIDEwKSwgZjMgPSBwYXJzZUludChmYWNlUmVnZXhSZXN1bHRbM10sIDEwKSwgZjQgPSBwYXJzZUludChmYWNlUmVnZXhSZXN1bHRbNF0sIDEwKTtcbiAgICAgICAgZmFjZUNhY2hlW21hdGVyaWFsSW5kZXhdLnB1c2goZjEsIGYyLCBmNCwgZjIsIGYzLCBmNCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBmYWNlQ2FjaGVbbWF0ZXJpYWxJbmRleF0ucHVzaChwYXJzZUludChmYWNlUmVnZXhSZXN1bHRbMV0sIDEwKSwgcGFyc2VJbnQoZmFjZVJlZ2V4UmVzdWx0WzJdLCAxMCksIHBhcnNlSW50KGZhY2VSZWdleFJlc3VsdFszXSwgMTApKTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gUmVkdWNlIHVudXNlZCBtYXRlcmlhbHNcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZhY2VDYWNoZS5sZW5ndGg7IGkrKykge1xuICAgICAgaWYgKGZhY2VDYWNoZVtpXS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgZmFjZUNhY2hlLnNwbGljZShpLCAxKTtcbiAgICAgICAgdGhpcy5tYXRlcmlhbHMuc3BsaWNlKGksIDEpO1xuICAgICAgICBpLS07XG4gICAgICB9XG4gICAgfVxuICAgIC8vIFNldCBmYWNlIGNvdW50IGZvciBtYXRlcmlhbHNcbiAgICBsZXQgb2Zmc2V0ID0gMDtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZhY2VDYWNoZS5sZW5ndGg7IGkrKykge1xuICAgICAgdGhpcy5tYXRlcmlhbHNbaV0uaW5kZXhPZmZzZXQgPSBvZmZzZXQ7XG4gICAgICBvZmZzZXQgKz0gdGhpcy5tYXRlcmlhbHNbaV0uaW5kZXhDb3VudCA9IGZhY2VDYWNoZVtpXS5sZW5ndGg7XG4gICAgfVxuICAgIC8vIENvbmNhdCBmYWNlIEFycmF5XG4gICAgbGV0IGNvbmNhdHRlZEZhY2VBcnJheSA9IFtdO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZmFjZUNhY2hlLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25jYXR0ZWRGYWNlQXJyYXkgPSBjb25jYXR0ZWRGYWNlQXJyYXkuY29uY2F0KGZhY2VDYWNoZVtpXSk7XG4gICAgfVxuICAgIHRoaXMuaW5kaWNpZXMgPSBuZXcgVWludDMyQXJyYXkoY29uY2F0dGVkRmFjZUFycmF5KTtcbiAgfVxuXG4gIHByaXZhdGUgX3BhcnNlTWF0ZXJpYWxzKG1lc2hNYXRlcmlhbFNlY3Rpb246IHN0cmluZyk6IHZvaWQge1xuICAgIGxldCBtYXRlcmlhbFNlY3Rpb247XG4gICAgbGV0IG1hdGVyaWFsSW5kZXggPSAwO1xuICAgIHdoaWxlICgobWF0ZXJpYWxTZWN0aW9uID0gdGhpcy5fc2xpY2VTZWN0aW9uKG1lc2hNYXRlcmlhbFNlY3Rpb24sIFwiTWF0ZXJpYWxcIiwgbWF0ZXJpYWxJbmRleCkpKSB7XG4gICAgICBjb25zdCBudW1iZXJSZWdleCA9IC8oWy1cXC5cXGRdKyk7LztcbiAgICAgIGNvbnN0IGZvdW5kTnVtYmVycyA9IG5ldyBBcnJheSgxMSk7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDExOyBpKyspIHtcbiAgICAgICAgY29uc3QgcmVnZXhSZXN1bHQgPSBudW1iZXJSZWdleC5leGVjKG1hdGVyaWFsU2VjdGlvbik7XG4gICAgICAgIGZvdW5kTnVtYmVyc1tpXSA9IHBhcnNlRmxvYXQocmVnZXhSZXN1bHRbMV0pO1xuICAgICAgfVxuICAgICAgY29uc3QgdGV4dHVyZVNlY3Rpb24gPSB0aGlzLl9zbGljZVNlY3Rpb24obWF0ZXJpYWxTZWN0aW9uLCBcIlRleHR1cmVGaWxlbmFtZVwiLCAwKTtcbiAgICAgIGxldCB0ZXh0dXJlUGF0aDtcbiAgICAgIGlmICh0ZXh0dXJlU2VjdGlvbikge1xuICAgICAgICB0ZXh0dXJlUGF0aCA9IC9cIihbXlwiXSspXCIvLmV4ZWModGV4dHVyZVNlY3Rpb24pWzFdLnJlcGxhY2UoL1xcXFwvZywgXCIvXCIpO1xuICAgICAgICB0ZXh0dXJlUGF0aCA9IHRleHR1cmVQYXRoLnJlcGxhY2UoXCIudGdhXCIsIFwiLnRnYS5wbmdcIik7XG4gICAgICB9XG4gICAgICB0aGlzLm1hdGVyaWFsc1ttYXRlcmlhbEluZGV4XSA9IHtcbiAgICAgICAgZmFjZUNvbG9yOiBuZXcgVmVjdG9yNChmb3VuZE51bWJlcnNbMF0sIGZvdW5kTnVtYmVyc1sxXSwgZm91bmROdW1iZXJzWzJdLCBmb3VuZE51bWJlcnNbM10pLFxuICAgICAgICBwb3dlcjogZm91bmROdW1iZXJzWzRdLFxuICAgICAgICBzcGVjdWxhckNvbG9yOiBuZXcgVmVjdG9yMyhmb3VuZE51bWJlcnNbNV0sIGZvdW5kTnVtYmVyc1s2XSwgZm91bmROdW1iZXJzWzddKSxcbiAgICAgICAgZW1pc3NpdmVDb2xvcjogbmV3IFZlY3RvcjMoZm91bmROdW1iZXJzWzhdLCBmb3VuZE51bWJlcnNbOV0sIGZvdW5kTnVtYmVyc1sxMF0pLFxuICAgICAgICB0ZXh0dXJlOiB0ZXh0dXJlUGF0aCA/IHRoaXMuX2RpcmVjdG9yeSArIHRleHR1cmVQYXRoIDogdW5kZWZpbmVkLFxuICAgICAgICBpbmRleENvdW50OiB1bmRlZmluZWQsXG4gICAgICAgIGluZGV4T2Zmc2V0OiB1bmRlZmluZWRcbiAgICAgIH07XG4gICAgICBtYXRlcmlhbEluZGV4Kys7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfcGFyc2VUZXhDb29yZHMobWVzaFRleHR1cmVTZWN0aW9uOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCB0ZXhDb29yZFJlZ2V4ID0gLyhbLVxcLlxcZF0rKTsoWy1cXC5cXGRdKyk7L2c7XG4gICAgbGV0IHJlZ2V4UmVzdWx0O1xuICAgIGxldCB0ZXhDb29yZENhY2hlID0gW107XG4gICAgd2hpbGUgKChyZWdleFJlc3VsdCA9IHRleENvb3JkUmVnZXguZXhlYyhtZXNoVGV4dHVyZVNlY3Rpb24pKSkge1xuICAgICAgdGV4Q29vcmRDYWNoZS5wdXNoKHBhcnNlRmxvYXQocmVnZXhSZXN1bHRbMV0pLCBwYXJzZUZsb2F0KHJlZ2V4UmVzdWx0WzJdKSk7XG4gICAgfVxuICAgIHRoaXMudGV4Q29vcmRzID0gbmV3IEZsb2F0MzJBcnJheSh0ZXhDb29yZENhY2hlKTtcbiAgfVxuXG4gIHByaXZhdGUgX3ByZXBhcmVGb3JVc2luZygpOiB2b2lkIHtcbiAgICAvLyBMb2FkIHRleHR1cmVzXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLm1hdGVyaWFscy5sZW5ndGg7IGkrKykge1xuICAgICAgaWYgKHRoaXMubWF0ZXJpYWxzW2ldLnRleHR1cmUpIHtcbiAgICAgICAgSW1hZ2VMb2FkZXIubG9hZEltYWdlKHRoaXMubWF0ZXJpYWxzW2ldLnRleHR1cmUpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX2dlbmVyYXRlTm9ybWFscygpOiB2b2lkIHtcbiAgICBsZXQgbm9ybWFsQ2FjaGUgPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuaW5kaWNpZXMubGVuZ3RoOyBpICs9IDMpIHtcbiAgICAgIGNvbnN0IGYxaSA9IHRoaXMuaW5kaWNpZXNbaV07XG4gICAgICBjb25zdCBmMmkgPSB0aGlzLmluZGljaWVzW2kgKyAxXTtcbiAgICAgIGNvbnN0IGYzaSA9IHRoaXMuaW5kaWNpZXNbaSArIDJdO1xuICAgICAgY29uc3Qgbm9ybWFsID0gdGhpcy5fZ2VuZXJhdGVOb3JtYWwoZjFpLCBmMmksIGYzaSk7XG4gICAgICBub3JtYWxDYWNoZVszICogZjFpXSA9IG5vcm1hbENhY2hlWzMgKiBmMmldID0gbm9ybWFsQ2FjaGVbMyAqIGYzaV0gPSBub3JtYWxbMF07XG4gICAgICBub3JtYWxDYWNoZVszICogZjFpICsgMV0gPSBub3JtYWxDYWNoZVszICogZjJpICsgMV0gPSBub3JtYWxDYWNoZVszICogZjNpICsgMV0gPSBub3JtYWxbMV07XG4gICAgICBub3JtYWxDYWNoZVszICogZjFpICsgMl0gPSBub3JtYWxDYWNoZVszICogZjJpICsgMl0gPSBub3JtYWxDYWNoZVszICogZjNpICsgMl0gPSBub3JtYWxbMl07XG4gICAgfVxuICAgIHRoaXMubm9ybWFscyA9IG5ldyBGbG9hdDMyQXJyYXkobm9ybWFsQ2FjaGUpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2VuZXJhdGVOb3JtYWwocDFJbmRleDogbnVtYmVyLCBwMkluZGV4OiBudW1iZXIsIHAzSW5kZXg6IG51bWJlcik6IG51bWJlcltdIHtcbiAgICBjb25zdCBwMXggPSB0aGlzLnBvc2l0aW9uc1szICogcDFJbmRleF07IGNvbnN0IHAxeSA9IHRoaXMucG9zaXRpb25zWzMgKiBwMUluZGV4ICsgMV07IGNvbnN0IHAxeiA9IHRoaXMucG9zaXRpb25zWzMgKiBwMUluZGV4ICsgMl07XG4gICAgY29uc3QgcDJ4ID0gdGhpcy5wb3NpdGlvbnNbMyAqIHAySW5kZXhdOyBjb25zdCBwMnkgPSB0aGlzLnBvc2l0aW9uc1szICogcDJJbmRleCArIDFdOyBjb25zdCBwMnogPSB0aGlzLnBvc2l0aW9uc1szICogcDJJbmRleCArIDJdO1xuICAgIGNvbnN0IHAzeCA9IHRoaXMucG9zaXRpb25zWzMgKiBwM0luZGV4XTsgY29uc3QgcDN5ID0gdGhpcy5wb3NpdGlvbnNbMyAqIHAzSW5kZXggKyAxXTsgY29uc3QgcDN6ID0gdGhpcy5wb3NpdGlvbnNbMyAqIHAzSW5kZXggKyAyXTtcbiAgICBjb25zdCByZXQgPSBbKHAyeSAtIHAxeSkgKiAocDN6IC0gcDF6KSAtIChwMnogLSBwMXopICogKHAzeSAtIHAxeSlcbiAgICAgICwgKHAyeiAtIHAxeikgKiAocDN4IC0gcDF4KSAtIChwMnggLSBwMXgpICogKHAzeiAtIHAxeiksXG4gICAgICAocDJ4IC0gcDF4KSAqIChwM3kgLSBwMXkpIC0gKHAyeSAtIHAxeSkgKiAocDN4IC0gcDF4KV07XG4gICAgY29uc3QgbGVuZ3RoID0gTWF0aC5zcXJ0KHJldFswXSAqIHJldFswXSArIHJldFsxXSAqIHJldFsxXSArIHJldFsyXSAqIHJldFsyXSk7XG4gICAgcmV0WzBdIC89IGxlbmd0aDsgcmV0WzFdIC89IGxlbmd0aDsgcmV0WzJdIC89IGxlbmd0aDtcbiAgICByZXR1cm4gcmV0O1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFhGaWxlRGF0YTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==

import JSON5 from "json5";
class ConditionBlock {
    constructor(condition, children, isPlain, content) {
        this._children = children;
        this._condition = condition;
        if (condition != null) {
            this._type = condition["type"];
        }
        this._isPlain = isPlain;
        this._content = content;
    }
    static parseCondition(source) {
        let ret = new ConditionBlock(null, ConditionBlock._parseCondition(source), false, null);
        ret._isRoot = true;
        return ret;
    }
    static _parseCondition(source) {
        let ret = [];
        const found = source.indexOf("@Condition(", 0);
        if (found < 0) {
            ret.push(ConditionBlock._createPlain(source));
            return ret; // When there was no more found
        }
        let beginConditionPoint = found + 10;
        const endConditionPoint = ConditionBlock._getEndBracketIndex(source, beginConditionPoint, "(", ")");
        if (endConditionPoint < 1) {
            // error no bracket matching
            console.error("Invalid bracket matching!");
            return null;
        }
        let beginContentPoint = source.indexOf("{", endConditionPoint);
        if (beginContentPoint < 0) {
            // error no bracket matching
            console.error("Invalid bracket matching!");
            return null;
        }
        const endContentPoint = ConditionBlock._getEndBracketIndex(source, beginContentPoint, "{", "}");
        if (endContentPoint < 0) {
            // error no bracket matching
            console.error("Invalid bracket matching!");
            return null;
        }
        let before = source.substring(0, found);
        let condition = source.substring(beginConditionPoint + 1, endConditionPoint);
        let jsonCondition = JSON5.parse(condition);
        let content = source.substring(beginContentPoint + 1, endContentPoint);
        let after = source.substring(endContentPoint + 1, source.length);
        ret.push(ConditionBlock._createPlain(before));
        ret.push(new ConditionBlock(jsonCondition, ConditionBlock._parseCondition(content), false, null));
        ret = ret.concat(ConditionBlock._parseCondition(after));
        return ret;
    }
    static _createPlain(content) {
        return new ConditionBlock(null, [], true, content);
    }
    static _getEndBracketIndex(source, startIndex, beginBracket, endBracket) {
        // get index of matching endBracket
        let index = startIndex;
        let bracketCount = 1;
        while (true) {
            if (bracketCount === 0) {
                break;
            }
            index++;
            const nextEndBlacket = source.indexOf(endBracket, index);
            const nextBeginBlacket = source.indexOf(beginBracket, index);
            if (nextEndBlacket < 0) {
                // error no bracket matching
                console.error("Invalid bracket matching!");
                return -1;
            }
            if (nextBeginBlacket < 0) {
                index = nextEndBlacket;
                bracketCount--;
                continue;
            }
            if (nextEndBlacket < nextBeginBlacket) {
                index = nextEndBlacket;
                bracketCount--;
                continue;
            }
            else {
                index = nextBeginBlacket;
                bracketCount++;
                continue;
            }
        }
        return index;
    }
    resolve(conditionRegister) {
        if (!this._isRoot) {
            if (this._isPlain) {
                return this._content;
            }
            let cc = conditionRegister.getConditionChecker(this._type);
            if (cc == null) {
                return "";
            }
            if (!cc.checkCondition(this._condition)) {
                return "";
            }
        }
        let ret = "";
        for (let i = 0; i < this._children.length; i++) {
            ret = ret + this._children[i].resolve(conditionRegister);
        }
        return ret;
    }
}
export default ConditionBlock;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkNvcmUvTWF0ZXJpYWxzL0Jhc2UvQ29uZGl0aW9uQmxvY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ik9BQ08sS0FBSyxNQUFNLE9BQU87QUFFekI7SUFRRSxZQUFZLFNBQWUsRUFBRSxRQUEwQixFQUFFLE9BQWdCLEVBQUUsT0FBZTtRQUN4RixJQUFJLENBQUMsU0FBUyxHQUFHLFFBQVEsQ0FBQztRQUMxQixJQUFJLENBQUMsVUFBVSxHQUFHLFNBQVMsQ0FBQztRQUM1QixFQUFFLENBQUMsQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztZQUN0QixJQUFJLENBQUMsS0FBSyxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNqQyxDQUFDO1FBQ0QsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUM7UUFDeEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUM7SUFDMUIsQ0FBQztJQUNELE9BQWMsY0FBYyxDQUFDLE1BQWM7UUFDekMsSUFBSSxHQUFHLEdBQUcsSUFBSSxjQUFjLENBQUMsSUFBSSxFQUFFLGNBQWMsQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3hGLEdBQUcsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO1FBQ25CLE1BQU0sQ0FBQyxHQUFHLENBQUM7SUFDYixDQUFDO0lBRUQsT0FBZSxlQUFlLENBQUMsTUFBYztRQUMzQyxJQUFJLEdBQUcsR0FBcUIsRUFBRSxDQUFDO1FBQy9CLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQy9DLEVBQUUsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2QsR0FBRyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDOUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFD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QzNELEVBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUNmLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDWixDQUFDO1lBRUQsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3hDLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDWixDQUFDO1FBRUgsQ0FBQztRQUNELElBQUksR0FBRyxHQUFHLEVBQUUsQ0FBQztRQUNiLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUMvQyxHQUFHLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDM0QsQ0FBQztRQUNELE1BQU0sQ0FBQyxHQUFHLENBQUM7SUFDYixDQUFDO0FBR0gsQ0FBQztBQUNELGVBQWUsY0FBYyxDQUFDIiwiZmlsZSI6IkNvcmUvTWF0ZXJpYWxzL0Jhc2UvQ29uZGl0aW9uQmxvY2suanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgSUNvbmRpdGlvblJlZ2lzdGVyIGZyb20gXCIuL0lDb25kaXRpb25SZWdpc3RlclwiO1xuaW1wb3J0IEpTT041IGZyb20gXCJqc29uNVwiO1xuXG5jbGFzcyBDb25kaXRpb25CbG9jayB7XG4gIHByaXZhdGUgX3R5cGU6IHN0cmluZztcbiAgcHJpdmF0ZSBfY29uZGl0aW9uOiBKU09OO1xuICBwcml2YXRlIF9pc1BsYWluOiBib29sZWFuO1xuICBwcml2YXRlIF9pc1Jvb3Q6IGJvb2xlYW47XG4gIHByaXZhdGUgX2NoaWxkcmVuOiBDb25kaXRpb25CbG9ja1tdO1xuICBwcml2YXRlIF9jb250ZW50OiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoY29uZGl0aW9uOiBKU09OLCBjaGlsZHJlbjogQ29uZGl0aW9uQmxvY2tbXSwgaXNQbGFpbjogYm9vbGVhbiwgY29udGVudDogc3RyaW5nKSB7XG4gICAgdGhpcy5fY2hpbGRyZW4gPSBjaGlsZHJlbjtcbiAgICB0aGlzLl9jb25kaXRpb24gPSBjb25kaXRpb247XG4gICAgaWYgKGNvbmRpdGlvbiAhPSBudWxsKSB7XG4gICAgICB0aGlzLl90eXBlID0gY29uZGl0aW9uW1widHlwZVwiXTtcbiAgICB9XG4gICAgdGhpcy5faXNQbGFpbiA9IGlzUGxhaW47XG4gICAgdGhpcy5fY29udGVudCA9IGNvbnRlbnQ7XG4gIH1cbiAgcHVibGljIHN0YXRpYyBwYXJzZUNvbmRpdGlvbihzb3VyY2U6IHN0cmluZyk6IENvbmRpdGlvbkJsb2NrIHtcbiAgICBsZXQgcmV0ID0gbmV3IENvbmRpdGlvbkJsb2NrKG51bGwsIENvbmRpdGlvbkJsb2NrLl9wYXJzZUNvbmRpdGlvbihzb3VyY2UpLCBmYWxzZSwgbnVsbCk7XG4gICAgcmV0Ll9pc1Jvb3QgPSB0cnVlO1xuICAgIHJldHVybiByZXQ7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBfcGFyc2VDb25kaXRpb24oc291cmNlOiBzdHJpbmcpOiBDb25kaXRpb25CbG9ja1tdIHtcbiAgICBsZXQgcmV0OiBDb25kaXRpb25CbG9ja1tdID0gW107XG4gICAgY29uc3QgZm91bmQgPSBzb3VyY2UuaW5kZXhPZihcIkBDb25kaXRpb24oXCIsIDApO1xuICAgIGlmIChmb3VuZCA8IDApIHtcbiAgICAgIHJldC5wdXNoKENvbmRpdGlvbkJsb2NrLl9jcmVhdGVQbGFpbihzb3VyY2UpKTtcbiAgICAgIHJldHVybiByZXQ7IC8vIFdoZW4gdGhlcmUgd2FzIG5vIG1vcmUgZm91bmRcbiAgICB9XG5cbiAgICBsZXQgYmVnaW5Db25kaXRpb25Qb2ludCA9IGZvdW5kICsgMTA7XG4gICAgY29uc3QgZW5kQ29uZGl0aW9uUG9pbnQ6IG51bWJlciA9IENvbmRpdGlvbkJsb2NrLl9nZXRFbmRCcmFja2V0SW5kZXgoc291cmNlLCBiZWdpbkNvbmRpdGlvblBvaW50LCBcIihcIiwgXCIpXCIpO1xuICAgIGlmIChlbmRDb25kaXRpb25Qb2ludCA8IDEpIHtcbiAgICAgIC8vIGVycm9yIG5vIGJyYWNrZXQgbWF0Y2hpbmdcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJJbnZhbGlkIGJyYWNrZXQgbWF0Y2hpbmchXCIpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGxldCBiZWdpbkNvbnRlbnRQb2ludCA9IHNvdXJjZS5pbmRleE9mKFwie1wiLCBlbmRDb25kaXRpb25Qb2ludCk7XG4gICAgaWYgKGJlZ2luQ29udGVudFBvaW50IDwgMCkge1xuICAgICAgLy8gZXJyb3Igbm8gYnJhY2tldCBtYXRjaGluZ1xuICAgICAgY29uc29sZS5lcnJvcihcIkludmFsaWQgYnJhY2tldCBtYXRjaGluZyFcIik7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29uc3QgZW5kQ29udGVudFBvaW50ID0gQ29uZGl0aW9uQmxvY2suX2dldEVuZEJyYWNrZXRJbmRleChzb3VyY2UsIGJlZ2luQ29udGVudFBvaW50LCBcIntcIiwgXCJ9XCIpO1xuICAgIGlmIChlbmRDb250ZW50UG9pbnQgPCAwKSB7XG4gICAgICAvLyBlcnJvciBubyBicmFja2V0IG1hdGNoaW5nXG4gICAgICBjb25zb2xlLmVycm9yKFwiSW52YWxpZCBicmFja2V0IG1hdGNoaW5nIVwiKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBsZXQgYmVmb3JlOiBzdHJpbmcgPSBzb3VyY2Uuc3Vic3RyaW5nKDAsIGZvdW5kKTtcbiAgICBsZXQgY29uZGl0aW9uOiBzdHJpbmcgPSBzb3VyY2Uuc3Vic3RyaW5nKGJlZ2luQ29uZGl0aW9uUG9pbnQgKyAxLCBlbmRDb25kaXRpb25Qb2ludCk7XG4gICAgbGV0IGpzb25Db25kaXRpb246IEpTT04gPSBKU09ONS5wYXJzZShjb25kaXRpb24pO1xuICAgIGxldCBjb250ZW50OiBzdHJpbmcgPSBzb3VyY2Uuc3Vic3RyaW5nKGJlZ2luQ29udGVudFBvaW50ICsgMSwgZW5kQ29udGVudFBvaW50KTtcbiAgICBsZXQgYWZ0ZXI6IHN0cmluZyA9IHNvdXJjZS5zdWJzdHJpbmcoZW5kQ29udGVudFBvaW50ICsgMSwgc291cmNlLmxlbmd0aCk7XG4gICAgcmV0LnB1c2goQ29uZGl0aW9uQmxvY2suX2NyZWF0ZVBsYWluKGJlZm9yZSkpO1xuICAgIHJldC5wdXNoKG5ldyBDb25kaXRpb25CbG9jayhqc29uQ29uZGl0aW9uLCBDb25kaXRpb25CbG9jay5fcGFyc2VDb25kaXRpb24oY29udGVudCksIGZhbHNlLCBudWxsKSk7XG4gICAgcmV0ID0gcmV0LmNvbmNhdChDb25kaXRpb25CbG9jay5fcGFyc2VDb25kaXRpb24oYWZ0ZXIpKTtcbiAgICByZXR1cm4gcmV0O1xuICB9XG4gIHByaXZhdGUgc3RhdGljIF9jcmVhdGVQbGFpbihjb250ZW50OiBzdHJpbmcpOiBDb25kaXRpb25CbG9jayB7XG4gICAgcmV0dXJuIG5ldyBDb25kaXRpb25CbG9jayhudWxsLCBbXSwgdHJ1ZSwgY29udGVudCk7XG4gIH1cbiAgcHJpdmF0ZSBzdGF0aWMgX2dldEVuZEJyYWNrZXRJbmRleChzb3VyY2U6IHN0cmluZywgc3RhcnRJbmRleDogbnVtYmVyLCBiZWdpbkJyYWNrZXQ6IHN0cmluZywgZW5kQnJhY2tldDogc3RyaW5nKTogbnVtYmVyIHtcbiAgICAvLyBnZXQgaW5kZXggb2YgbWF0Y2hpbmcgZW5kQnJhY2tldFxuICAgIGxldCBpbmRleCA9IHN0YXJ0SW5kZXg7XG5cbiAgICBsZXQgYnJhY2tldENvdW50ID0gMTtcbiAgICB3aGlsZSAodHJ1ZSkgeyAvLyBmaW5kIG1hdGNoaW5nIGJyYWNrZXRcbiAgICAgIGlmIChicmFja2V0Q291bnQgPT09IDApIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBpbmRleCsrO1xuICAgICAgY29uc3QgbmV4dEVuZEJsYWNrZXQgPSBzb3VyY2UuaW5kZXhPZihlbmRCcmFja2V0LCBpbmRleCk7XG4gICAgICBjb25zdCBuZXh0QmVnaW5CbGFja2V0ID0gc291cmNlLmluZGV4T2YoYmVnaW5CcmFja2V0LCBpbmRleCk7XG4gICAgICBpZiAobmV4dEVuZEJsYWNrZXQgPCAwKSB7XG4gICAgICAgIC8vIGVycm9yIG5vIGJyYWNrZXQgbWF0Y2hpbmdcbiAgICAgICAgY29uc29sZS5lcnJvcihcIkludmFsaWQgYnJhY2tldCBtYXRjaGluZyFcIik7XG4gICAgICAgIHJldHVybiAtMTtcbiAgICAgIH1cbiAgICAgIGlmIChuZXh0QmVnaW5CbGFja2V0IDwgMCkge1xuICAgICAgICBpbmRleCA9IG5leHRFbmRCbGFja2V0O1xuICAgICAgICBicmFja2V0Q291bnQtLTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBpZiAobmV4dEVuZEJsYWNrZXQgPCBuZXh0QmVnaW5CbGFja2V0KSB7XG4gICAgICAgIGluZGV4ID0gbmV4dEVuZEJsYWNrZXQ7XG4gICAgICAgIGJyYWNrZXRDb3VudC0tO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGluZGV4ID0gbmV4dEJlZ2luQmxhY2tldDtcbiAgICAgICAgYnJhY2tldENvdW50Kys7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gaW5kZXg7XG4gIH1cblxuXG4gIHB1YmxpYyByZXNvbHZlKGNvbmRpdGlvblJlZ2lzdGVyOiBJQ29uZGl0aW9uUmVnaXN0ZXIpOiBzdHJpbmcge1xuXG4gICAgaWYgKCF0aGlzLl9pc1Jvb3QpIHtcblxuXG4gICAgICBpZiAodGhpcy5faXNQbGFpbikge1xuICAgICAgICByZXR1cm4gdGhpcy5fY29udGVudDtcbiAgICAgIH1cblxuICAgICAgbGV0IGNjID0gY29uZGl0aW9uUmVnaXN0ZXIuZ2V0Q29uZGl0aW9uQ2hlY2tlcih0aGlzLl90eXBlKTtcbiAgICAgIGlmIChjYyA9PSBudWxsKSB7XG4gICAgICAgIHJldHVybiBcIlwiO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWNjLmNoZWNrQ29uZGl0aW9uKHRoaXMuX2NvbmRpdGlvbikpIHtcbiAgICAgICAgcmV0dXJuIFwiXCI7XG4gICAgICB9XG5cbiAgICB9XG4gICAgbGV0IHJldCA9IFwiXCI7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9jaGlsZHJlbi5sZW5ndGg7IGkrKykge1xuICAgICAgcmV0ID0gcmV0ICsgdGhpcy5fY2hpbGRyZW5baV0ucmVzb2x2ZShjb25kaXRpb25SZWdpc3Rlcik7XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG4gIH1cblxuXG59XG5leHBvcnQgZGVmYXVsdCBDb25kaXRpb25CbG9jaztcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==

import RSMLRenderConfigUtility from "./RSMLRenderConfigUtility";
import XMLRenderConfigUtility from "../../../Materials/Base/XMLRenderConfigUtility";
import BasicMaterial from "../../../Materials/Base/BasicMaterial";
import JThreeObjectWithID from "../../../../Base/JThreeObjectWithID";
import ContextComponents from "../../../../ContextComponents";
import JThreeContext from "../../../../JThreeContext";
class BasicTechnique extends JThreeObjectWithID {
    constructor(renderStage, technique, techniqueIndex) {
        super();
        this.__fboInitialized = false;
        this._wireFramed = false;
        this.__renderStage = renderStage;
        this._techniqueDocument = technique;
        this._techniqueIndex = techniqueIndex;
        this.defaultRenderConfigure = XMLRenderConfigUtility.parseRenderConfig(technique, this.__renderStage.getSuperRendererConfigure());
        this._target = this._techniqueDocument.getAttribute("target");
        this._wireFramed = this._techniqueDocument.getAttribute("wireframe") === "true";
        if (!this._target) {
            this._target = "scene";
        }
        this._fboBindingInfo = RSMLRenderConfigUtility.parseFBOConfiguration(this._techniqueDocument.getElementsByTagName("fbo").item(0), renderStage.Renderer.Canvas);
        if (this._target !== "scene") {
            this.defaultMaterial = this._getMaterial();
        }
    }
    get _gl() {
        return this.__renderStage.GL;
    }
    get Target() {
        return this._target;
    }
    preTechnique(scene, texs) {
        this._applyBufferConfiguration(scene, texs);
    }
    render(scene, object, techniqueCount, techniqueIndex, texs) {
        switch (this.Target) {
            case "scene":
                const materialGroup = this._techniqueDocument.getAttribute("materialGroup");
                this.__renderStage.drawForMaterials(scene, object, techniqueCount, techniqueIndex, texs, materialGroup, this._wireFramed);
                break;
            default:
                this.defaultMaterial.materialVariables = this.__renderStage.stageVariables;
                XMLRenderConfigUtility.applyAll(this._gl, this.defaultRenderConfigure);
                this.__renderStage.drawForMaterial(scene, object, techniqueCount, techniqueIndex, texs, this.defaultMaterial, this._wireFramed);
        }
    }
    __initializeFBO(texs) {
        this.__fboInitialized = true;
        const rm = JThreeContext.getContextComponent(ContextComponents.ResourceManager);
        this.__fbo = rm.createFBO("jthree.technique." + this.ID);
        const fboWrapper = this.__fbo.getForContext(this.__renderStage.Renderer.Canvas);
        this._attachRBOConfigure(fboWrapper, texs);
        this._attachTextureConfigure(fboWrapper, texs);
    }
    _getMaterial() {
        const rawMaterials = this._techniqueDocument.getElementsByTagName("material");
        if (rawMaterials.length > 0) {
            const materialDocument = rawMaterials.item(0);
            return new BasicMaterial(materialDocument.outerHTML, this.__renderStage.stageName + this._techniqueIndex);
        }
        const mm = JThreeContext.getContextComponent(ContextComponents.MaterialManager);
        const matName = this._techniqueDocument.getAttribute("material");
        if (!matName) {
            console.error("material name was not specified.");
        }
        return mm.constructMaterial(matName);
    }
    _attachTextureConfigure(fboWrapper, texs) {
        // TODO support for multiple rendering buffer
        const colorConfigure = this._fboBindingInfo[0];
        fboWrapper.attachTexture(WebGLRenderingContext.COLOR_ATTACHMENT0, texs[colorConfigure.name]);
    }
    _attachRBOConfigure(fboWrapper, texs) {
        if (!this._fboBindingInfo.rbo) {
            fboWrapper.attachRBO(WebGLRenderingContext.DEPTH_ATTACHMENT, null); // Unbind render buffer
        }
        else {
            const rboConfigure = this._fboBindingInfo.rbo;
            let targetBuffer;
            let isRBO = true;
            if (rboConfigure.name === "default") {
                targetBuffer = this.__renderStage.DefaultRBO;
            }
            else {
                if (!texs[rboConfigure.name]) {
                    throw new Error("Specified render buffer was not found");
                }
                else {
                    targetBuffer = texs[rboConfigure.name];
                    isRBO = false;
                }
            }
            if (isRBO) {
                switch (rboConfigure.type) {
                    case "stencil":
                        fboWrapper.attachRBO(WebGLRenderingContext.STENCIL_ATTACHMENT, targetBuffer);
                        break;
                    case "depthstencil":
                        fboWrapper.attachRBO(WebGLRenderingContext.DEPTH_STENCIL_ATTACHMENT, targetBuffer);
                        break;
                    default:
                    case "depth":
                        fboWrapper.attachRBO(WebGLRenderingContext.DEPTH_ATTACHMENT, targetBuffer);
                        break;
                }
            }
            else {
                switch (rboConfigure.type) {
                    case "stencil":
                        fboWrapper.attachTexture(WebGLRenderingContext.STENCIL_ATTACHMENT, targetBuffer);
                        break;
                    case "depthstencil":
                        fboWrapper.attachTexture(WebGLRenderingContext.DEPTH_STENCIL_ATTACHMENT, targetBuffer);
                        break;
                    default:
                    case "depth":
                        fboWrapper.attachTexture(WebGLRenderingContext.DEPTH_ATTACHMENT, targetBuffer);
                        break;
                }
            }
        }
    }
    _applyBufferConfiguration(scene, texs) {
        if (!this._fboBindingInfo || !this._fboBindingInfo[0]) {
            // if there was no fbo configuration, use screen buffer as default
            this._applyViewport(true);
            this._gl.bindFramebuffer(this._gl.FRAMEBUFFER, null);
            return;
        }
        else {
            // Check primary buffer was specified
            if (this._fboBindingInfo.primaryName && !texs[this._fboBindingInfo.primaryName]) {
                this._onPrimaryBufferFail();
                return;
            }
            this._applyViewport(false);
            if (!this.__fboInitialized) {
                this.__initializeFBO(texs);
            }
            this.__fbo.getForContext(this.__renderStage.Renderer.Canvas).bind();
            this._clearBuffers();
        }
    }
    /**
     * When primary buffer was failed to bind, this method bind default buffer as drawing target.
     */
    _onPrimaryBufferFail() {
        this._applyViewport(true);
        this._gl.bindFramebuffer(this._gl.FRAMEBUFFER, null);
        if (this._fboBindingInfo.rbo && this._fboBindingInfo.rbo.needClear) {
            this._gl.depthMask(true);
            this._gl.clearDepth(this._fboBindingInfo.rbo.clearDepth);
            this._gl.clear(this._gl.DEPTH_BUFFER_BIT);
        }
    }
    _clearBuffers() {
        // Clear color buffer
        // TODO: support for multiple buffers
        if (this._fboBindingInfo[0] && this._fboBindingInfo[0].needClear) {
            const buffer = this._fboBindingInfo[0];
            const col = buffer.clearColor;
            this._gl.colorMask(true, true, true, true);
            this._gl.clearColor(col.X, col.Y, col.Z, col.W);
            this._gl.clear(this._gl.COLOR_BUFFER_BIT);
        }
        if (this._fboBindingInfo.rbo && this._fboBindingInfo.rbo.needClear) {
            this._gl.depthMask(true);
            this._gl.clearDepth(this._fboBindingInfo.rbo.clearDepth);
            this._gl.clear(this._gl.DEPTH_BUFFER_BIT);
        }
    }
    _applyViewport(isDefault) {
        if (isDefault) {
            this.__renderStage.Renderer.applyDefaultBufferViewport();
        }
        else {
            this.__renderStage.Renderer.applyRendererBufferViewport();
        }
    }
}
export default BasicTechnique;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkNvcmUvUmVuZGVyZXJzL1JlbmRlclN0YWdlcy9SU01ML0Jhc2ljVGVjaG5pcXVlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJPQUVPLHVCQUF1QixNQUFNLDJCQUEyQjtPQUd4RCxzQkFBc0IsTUFBTSxnREFBZ0Q7T0FHNUUsYUFBYSxNQUFNLHVDQUF1QztPQUcxRCxrQkFBa0IsTUFBTSxxQ0FBcUM7T0FDN0QsaUJBQWlCLE1BQU0sK0JBQStCO09BRXRELGFBQWEsTUFBTSwyQkFBMkI7QUFJckQsNkJBQTZCLGtCQUFrQjtJQTJCN0MsWUFBWSxXQUE0QixFQUFFLFNBQWtCLEVBQUUsY0FBc0I7UUFDbEYsT0FBTyxDQUFDO1FBbEJBLHFCQUFnQixHQUFZLEtBQUssQ0FBQztRQUVwQyxnQkFBVyxHQUFZLEtBQUssQ0FBQztRQWlCbkMsSUFBSSxDQUFDLGFBQWEsR0FBRyxXQUFXLENBQUM7UUFDakMsSUFBSSxDQUFDLGtCQUFrQixHQUFHLFNBQVMsQ0FBQztRQUNwQyxJQUFJLENBQUMsZUFBZSxHQUFHLGNBQWMsQ0FBQztRQUN0QyxJQUFJLENBQUMsc0JBQXNCLEdBQUcsc0JBQXNCLENBQUMsaUJBQWlCLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMseUJBQXlCLEVBQUUsQ0FBQyxDQUFDO1FBQ2xJLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM5RCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLEtBQUssTUFBTSxDQUFDO1FBQ2hGLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFBQyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUFDLENBQUM7UUFDOUMsSUFBSSxDQUFDLGVBQWUsR0FBRyx1QkFBdUIsQ0FBQyxxQkFBcUIsQ0FBQyxJ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ZXJTdGFnZXMvUlNNTC9CYXNpY1RlY2huaXF1ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSQk8gZnJvbSBcIi4uLy4uLy4uL1Jlc291cmNlcy9SQk8vUkJPXCI7XG5pbXBvcnQgVGV4dHVyZUJhc2UgZnJvbSBcIi4uLy4uLy4uL1Jlc291cmNlcy9UZXh0dXJlL1RleHR1cmVCYXNlXCI7XG5pbXBvcnQgUlNNTFJlbmRlckNvbmZpZ1V0aWxpdHkgZnJvbSBcIi4vUlNNTFJlbmRlckNvbmZpZ1V0aWxpdHlcIjtcbmltcG9ydCBJRkJPQmluZGluZ0NvbmZpZyBmcm9tIFwiLi9JRkJPQmluZGluZ0NvbmZpZ1wiO1xuaW1wb3J0IFJTTUxSZW5kZXJTdGFnZSBmcm9tIFwiLi9SU01MUmVuZGVyU3RhZ2VcIjtcbmltcG9ydCBYTUxSZW5kZXJDb25maWdVdGlsaXR5IGZyb20gXCIuLi8uLi8uLi9NYXRlcmlhbHMvQmFzZS9YTUxSZW5kZXJDb25maWdVdGlsaXR5XCI7XG5pbXBvcnQgSVJlbmRlclN0YWdlUmVuZGVyZXJDb25maWd1cmUgZnJvbSBcIi4uL0lSZW5kZXJTdGFnZVJlbmRlcmVyQ29uZmlndXJlXCI7XG5pbXBvcnQgTWF0ZXJpYWxNYW5hZ2VyIGZyb20gXCIuLi8uLi8uLi9NYXRlcmlhbHMvQmFzZS9NYXRlcmlhbE1hbmFnZXJcIjtcbmltcG9ydCBCYXNpY01hdGVyaWFsIGZyb20gXCIuLi8uLi8uLi9NYXRlcmlhbHMvQmFzZS9CYXNpY01hdGVyaWFsXCI7XG5pbXBvcnQgU2NlbmVPYmplY3QgZnJvbSBcIi4uLy4uLy4uL1NjZW5lT2JqZWN0cy9TY2VuZU9iamVjdFwiO1xuaW1wb3J0IEZCTyBmcm9tIFwiLi4vLi4vLi4vUmVzb3VyY2VzL0ZCTy9GQk9cIjtcbmltcG9ydCBKVGhyZWVPYmplY3RXaXRoSUQgZnJvbSBcIi4uLy4uLy4uLy4uL0Jhc2UvSlRocmVlT2JqZWN0V2l0aElEXCI7XG5pbXBvcnQgQ29udGV4dENvbXBvbmVudHMgZnJvbSBcIi4uLy4uLy4uLy4uL0NvbnRleHRDb21wb25lbnRzXCI7XG5pbXBvcnQgUmVzb3VyY2VNYW5hZ2VyIGZyb20gXCIuLi8uLi8uLi9SZXNvdXJjZU1hbmFnZXJcIjtcbmltcG9ydCBKVGhyZWVDb250ZXh0IGZyb20gXCIuLi8uLi8uLi8uLi9KVGhyZWVDb250ZXh0XCI7XG5pbXBvcnQgRkJPV3JhcHBlciBmcm9tIFwiLi4vLi4vLi4vUmVzb3VyY2VzL0ZCTy9GQk9XcmFwcGVyXCI7XG5pbXBvcnQgUmVzb2x2ZWRDaGFpbkluZm8gZnJvbSBcIi4uLy4uL1Jlc29sdmVkQ2hhaW5JbmZvXCI7XG5pbXBvcnQgU2NlbmUgZnJvbSBcIi4uLy4uLy4uL1NjZW5lXCI7XG5jbGFzcyBCYXNpY1RlY2huaXF1ZSBleHRlbmRzIEpUaHJlZU9iamVjdFdpdGhJRCB7XG5cbiAgcHVibGljIGRlZmF1bHRNYXRlcmlhbDogQmFzaWNNYXRlcmlhbDtcblxuICBwdWJsaWMgZGVmYXVsdFJlbmRlckNvbmZpZ3VyZTogSVJlbmRlclN0YWdlUmVuZGVyZXJDb25maWd1cmU7XG5cbiAgcHJvdGVjdGVkIF9fcmVuZGVyU3RhZ2U6IFJTTUxSZW5kZXJTdGFnZTtcblxuICBwcm90ZWN0ZWQgX19mYm86IEZCTztcblxuICBwcm90ZWN0ZWQgX19mYm9Jbml0aWFsaXplZDogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIHByaXZhdGUgX3dpcmVGcmFtZWQ6IGJvb2xlYW4gPSBmYWxzZTtcblxuICBwcml2YXRlIF90ZWNobmlxdWVEb2N1bWVudDogRWxlbWVudDtcblxuICBwcml2YXRlIF90YXJnZXQ6IHN0cmluZztcblxuICBwcml2YXRlIF9mYm9CaW5kaW5nSW5mbzogSUZCT0JpbmRpbmdDb25maWc7XG5cbiAgcHJpdmF0ZSBfdGVjaG5pcXVlSW5kZXg6IG51bWJlcjtcblxuXG4gIHByb3RlY3RlZCBnZXQgX2dsKCk6IFdlYkdMUmVuZGVyaW5nQ29udGV4dCB7XG4gICAgcmV0dXJuIHRoaXMuX19yZW5kZXJTdGFnZS5HTDtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHJlbmRlclN0YWdlOiBSU01MUmVuZGVyU3RhZ2UsIHRlY2huaXF1ZTogRWxlbWVudCwgdGVjaG5pcXVlSW5kZXg6IG51bWJlcikge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5fX3JlbmRlclN0YWdlID0gcmVuZGVyU3RhZ2U7XG4gICAgdGhpcy5fdGVjaG5pcXVlRG9jdW1lbnQgPSB0ZWNobmlxdWU7XG4gICAgdGhpcy5fdGVjaG5pcXVlSW5kZXggPSB0ZWNobmlxdWVJbmRleDtcbiAgICB0aGlzLmRlZmF1bHRSZW5kZXJDb25maWd1cmUgPSBYTUxSZW5kZXJDb25maWdVdGlsaXR5LnBhcnNlUmVuZGVyQ29uZmlnKHRlY2huaXF1ZSwgdGhpcy5fX3JlbmRlclN0YWdlLmdldFN1cGVyUmVuZGVyZXJDb25maWd1cmUoKSk7XG4gICAgdGhpcy5fdGFyZ2V0ID0gdGhpcy5fdGVjaG5pcXVlRG9jdW1lbnQuZ2V0QXR0cmlidXRlKFwidGFyZ2V0XCIpO1xuICAgIHRoaXMuX3dpcmVGcmFtZWQgPSB0aGlzLl90ZWNobmlxdWVEb2N1bWVudC5nZXRBdHRyaWJ1dGUoXCJ3aXJlZnJhbWVcIikgPT09IFwidHJ1ZVwiO1xuICAgIGlmICghdGhpcy5fdGFyZ2V0KSB7IHRoaXMuX3RhcmdldCA9IFwic2NlbmVcIjsgfVxuICAgIHRoaXMuX2Zib0JpbmRpbmdJbmZvID0gUlNNTFJlbmRlckNvbmZpZ1V0aWxpdHkucGFyc2VGQk9Db25maWd1cmF0aW9uKHRoaXMuX3RlY2huaXF1ZURvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKFwiZmJvXCIpLml0ZW0oMCksIHJlbmRlclN0YWdlLlJlbmRlcmVyLkNhbnZhcyk7XG4gICAgaWYgKHRoaXMuX3RhcmdldCAhPT0gXCJzY2VuZVwiKSB7XG4gICAgICB0aGlzLmRlZmF1bHRNYXRlcmlhbCA9IHRoaXMuX2dldE1hdGVyaWFsKCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldCBUYXJnZXQoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5fdGFyZ2V0O1xuICB9XG5cbiAgcHVibGljIHByZVRlY2huaXF1ZShzY2VuZTogU2NlbmUsIHRleHM6IFJlc29sdmVkQ2hhaW5JbmZvKTogdm9pZCB7XG4gICAgdGhpcy5fYXBwbHlCdWZmZXJDb25maWd1cmF0aW9uKHNjZW5lLCB0ZXhzKTtcbiAgfVxuXG4gIHB1YmxpYyByZW5kZXIoc2NlbmU6IFNjZW5lLCBvYmplY3Q6IFNjZW5lT2JqZWN0LCB0ZWNobmlxdWVDb3VudDogbnVtYmVyLCB0ZWNobmlxdWVJbmRleDogbnVtYmVyLCB0ZXhzOiBSZXNvbHZlZENoYWluSW5mbyk6IHZvaWQge1xuICAgIHN3aXRjaCAodGhpcy5UYXJnZXQpIHtcbiAgICAgIGNhc2UgXCJzY2VuZVwiOlxuICAgICAgICBjb25zdCBtYXRlcmlhbEdyb3VwID0gdGhpcy5fdGVjaG5pcXVlRG9jdW1lbnQuZ2V0QXR0cmlidXRlKFwibWF0ZXJpYWxHcm91cFwiKTtcbiAgICAgICAgdGhpcy5fX3JlbmRlclN0YWdlLmRyYXdGb3JNYXRlcmlhbHMoc2NlbmUsIG9iamVjdCwgdGVjaG5pcXVlQ291bnQsIHRlY2huaXF1ZUluZGV4LCB0ZXhzLCBtYXRlcmlhbEdyb3VwLCB0aGlzLl93aXJlRnJhbWVkKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aGlzLmRlZmF1bHRNYXRlcmlhbC5tYXRlcmlhbFZhcmlhYmxlcyA9IHRoaXMuX19yZW5kZXJTdGFnZS5zdGFnZVZhcmlhYmxlcztcbiAgICAgICAgWE1MUmVuZGVyQ29uZmlnVXRpbGl0eS5hcHBseUFsbCh0aGlzLl9nbCwgdGhpcy5kZWZhdWx0UmVuZGVyQ29uZmlndXJlKTtcbiAgICAgICAgdGhpcy5fX3JlbmRlclN0YWdlLmRyYXdGb3JNYXRlcmlhbChzY2VuZSwgb2JqZWN0LCB0ZWNobmlxdWVDb3VudCwgdGVjaG5pcXVlSW5kZXgsIHRleHMsIHRoaXMuZGVmYXVsdE1hdGVyaWFsLCB0aGlzLl93aXJlRnJhbWVkKTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgX19pbml0aWFsaXplRkJPKHRleHM6IFJlc29sdmVkQ2hhaW5JbmZvKTogdm9pZCB7XG4gICAgdGhpcy5fX2Zib0luaXRpYWxpemVkID0gdHJ1ZTtcbiAgICBjb25zdCBybSA9IEpUaHJlZUNvbnRleHQuZ2V0Q29udGV4dENvbXBvbmVudDxSZXNvdXJjZU1hbmFnZXI+KENvbnRleHRDb21wb25lbnRzLlJlc291cmNlTWFuYWdlcik7XG4gICAgdGhpcy5fX2ZibyA9IHJtLmNyZWF0ZUZCTyhcImp0aHJlZS50ZWNobmlxdWUuXCIgKyB0aGlzLklEKTtcbiAgICBjb25zdCBmYm9XcmFwcGVyID0gdGhpcy5fX2Ziby5nZXRGb3JDb250ZXh0KHRoaXMuX19yZW5kZXJTdGFnZS5SZW5kZXJlci5DYW52YXMpO1xuICAgIHRoaXMuX2F0dGFjaFJCT0NvbmZpZ3VyZShmYm9XcmFwcGVyLCB0ZXhzKTtcbiAgICB0aGlzLl9hdHRhY2hUZXh0dXJlQ29uZmlndXJlKGZib1dyYXBwZXIsIHRleHMpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0TWF0ZXJpYWwoKTogQmFzaWNNYXRlcmlhbCB7XG4gICAgY29uc3QgcmF3TWF0ZXJpYWxzID0gdGhpcy5fdGVjaG5pcXVlRG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJtYXRlcmlhbFwiKTtcbiAgICBpZiAocmF3TWF0ZXJpYWxzLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IG1hdGVyaWFsRG9jdW1lbnQgPSA8SFRNTEVsZW1lbnQ+cmF3TWF0ZXJpYWxzLml0ZW0oMCk7XG4gICAgICByZXR1cm4gbmV3IEJhc2ljTWF0ZXJpYWwobWF0ZXJpYWxEb2N1bWVudC5vdXRlckhUTUwsIHRoaXMuX19yZW5kZXJTdGFnZS5zdGFnZU5hbWUgKyB0aGlzLl90ZWNobmlxdWVJbmRleCk7XG4gICAgfVxuICAgIGNvbnN0IG1tID0gSlRocmVlQ29udGV4dC5nZXRDb250ZXh0Q29tcG9uZW50PE1hdGVyaWFsTWFuYWdlcj4oQ29udGV4dENvbXBvbmVudHMuTWF0ZXJpYWxNYW5hZ2VyKTtcbiAgICBjb25zdCBtYXROYW1lID0gdGhpcy5fdGVjaG5pcXVlRG9jdW1lbnQuZ2V0QXR0cmlidXRlKFwibWF0ZXJpYWxcIik7XG4gICAgaWYgKCFtYXROYW1lKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwibWF0ZXJpYWwgbmFtZSB3YXMgbm90IHNwZWNpZmllZC5cIik7XG4gICAgfVxuICAgIHJldHVybiBtbS5jb25zdHJ1Y3RNYXRlcmlhbChtYXROYW1lKTtcbiAgfVxuXG4gIHByaXZhdGUgX2F0dGFjaFRleHR1cmVDb25maWd1cmUoZmJvV3JhcHBlcjogRkJPV3JhcHBlciwgdGV4czogUmVzb2x2ZWRDaGFpbkluZm8pOiB2b2lkIHtcbiAgICAvLyBUT0RPIHN1cHBvcnQgZm9yIG11bHRpcGxlIHJlbmRlcmluZyBidWZmZXJcbiAgICBjb25zdCBjb2xvckNvbmZpZ3VyZSA9IHRoaXMuX2Zib0JpbmRpbmdJbmZvWzBdO1xuICAgIGZib1dyYXBwZXIuYXR0YWNoVGV4dHVyZShXZWJHTFJlbmRlcmluZ0NvbnRleHQuQ09MT1JfQVRUQUNITUVOVDAsIHRleHNbY29sb3JDb25maWd1cmUubmFtZV0gYXMgVGV4dHVyZUJhc2UpO1xuICB9XG5cbiAgcHJpdmF0ZSBfYXR0YWNoUkJPQ29uZmlndXJlKGZib1dyYXBwZXI6IEZCT1dyYXBwZXIsIHRleHM6IFJlc29sdmVkQ2hhaW5JbmZvKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLl9mYm9CaW5kaW5nSW5mby5yYm8pIHsvLyBXaGVuIHRoZXJlIHdhcyBubyByYm8gdGFnIGluIGZibyB0YWcuXG4gICAgICBmYm9XcmFwcGVyLmF0dGFjaFJCTyhXZWJHTFJlbmRlcmluZ0NvbnRleHQuREVQVEhfQVRUQUNITUVOVCwgbnVsbCk7IC8vIFVuYmluZCByZW5kZXIgYnVmZmVyXG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHJib0NvbmZpZ3VyZSA9IHRoaXMuX2Zib0JpbmRpbmdJbmZvLnJibztcbiAgICAgIGxldCB0YXJnZXRCdWZmZXI6IFRleHR1cmVCYXNlIHwgUkJPO1xuICAgICAgbGV0IGlzUkJPID0gdHJ1ZTtcbiAgICAgIGlmIChyYm9Db25maWd1cmUubmFtZSA9PT0gXCJkZWZhdWx0XCIpIHtcbiAgICAgICAgdGFyZ2V0QnVmZmVyID0gdGhpcy5fX3JlbmRlclN0YWdlLkRlZmF1bHRSQk87XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoIXRleHNbcmJvQ29uZmlndXJlLm5hbWVdKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiU3BlY2lmaWVkIHJlbmRlciBidWZmZXIgd2FzIG5vdCBmb3VuZFwiKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0YXJnZXRCdWZmZXIgPSB0ZXhzW3Jib0NvbmZpZ3VyZS5uYW1lXTtcbiAgICAgICAgICBpc1JCTyA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAoaXNSQk8pIHtcbiAgICAgICAgc3dpdGNoIChyYm9Db25maWd1cmUudHlwZSkge1xuICAgICAgICAgIGNhc2UgXCJzdGVuY2lsXCI6XG4gICAgICAgICAgICBmYm9XcmFwcGVyLmF0dGFjaFJCTyhXZWJHTFJlbmRlcmluZ0NvbnRleHQuU1RFTkNJTF9BVFRBQ0hNRU5ULCB0YXJnZXRCdWZmZXIgYXMgUkJPKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgXCJkZXB0aHN0ZW5jaWxcIjpcbiAgICAgICAgICAgIGZib1dyYXBwZXIuYXR0YWNoUkJPKFdlYkdMUmVuZGVyaW5nQ29udGV4dC5ERVBUSF9TVEVOQ0lMX0FUVEFDSE1FTlQsIHRhcmdldEJ1ZmZlciBhcyBSQk8pO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICBjYXNlIFwiZGVwdGhcIjpcbiAgICAgICAgICAgIGZib1dyYXBwZXIuYXR0YWNoUkJPKFdlYkdMUmVuZGVyaW5nQ29udGV4dC5ERVBUSF9BVFRBQ0hNRU5ULCB0YXJnZXRCdWZmZXIgYXMgUkJPKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzd2l0Y2ggKHJib0NvbmZpZ3VyZS50eXBlKSB7XG4gICAgICAgICAgY2FzZSBcInN0ZW5jaWxcIjpcbiAgICAgICAgICAgIGZib1dyYXBwZXIuYXR0YWNoVGV4dHVyZShXZWJHTFJlbmRlcmluZ0NvbnRleHQuU1RFTkNJTF9BVFRBQ0hNRU5ULCB0YXJnZXRCdWZmZXIgYXMgVGV4dHVyZUJhc2UpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSBcImRlcHRoc3RlbmNpbFwiOlxuICAgICAgICAgICAgZmJvV3JhcHBlci5hdHRhY2hUZXh0dXJlKFdlYkdMUmVuZGVyaW5nQ29udGV4dC5ERVBUSF9TVEVOQ0lMX0FUVEFDSE1FTlQsIHRhcmdldEJ1ZmZlciBhcyBUZXh0dXJlQmFzZSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIGNhc2UgXCJkZXB0aFwiOlxuICAgICAgICAgICAgZmJvV3JhcHBlci5hdHRhY2hUZXh0dXJlKFdlYkdMUmVuZGVyaW5nQ29udGV4dC5ERVBUSF9BVFRBQ0hNRU5ULCB0YXJnZXRCdWZmZXIgYXMgVGV4dHVyZUJhc2UpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9hcHBseUJ1ZmZlckNvbmZpZ3VyYXRpb24oc2NlbmU6IFNjZW5lLCB0ZXhzOiBSZXNvbHZlZENoYWluSW5mbyk6IHZvaWQge1xuICAgIGlmICghdGhpcy5fZmJvQmluZGluZ0luZm8gfHwgIXRoaXMuX2Zib0JpbmRpbmdJbmZvWzBdKSB7IC8vIFdoZW4gZmJvIGNvbmZpZ3VyYXRpb24gd2FzIG5vdCBzcGVjaWZpZWRcbiAgICAgIC8vIGlmIHRoZXJlIHdhcyBubyBmYm8gY29uZmlndXJhdGlvbiwgdXNlIHNjcmVlbiBidWZmZXIgYXMgZGVmYXVsdFxuICAgICAgdGhpcy5fYXBwbHlWaWV3cG9ydCh0cnVlKTtcbiAgICAgIHRoaXMuX2dsLmJpbmRGcmFtZWJ1ZmZlcih0aGlzLl9nbC5GUkFNRUJVRkZFUiwgbnVsbCk7XG4gICAgICByZXR1cm47XG4gICAgfSBlbHNlIHsgLy8gUHJvY2VzcyBmYm8gYmluZGluZyBoZXJlXG4gICAgICAvLyBDaGVjayBwcmltYXJ5IGJ1ZmZlciB3YXMgc3BlY2lmaWVkXG4gICAgICBpZiAodGhpcy5fZmJvQmluZGluZ0luZm8ucHJpbWFyeU5hbWUgJiYgIXRleHNbdGhpcy5fZmJvQmluZGluZ0luZm8ucHJpbWFyeU5hbWVdKSB7XG4gICAgICAgIHRoaXMuX29uUHJpbWFyeUJ1ZmZlckZhaWwoKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgdGhpcy5fYXBwbHlWaWV3cG9ydChmYWxzZSk7XG4gICAgICBpZiAoIXRoaXMuX19mYm9Jbml0aWFsaXplZCkge1xuICAgICAgICB0aGlzLl9faW5pdGlhbGl6ZUZCTyh0ZXhzKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuX19mYm8uZ2V0Rm9yQ29udGV4dCh0aGlzLl9fcmVuZGVyU3RhZ2UuUmVuZGVyZXIuQ2FudmFzKS5iaW5kKCk7XG4gICAgICB0aGlzLl9jbGVhckJ1ZmZlcnMoKTtcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIFdoZW4gcHJpbWFyeSBidWZmZXIgd2FzIGZhaWxlZCB0byBiaW5kLCB0aGlzIG1ldGhvZCBiaW5kIGRlZmF1bHQgYnVmZmVyIGFzIGRyYXdpbmcgdGFyZ2V0LlxuICAgKi9cbiAgcHJpdmF0ZSBfb25QcmltYXJ5QnVmZmVyRmFpbCgpOiB2b2lkIHtcbiAgICB0aGlzLl9hcHBseVZpZXdwb3J0KHRydWUpO1xuICAgIHRoaXMuX2dsLmJpbmRGcmFtZWJ1ZmZlcih0aGlzLl9nbC5GUkFNRUJVRkZFUiwgbnVsbCk7XG4gICAgaWYgKHRoaXMuX2Zib0JpbmRpbmdJbmZvLnJibyAmJiB0aGlzLl9mYm9CaW5kaW5nSW5mby5yYm8ubmVlZENsZWFyKSB7XG4gICAgICB0aGlzLl9nbC5kZXB0aE1hc2sodHJ1ZSk7XG4gICAgICB0aGlzLl9nbC5jbGVhckRlcHRoKHRoaXMuX2Zib0JpbmRpbmdJbmZvLnJiby5jbGVhckRlcHRoKTtcbiAgICAgIHRoaXMuX2dsLmNsZWFyKHRoaXMuX2dsLkRFUFRIX0JVRkZFUl9CSVQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX2NsZWFyQnVmZmVycygpOiB2b2lkIHtcbiAgICAvLyBDbGVhciBjb2xvciBidWZmZXJcbiAgICAvLyBUT0RPOiBzdXBwb3J0IGZvciBtdWx0aXBsZSBidWZmZXJzXG4gICAgaWYgKHRoaXMuX2Zib0JpbmRpbmdJbmZvWzBdICYmIHRoaXMuX2Zib0JpbmRpbmdJbmZvWzBdLm5lZWRDbGVhcikge1xuICAgICAgY29uc3QgYnVmZmVyID0gdGhpcy5fZmJvQmluZGluZ0luZm9bMF07XG4gICAgICBjb25zdCBjb2wgPSBidWZmZXIuY2xlYXJDb2xvcjtcbiAgICAgIHRoaXMuX2dsLmNvbG9yTWFzayh0cnVlLCB0cnVlLCB0cnVlLCB0cnVlKTtcbiAgICAgIHRoaXMuX2dsLmNsZWFyQ29sb3IoY29sLlgsIGNvbC5ZLCBjb2wuWiwgY29sLlcpO1xuICAgICAgdGhpcy5fZ2wuY2xlYXIodGhpcy5fZ2wuQ09MT1JfQlVGRkVSX0JJVCk7XG4gICAgfVxuICAgIGlmICh0aGlzLl9mYm9CaW5kaW5nSW5mby5yYm8gJiYgdGhpcy5fZmJvQmluZGluZ0luZm8ucmJvLm5lZWRDbGVhcikge1xuICAgICAgdGhpcy5fZ2wuZGVwdGhNYXNrKHRydWUpO1xuICAgICAgdGhpcy5fZ2wuY2xlYXJEZXB0aCh0aGlzLl9mYm9CaW5kaW5nSW5mby5yYm8uY2xlYXJEZXB0aCk7XG4gICAgICB0aGlzLl9nbC5jbGVhcih0aGlzLl9nbC5ERVBUSF9CVUZGRVJfQklUKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9hcHBseVZpZXdwb3J0KGlzRGVmYXVsdDogYm9vbGVhbik6IHZvaWQge1xuICAgIGlmIChpc0RlZmF1bHQpIHtcbiAgICAgIHRoaXMuX19yZW5kZXJTdGFnZS5SZW5kZXJlci5hcHBseURlZmF1bHRCdWZmZXJWaWV3cG9ydCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9fcmVuZGVyU3RhZ2UuUmVuZGVyZXIuYXBwbHlSZW5kZXJlckJ1ZmZlclZpZXdwb3J0KCk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEJhc2ljVGVjaG5pcXVlO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9

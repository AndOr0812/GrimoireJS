import AsyncLoader from "./Resources/AsyncLoader";
import ImageLoader from "./Resources/ImageLoader";
import jThreeObject from "../Base/JThreeObject";
import Buffer from "./Resources/Buffer/Buffer";
import Shader from "./Resources/Shader/Shader";
import Program from "./Resources/Program/Program";
import Texture from "./Resources/Texture/Texture";
import RBO from "./Resources/RBO/RBO";
import ResourceArray from "./Resources/ResourceArray";
import FBO from "./Resources/FBO/FBO";
import BufferTexture from "./Resources/Texture/BufferTexture";
import CubeTexture from "./Resources/Texture/CubeTexture";
import ContextComponents from "../ContextComponents";
import Q from "q";
/**
 * コンテキストを跨いでリソースを管理するクラスをまとめているクラス
 */
class ResourceManager extends jThreeObject {
    constructor(...args) {
        super(...args);
        this._buffers = new ResourceArray();
        this._shaders = new ResourceArray();
        this._programs = new ResourceArray();
        this._textures = new ResourceArray();
        this._rbos = new ResourceArray();
        this._fbos = new ResourceArray();
    }
    getContextComponentIndex() {
        return ContextComponents.ResourceManager;
    }
    loadTexture(src) {
        const deferred = Q.defer();
        if (this.getTexture(src)) {
            process.nextTick(() => {
                deferred.resolve(this.getTexture(src));
            });
        }
        ImageLoader.loadImage(src).then((tag) => {
            const texture = this.createTextureWithSource(src, tag);
            deferred.resolve(texture);
        }, (error) => {
            console.error(error);
            deferred.reject(error);
        });
        return deferred.promise;
    }
    loadCubeTexture(srcs) {
        const deferred = Q.defer();
        let id = "";
        let absPaths = [, , , , ,];
        for (let i = 0; i < 6; i++) {
            absPaths[i] = AsyncLoader.getAbsolutePath(srcs[i]);
            id += absPaths[i];
        }
        if (this.getTexture(id)) {
            process.nextTick(() => {
                deferred.resolve(this.getTexture(id));
            });
        }
        else {
            const promises = [, , , , ,];
            for (let i = 0; i < 6; i++) {
                promises[i] = ImageLoader.loadImage(absPaths[i]);
            }
            Q.all(promises).then((textures) => {
                deferred.resolve(this.createCubeTextureWithSource(id, textures, false));
            });
        }
        return deferred.promise;
    }
    createBuffer(id, target, usage, unitCount, elementType) {
        return this._buffers.create(id, () => {
            return new Buffer(target, usage, unitCount, elementType);
        });
    }
    getBuffer(id) {
        return this._buffers.get(id);
    }
    createShader(id, source, shaderType) {
        return this._shaders.create(id, () => {
            return Shader.createShader(source, shaderType);
        });
    }
    getShader(id) {
        return this._shaders.get(id);
    }
    hasShader(id) {
        return this._shaders.has(id);
    }
    createProgram(id, shaders) {
        return this._programs.create(id, () => {
            return Program.createProgram(shaders);
        });
    }
    getProgram(id) {
        return this._programs.get(id);
    }
    createTextureWithSource(id, source) {
        return this._textures.create(id, () => {
            const tex = new Texture(source, id);
            tex.each(v => v.init()); // TODO no need?
            return tex;
        });
    }
    getTexture(id) {
        return this._textures.get(id);
    }
    createCubeTextureWithSource(id, sources, flipY = false) {
        return this._textures.create(id, () => {
            const cubeTexture = new CubeTexture(sources, id, flipY);
            cubeTexture.each(v => v.init());
            return cubeTexture;
        });
    }
    createRBO(id, width, height) {
        return this._rbos.create(id, () => {
            const r = new RBO(width, height);
            r.each(v => v.init());
            return r;
        });
    }
    getRBO(id) {
        return this._rbos.get(id);
    }
    createFBO(id) {
        return this._fbos.create(id, () => {
            const fbo = new FBO();
            fbo.each(v => v.init());
            return fbo;
        });
    }
    getFBO(id) {
        return this._fbos.get(id);
    }
    createTexture(id, width, height, texType = WebGLRenderingContext.RGBA, elemType = WebGLRenderingContext.UNSIGNED_BYTE) {
        return this._textures.create(id, () => {
            const bt = new BufferTexture(width, height, texType, elemType, id);
            bt.each(v => v.init());
            return bt;
        });
    }
}
export default ResourceManager;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkNvcmUvUmVzb3VyY2VNYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJPQUFPLFdBQVcsTUFBTSx5QkFBeUI7T0FDMUMsV0FBVyxNQUFNLHlCQUF5QjtPQUMxQyxZQUFZLE1BQU0sc0JBQXNCO09BQ3hDLE1BQU0sTUFBTSwyQkFBMkI7T0FDdkMsTUFBTSxNQUFNLDJCQUEyQjtPQUN2QyxPQUFPLE1BQU0sNkJBQTZCO09BQzFDLE9BQU8sTUFBTSw2QkFBNkI7T0FDMUMsR0FBRyxNQUFNLHFCQUFxQjtPQUM5QixhQUFhLE1BQU0sMkJBQTJCO09BQzlDLEdBQUcsTUFBTSxxQkFBcUI7T0FDOUIsYUFBYSxNQUFNLG1DQUFtQztPQUV0RCxXQUFXLE1BQU0saUNBQWlDO09BRWxELGlCQUFpQixNQUFNLHNCQUFzQjtPQUM3QyxDQUFDLE1BQU0sR0FBRztBQUdqQjs7R0FFRztBQUNILDhCQUE4QixZQUFZO0lBQTFDO1FBQThCLGVBQVk7UUFFaEMsYUFBUSxHQUEwQixJQUFJLGFBQWEsRUFBVSxDQUFDO1FBRTlELGFBQVEsR0FBMEIsSUFBSSxhQUFhLEVBQVUsQ0FBQztRQUU5RCxjQUFTLEdBQTJCLElBQUksYUFBYSxFQUFXLENBQUM7UUFFakUsY0FBUyxHQUErQixJQUFJLGFBQWEsRUFBZSxDQUFDO1FBRXpFLFVBQUssR0FBdUIsSUFBSSxhQUFhLEVBQU8sQ0FBQztRQUVyRCxVQUFLLEdBQXVCLElBQUksYUFBYSxFQUFPLENBQUM7SUFxSS9ELENBQUM7SUFuSVEsd0JBQXdCO1FBQzdCLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxlQUFlLENBQUM7SUFDM0MsQ0FBQztJQUVNLFdBQVcsQ0FBQyxHQUFXO1FBQzVCLE1BQU0sUUFBUSxHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQWUsQ0FBQztRQUN4QyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN6QixPQUFPLENBQUMsUUFBUSxDQUFDO2dCQUNm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QU0sR0FBRyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7WUFDdEIsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7WUFDeEIsTUFBTSxDQUFDLEdBQUcsQ0FBQztRQUNiLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVNLE1BQU0sQ0FBQyxFQUFVO1FBQ3RCLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUM1QixDQUFDO0lBRU0sYUFBYSxDQUFDLEVBQVUsRUFBRSxLQUFhLEVBQUUsTUFBYyxFQUFFLE9BQU8sR0FBVyxxQkFBcUIsQ0FBQyxJQUFJLEVBQUUsUUFBUSxHQUFXLHFCQUFxQixDQUFDLGFBQWE7UUFDbEssTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRTtZQUMvQixNQUFNLEVBQUUsR0FBRyxJQUFJLGFBQWEsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDbkUsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7WUFDdkIsTUFBTSxDQUFDLEVBQUUsQ0FBQztRQUNaLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztBQUNILENBQUM7QUFDRCxlQUFlLGVBQWUsQ0FBQyIsImZpbGUiOiJDb3JlL1Jlc291cmNlTWFuYWdlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBBc3luY0xvYWRlciBmcm9tIFwiLi9SZXNvdXJjZXMvQXN5bmNMb2FkZXJcIjtcbmltcG9ydCBJbWFnZUxvYWRlciBmcm9tIFwiLi9SZXNvdXJjZXMvSW1hZ2VMb2FkZXJcIjtcbmltcG9ydCBqVGhyZWVPYmplY3QgZnJvbSBcIi4uL0Jhc2UvSlRocmVlT2JqZWN0XCI7XG5pbXBvcnQgQnVmZmVyIGZyb20gXCIuL1Jlc291cmNlcy9CdWZmZXIvQnVmZmVyXCI7XG5pbXBvcnQgU2hhZGVyIGZyb20gXCIuL1Jlc291cmNlcy9TaGFkZXIvU2hhZGVyXCI7XG5pbXBvcnQgUHJvZ3JhbSBmcm9tIFwiLi9SZXNvdXJjZXMvUHJvZ3JhbS9Qcm9ncmFtXCI7XG5pbXBvcnQgVGV4dHVyZSBmcm9tIFwiLi9SZXNvdXJjZXMvVGV4dHVyZS9UZXh0dXJlXCI7XG5pbXBvcnQgUkJPIGZyb20gXCIuL1Jlc291cmNlcy9SQk8vUkJPXCI7XG5pbXBvcnQgUmVzb3VyY2VBcnJheSBmcm9tIFwiLi9SZXNvdXJjZXMvUmVzb3VyY2VBcnJheVwiO1xuaW1wb3J0IEZCTyBmcm9tIFwiLi9SZXNvdXJjZXMvRkJPL0ZCT1wiO1xuaW1wb3J0IEJ1ZmZlclRleHR1cmUgZnJvbSBcIi4vUmVzb3VyY2VzL1RleHR1cmUvQnVmZmVyVGV4dHVyZVwiO1xuaW1wb3J0IFRleHR1cmVCYXNlIGZyb20gXCIuL1Jlc291cmNlcy9UZXh0dXJlL1RleHR1cmVCYXNlXCI7XG5pbXBvcnQgQ3ViZVRleHR1cmUgZnJvbSBcIi4vUmVzb3VyY2VzL1RleHR1cmUvQ3ViZVRleHR1cmVcIjtcbmltcG9ydCBJQ29udGV4dENvbXBvbmVudCBmcm9tIFwiLi4vSUNvbnRleHRDb21wb25lbnRcIjtcbmltcG9ydCBDb250ZXh0Q29tcG9uZW50cyBmcm9tIFwiLi4vQ29udGV4dENvbXBvbmVudHNcIjtcbmltcG9ydCBRIGZyb20gXCJxXCI7XG50eXBlIEltYWdlU291cmNlID0gSFRNTENhbnZhc0VsZW1lbnQgfCBIVE1MSW1hZ2VFbGVtZW50IHwgSW1hZ2VEYXRhIHwgQXJyYXlCdWZmZXJWaWV3O1xuXG4vKipcbiAqIOOCs+ODs+ODhuOCreOCueODiOOCkui3qOOBhOOBp+ODquOCveODvOOCueOCkueuoeeQhuOBmeOCi+OCr+ODqeOCueOCkuOBvuOBqOOCgeOBpuOBhOOCi+OCr+ODqeOCuVxuICovXG5jbGFzcyBSZXNvdXJjZU1hbmFnZXIgZXh0ZW5kcyBqVGhyZWVPYmplY3QgaW1wbGVtZW50cyBJQ29udGV4dENvbXBvbmVudCB7XG5cbiAgcHJpdmF0ZSBfYnVmZmVyczogUmVzb3VyY2VBcnJheTxCdWZmZXI+ID0gbmV3IFJlc291cmNlQXJyYXk8QnVmZmVyPigpO1xuXG4gIHByaXZhdGUgX3NoYWRlcnM6IFJlc291cmNlQXJyYXk8U2hhZGVyPiA9IG5ldyBSZXNvdXJjZUFycmF5PFNoYWRlcj4oKTtcblxuICBwcml2YXRlIF9wcm9ncmFtczogUmVzb3VyY2VBcnJheTxQcm9ncmFtPiA9IG5ldyBSZXNvdXJjZUFycmF5PFByb2dyYW0+KCk7XG5cbiAgcHJpdmF0ZSBfdGV4dHVyZXM6IFJlc291cmNlQXJyYXk8VGV4dHVyZUJhc2U+ID0gbmV3IFJlc291cmNlQXJyYXk8VGV4dHVyZUJhc2U+KCk7XG5cbiAgcHJpdmF0ZSBfcmJvczogUmVzb3VyY2VBcnJheTxSQk8+ID0gbmV3IFJlc291cmNlQXJyYXk8UkJPPigpO1xuXG4gIHByaXZhdGUgX2Zib3M6IFJlc291cmNlQXJyYXk8RkJPPiA9IG5ldyBSZXNvdXJjZUFycmF5PEZCTz4oKTtcblxuICBwdWJsaWMgZ2V0Q29udGV4dENvbXBvbmVudEluZGV4KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIENvbnRleHRDb21wb25lbnRzLlJlc291cmNlTWFuYWdlcjtcbiAgfVxuXG4gIHB1YmxpYyBsb2FkVGV4dHVyZShzcmM6IHN0cmluZyk6IFEuSVByb21pc2U8VGV4dHVyZUJhc2U+IHtcbiAgICBjb25zdCBkZWZlcnJlZCA9IFEuZGVmZXI8VGV4dHVyZUJhc2U+KCk7XG4gICAgaWYgKHRoaXMuZ2V0VGV4dHVyZShzcmMpKSB7IC8vIFdoZW4gdGhlIHJlcXVlc3RlZCB0ZXh0dXJlIHdhcyBsb2FkZWQgYWxyZWFkeVxuICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB7XG4gICAgICAgIGRlZmVycmVkLnJlc29sdmUodGhpcy5nZXRUZXh0dXJlKHNyYykpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIEltYWdlTG9hZGVyLmxvYWRJbWFnZShzcmMpLnRoZW4oKHRhZykgPT4geyAvLyBXaGVuIHRoZSByZXF1ZXN0ZWQgdGV4dHVyZSB3YXMgbm90IGxvYWRlZCB5ZXRcbiAgICAgIGNvbnN0IHRleHR1cmUgPSB0aGlzLmNyZWF0ZVRleHR1cmVXaXRoU291cmNlKHNyYywgdGFnKTtcbiAgICAgIGRlZmVycmVkLnJlc29sdmUodGV4dHVyZSk7XG4gICAgfSwgKGVycm9yKSA9PiB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICBkZWZlcnJlZC5yZWplY3QoZXJyb3IpO1xuICAgICAgfSk7XG4gICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG4gIH1cblxuICBwdWJsaWMgbG9hZEN1YmVUZXh0dXJlKHNyY3M6IHN0cmluZ1tdKTogUS5JUHJvbWlzZTxDdWJlVGV4dHVyZT4ge1xuICAgIGNvbnN0IGRlZmVycmVkID0gUS5kZWZlcjxDdWJlVGV4dHVyZT4oKTtcbiAgICBsZXQgaWQgPSBcIlwiO1xuICAgIGxldCBhYnNQYXRocyA9IFssICwgLCAsICwgXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDY7IGkrKykge1xuICAgICAgYWJzUGF0aHNbaV0gPSBBc3luY0xvYWRlci5nZXRBYnNvbHV0ZVBhdGgoc3Jjc1tpXSk7XG4gICAgICBpZCArPSBhYnNQYXRoc1tpXTtcbiAgICB9XG4gICAgaWYgKHRoaXMuZ2V0VGV4dHVyZShpZCkpIHtcbiAgICAgIHByb2Nlc3MubmV4dFRpY2soKCkgPT4ge1xuICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKDxDdWJlVGV4dHVyZT50aGlzLmdldFRleHR1cmUoaWQpKTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBwcm9taXNlczogUS5JUHJvbWlzZTxIVE1MSW1hZ2VFbGVtZW50PltdID0gWywgLCAsICwgLCBdO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA2OyBpKyspIHtcbiAgICAgICAgcHJvbWlzZXNbaV0gPSBJbWFnZUxvYWRlci5sb2FkSW1hZ2UoYWJzUGF0aHNbaV0pO1xuICAgICAgfVxuICAgICAgUS5hbGwocHJvbWlzZXMpLnRoZW4oKHRleHR1cmVzKSA9PiB7XG4gICAgICAgIGRlZmVycmVkLnJlc29sdmUodGhpcy5jcmVhdGVDdWJlVGV4dHVyZVdpdGhTb3VyY2UoaWQsIHRleHR1cmVzLCBmYWxzZSkpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xuICB9XG5cbiAgcHVibGljIGNyZWF0ZUJ1ZmZlcihpZDogc3RyaW5nLCB0YXJnZXQ6IG51bWJlciwgdXNhZ2U6IG51bWJlciwgdW5pdENvdW50OiBudW1iZXIsIGVsZW1lbnRUeXBlOiBudW1iZXIpOiBCdWZmZXIge1xuICAgIHJldHVybiB0aGlzLl9idWZmZXJzLmNyZWF0ZShpZCwgKCkgPT4ge1xuICAgICAgcmV0dXJuIG5ldyBCdWZmZXIodGFyZ2V0LCB1c2FnZSwgdW5pdENvdW50LCBlbGVtZW50VHlwZSk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0QnVmZmVyKGlkOiBzdHJpbmcpOiBCdWZmZXIge1xuICAgIHJldHVybiB0aGlzLl9idWZmZXJzLmdldChpZCk7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlU2hhZGVyKGlkOiBzdHJpbmcsIHNvdXJjZTogc3RyaW5nLCBzaGFkZXJUeXBlOiBudW1iZXIpOiBTaGFkZXIge1xuICAgIHJldHVybiB0aGlzLl9zaGFkZXJzLmNyZWF0ZShpZCwgKCkgPT4ge1xuICAgICAgcmV0dXJuIFNoYWRlci5jcmVhdGVTaGFkZXIoc291cmNlLCBzaGFkZXJUeXBlKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRTaGFkZXIoaWQ6IHN0cmluZyk6IFNoYWRlciB7XG4gICAgcmV0dXJuIHRoaXMuX3NoYWRlcnMuZ2V0KGlkKTtcbiAgfVxuXG4gIHB1YmxpYyBoYXNTaGFkZXIoaWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLl9zaGFkZXJzLmhhcyhpZCk7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlUHJvZ3JhbShpZDogc3RyaW5nLCBzaGFkZXJzOiBTaGFkZXJbXSk6IFByb2dyYW0ge1xuICAgIHJldHVybiB0aGlzLl9wcm9ncmFtcy5jcmVhdGUoaWQsICgpID0+IHtcbiAgICAgIHJldHVybiBQcm9ncmFtLmNyZWF0ZVByb2dyYW0oc2hhZGVycyk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0UHJvZ3JhbShpZDogc3RyaW5nKTogUHJvZ3JhbSB7XG4gICAgcmV0dXJuIHRoaXMuX3Byb2dyYW1zLmdldChpZCk7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlVGV4dHVyZVdpdGhTb3VyY2UoaWQ6IHN0cmluZywgc291cmNlOiBJbWFnZVNvdXJjZSk6IFRleHR1cmUge1xuICAgIHJldHVybiA8VGV4dHVyZT50aGlzLl90ZXh0dXJlcy5jcmVhdGUoaWQsICgpID0+IHtcbiAgICAgIGNvbnN0IHRleCA9IG5ldyBUZXh0dXJlKHNvdXJjZSwgaWQpO1xuICAgICAgdGV4LmVhY2godiA9PiB2LmluaXQoKSk7IC8vIFRPRE8gbm8gbmVlZD9cbiAgICAgIHJldHVybiB0ZXg7XG4gICAgfSk7XG4gIH1cblxuXG4gIHB1YmxpYyBnZXRUZXh0dXJlKGlkOiBzdHJpbmcpOiBUZXh0dXJlQmFzZSB7XG4gICAgcmV0dXJuIDxUZXh0dXJlQmFzZT50aGlzLl90ZXh0dXJlcy5nZXQoaWQpO1xuICB9XG5cbiAgcHVibGljIGNyZWF0ZUN1YmVUZXh0dXJlV2l0aFNvdXJjZShpZDogc3RyaW5nLCBzb3VyY2VzOiBJbWFnZVNvdXJjZVtdLCBmbGlwWSA9IGZhbHNlKTogQ3ViZVRleHR1cmUge1xuICAgIHJldHVybiA8Q3ViZVRleHR1cmU+dGhpcy5fdGV4dHVyZXMuY3JlYXRlKGlkLCAoKSA9PiB7XG4gICAgICBjb25zdCBjdWJlVGV4dHVyZSA9IG5ldyBDdWJlVGV4dHVyZShzb3VyY2VzLCBpZCwgZmxpcFkpO1xuICAgICAgY3ViZVRleHR1cmUuZWFjaCh2ID0+IHYuaW5pdCgpKTtcbiAgICAgIHJldHVybiBjdWJlVGV4dHVyZTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVSQk8oaWQ6IHN0cmluZywgd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpOiBSQk8ge1xuICAgIHJldHVybiB0aGlzLl9yYm9zLmNyZWF0ZShpZCwgKCkgPT4ge1xuICAgICAgY29uc3QgciA9IG5ldyBSQk8od2lkdGgsIGhlaWdodCk7XG4gICAgICByLmVhY2godiA9PiB2LmluaXQoKSk7XG4gICAgICByZXR1cm4gcjtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRSQk8oaWQ6IHN0cmluZyk6IFJCTyB7XG4gICAgcmV0dXJuIHRoaXMuX3Jib3MuZ2V0KGlkKTtcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVGQk8oaWQ6IHN0cmluZyk6IEZCTyB7XG4gICAgcmV0dXJuIHRoaXMuX2Zib3MuY3JlYXRlKGlkLCAoKSA9PiB7XG4gICAgICBjb25zdCBmYm8gPSBuZXcgRkJPKCk7XG4gICAgICBmYm8uZWFjaCh2ID0+IHYuaW5pdCgpKTtcbiAgICAgIHJldHVybiBmYm87XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0RkJPKGlkOiBzdHJpbmcpOiBGQk8ge1xuICAgIHJldHVybiB0aGlzLl9mYm9zLmdldChpZCk7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlVGV4dHVyZShpZDogc3RyaW5nLCB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciwgdGV4VHlwZTogbnVtYmVyID0gV2ViR0xSZW5kZXJpbmdDb250ZXh0LlJHQkEsIGVsZW1UeXBlOiBudW1iZXIgPSBXZWJHTFJlbmRlcmluZ0NvbnRleHQuVU5TSUdORURfQllURSk6IEJ1ZmZlclRleHR1cmUge1xuICAgIHJldHVybiB0aGlzLl90ZXh0dXJlcy5jcmVhdGUoaWQsICgpID0+IHtcbiAgICAgIGNvbnN0IGJ0ID0gbmV3IEJ1ZmZlclRleHR1cmUod2lkdGgsIGhlaWdodCwgdGV4VHlwZSwgZWxlbVR5cGUsIGlkKTtcbiAgICAgIGJ0LmVhY2godiA9PiB2LmluaXQoKSk7XG4gICAgICByZXR1cm4gYnQ7XG4gICAgfSk7XG4gIH1cbn1cbmV4cG9ydCBkZWZhdWx0IFJlc291cmNlTWFuYWdlcjtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==

import JThreeObject from "../Base/JThreeObject";
import GomlAttribute from "./GomlAttribute";
import isUndefined from "lodash.isundefined";
/**
 * The class managing attributes of a node.
 */
class AttributeDictionary extends JThreeObject {
    /**
     * @param {node} the node this attribute dictionary has.
     */
    constructor(node) {
        super();
        this._attributes = {};
        this._node = node;
    }
    forEachAttr(callbackfn) {
        Object.keys(this._attributes).forEach((k) => {
            let v = this._attributes[k];
            callbackfn(v, k, this._attributes);
        }, this);
        return this;
    }
    getValue(attrName) {
        const attr = this._attributes[attrName];
        if (attr === undefined) {
            console.warn(`attribute "${attrName}" is not found.`);
        }
        else {
            return attr.Value;
        }
    }
    getValueStr(attrName) {
        const attr = this._attributes[attrName];
        if (attr === undefined) {
            console.warn(`attribute "${attrName}" is not found.`);
        }
        else {
            return attr.ValueStr;
        }
    }
    setValue(attrName, value) {
        const attr = this._attributes[attrName];
        if (attr === undefined) {
            console.warn(`attribute "${attrName}" is not found.`);
        }
        else {
            if (attr.constant) {
                console.error(`attribute: ${attrName} is constant attribute`);
                return;
            }
            attr.Value = value;
        }
    }
    setValueStr(attrName, value) {
        this.setValue(attrName, value);
    }
    getAttribute(attrName) {
        return this._attributes[attrName];
    }
    getAllAttributes() {
        return this._attributes;
    }
    getAnimater(attrName, beginTime, duration, beginVal, endVal, easing, onComplete) {
        const attr = this._attributes[attrName];
        if (attr === undefined) {
            console.warn(`attribute \"${attrName}\" is not found.`);
        }
        else {
            return attr.Converter.getAnimater(attr, beginVal, endVal, beginTime, duration, easing, onComplete);
        }
    }
    /**
     * Check the attribute passed is defined or not.
     */
    isDefined(attrName) {
        return this._attributes[attrName] !== undefined;
    }
    /**
     * Define attributes to the node.
     *
     * This method must not be called outside of Node classes.
     * If you define already defined attribute, it will be replaced.
     */
    defineAttribute(attributes) {
        // console.log("attributes_declaration", attributes);
        for (let key in attributes) {
            const attribute = attributes[key];
            const converter = this._node.nodeManager.configurator.getConverter(attribute.converter);
            if (!converter && (!attribute.reserved || !isUndefined(attribute.converter))) {
                throw new Error(`Converter \"${attribute.converter}\" is not found`);
            }
            const existed_attribute = this.getAttribute(key);
            let gomlAttribute = null;
            if (existed_attribute && existed_attribute.reserved) {
                // console.log("define_attribute(override)", key, attribute, this.node.getTypeName());
                gomlAttribute = existed_attribute;
                gomlAttribute.Converter = converter;
                gomlAttribute.constant = attribute.constant;
                gomlAttribute.Value = gomlAttribute.ValueStr;
                gomlAttribute.reserved = false;
                gomlAttribute.on("changed", attribute.onchanged.bind(this._node));
            }
            else {
                gomlAttribute = new GomlAttribute(key, attribute.value, converter, attribute.reserved, attribute.constant);
                if (attribute.reserved) {
                }
                else {
                    // console.log("define_attribute", key, attribute, this.node.getTypeName());
                    if (attribute.onchanged) {
                        gomlAttribute.on("changed", attribute.onchanged.bind(this._node));
                    }
                    else {
                        console.warn(`attribute "${key}" does not have onchange event handler. this causes lack of attribute's consistency.`);
                    }
                }
                this._attributes[key] = gomlAttribute;
            }
            if (this._node.Mounted && !gomlAttribute.reserved) {
                gomlAttribute.notifyValueChanged();
            }
        }
    }
    /**
     * Reserve attribute for define.
     *
     * This method could be called from outside of Node classes.
     */
    reserveAttribute(name, value) {
        const attribute = { [name]: { value, reserved: true } };
        this.defineAttribute(attribute);
        return this.getAttribute(name);
    }
    /**
     * Emit change events to all attributes
     */
    emitChangeAll() {
        Object.keys(this._attributes).forEach((k) => {
            let v = this._attributes[k];
            if (typeof v.Value !== "undefined") {
                v.notifyValueChanged();
            }
        });
    }
    updateValue(attrName) {
        if (typeof attrName === "undefined") {
            Object.keys(this._attributes).forEach((k) => {
                let v = this._attributes[k];
                v.notifyValueChanged();
            });
        }
        else {
            const target = this._attributes[attrName];
            target.notifyValueChanged();
        }
    }
}
export default AttributeDictionary;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkdvbWwvQXR0cmlidXRlRGljdGlvbmFyeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiT0FDTyxZQUFZLE1BQU0sc0JBQXNCO09BQ3hDLGFBQWEsTUFBTSxpQkFBaUI7T0FLcEMsV0FBVyxNQUFNLG9CQUFvQjtBQUU1Qzs7R0FFRztBQUNILGtDQUFrQyxZQUFZO0lBRTVDOztPQUVHO0lBQ0gsWUFBWSxJQUFzQjtRQUNoQyxPQUFPLENBQUM7UUFNRixnQkFBVyxHQUFxQyxFQUFFLENBQUM7UUFMekQsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7SUFDcEIsQ0FBQztJQU1NLFdBQVcsQ0FBQyxVQUFxRztRQUN0SCxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQ3RDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDNUIsVUFBVSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3JDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNULE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRU0sUUFBUSxDQUFDLFFBQWdCO1FBQzlCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDeEMsRUFBRSxDQUFDLENBQUMsSUFBSSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDdkIsT0FBTyxDQUFDLElBQUksQ0FBQyxjQUFjLFFBQVEsaUJBQWlCLENBQUMsQ0FBQztRQUN4RCxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUNwQixDQUFDO0lBQ0gsQ0FBQztJQUVNLFdBQVcsQ0FBQyxRQUFnQjtRQUNqQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFFB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TUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFDdEMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDNUIsQ0FBQyxDQUFDLGtCQUFrQixFQUFFLENBQUM7WUFDekIsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzFDLE1BQU0sQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1FBQzlCLENBQUM7SUFDSCxDQUFDO0FBQ0gsQ0FBQztBQUVELGVBQWUsbUJBQW1CLENBQUMiLCJmaWxlIjoiR29tbC9BdHRyaWJ1dGVEaWN0aW9uYXJ5LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEFuaW1hdGVyQmFzZSBmcm9tIFwiLi9BbmltYXRlci9BbmltYXRlckJhc2VcIjtcbmltcG9ydCBKVGhyZWVPYmplY3QgZnJvbSBcIi4uL0Jhc2UvSlRocmVlT2JqZWN0XCI7XG5pbXBvcnQgR29tbEF0dHJpYnV0ZSBmcm9tIFwiLi9Hb21sQXR0cmlidXRlXCI7XG5pbXBvcnQge0FjdGlvbjB9IGZyb20gXCIuLi9CYXNlL0RlbGVnYXRlc1wiO1xuaW1wb3J0IEVhc2luZ0Z1bmN0aW9uQmFzZSBmcm9tIFwiLi9FYXNpbmcvRWFzaW5nRnVuY3Rpb25CYXNlXCI7XG5pbXBvcnQgR29tbFRyZWVOb2RlQmFzZSBmcm9tIFwiLi9Hb21sVHJlZU5vZGVCYXNlXCI7XG5pbXBvcnQgQXR0cmlidXRlRGVjbGFyYXRpb24gZnJvbSBcIi4vQXR0cmlidXRlRGVjbGFyYXRpb25cIjtcbmltcG9ydCBpc1VuZGVmaW5lZCBmcm9tIFwibG9kYXNoLmlzdW5kZWZpbmVkXCI7XG5cbi8qKlxuICogVGhlIGNsYXNzIG1hbmFnaW5nIGF0dHJpYnV0ZXMgb2YgYSBub2RlLlxuICovXG5jbGFzcyBBdHRyaWJ1dGVEaWN0aW9uYXJ5IGV4dGVuZHMgSlRocmVlT2JqZWN0IHtcblxuICAvKipcbiAgICogQHBhcmFtIHtub2RlfSB0aGUgbm9kZSB0aGlzIGF0dHJpYnV0ZSBkaWN0aW9uYXJ5IGhhcy5cbiAgICovXG4gIGNvbnN0cnVjdG9yKG5vZGU6IEdvbWxUcmVlTm9kZUJhc2UpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX25vZGUgPSBub2RlO1xuICB9XG5cbiAgcHJpdmF0ZSBfbm9kZTogR29tbFRyZWVOb2RlQmFzZTtcblxuICBwcml2YXRlIF9hdHRyaWJ1dGVzOiB7IFtrZXk6IHN0cmluZ106IEdvbWxBdHRyaWJ1dGUgfSA9IHt9O1xuXG4gIHB1YmxpYyBmb3JFYWNoQXR0cihjYWxsYmFja2ZuOiAodmFsdWU6IEdvbWxBdHRyaWJ1dGUsIGtleTogc3RyaW5nLCBhdHRyaWJ1dGVzOiB7IFtrZXk6IHN0cmluZ106IEdvbWxBdHRyaWJ1dGUgfSkgPT4gdm9pZCk6IEF0dHJpYnV0ZURpY3Rpb25hcnkge1xuICAgIE9iamVjdC5rZXlzKHRoaXMuX2F0dHJpYnV0ZXMpLmZvckVhY2goKGspID0+IHtcbiAgICAgIGxldCB2ID0gdGhpcy5fYXR0cmlidXRlc1trXTtcbiAgICAgIGNhbGxiYWNrZm4odiwgaywgdGhpcy5fYXR0cmlidXRlcyk7XG4gICAgfSwgdGhpcyk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwdWJsaWMgZ2V0VmFsdWUoYXR0ck5hbWU6IHN0cmluZyk6IGFueSB7XG4gICAgY29uc3QgYXR0ciA9IHRoaXMuX2F0dHJpYnV0ZXNbYXR0ck5hbWVdO1xuICAgIGlmIChhdHRyID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGNvbnNvbGUud2FybihgYXR0cmlidXRlIFwiJHthdHRyTmFtZX1cIiBpcyBub3QgZm91bmQuYCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBhdHRyLlZhbHVlO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXRWYWx1ZVN0cihhdHRyTmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCBhdHRyID0gdGhpcy5fYXR0cmlidXRlc1thdHRyTmFtZV07XG4gICAgaWYgKGF0dHIgPT09IHVuZGVmaW5lZCkge1xuICAgICAgY29uc29sZS53YXJuKGBhdHRyaWJ1dGUgXCIke2F0dHJOYW1lfVwiIGlzIG5vdCBmb3VuZC5gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGF0dHIuVmFsdWVTdHI7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHNldFZhbHVlKGF0dHJOYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnkpOiB2b2lkIHtcbiAgICBjb25zdCBhdHRyID0gdGhpcy5fYXR0cmlidXRlc1thdHRyTmFtZV07XG4gICAgaWYgKGF0dHIgPT09IHVuZGVmaW5lZCkge1xuICAgICAgY29uc29sZS53YXJuKGBhdHRyaWJ1dGUgXCIke2F0dHJOYW1lfVwiIGlzIG5vdCBmb3VuZC5gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGF0dHIuY29uc3RhbnQpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihgYXR0cmlidXRlOiAke2F0dHJOYW1lfSBpcyBjb25zdGFudCBhdHRyaWJ1dGVgKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgYXR0ci5WYWx1ZSA9IHZhbHVlO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzZXRWYWx1ZVN0cihhdHRyTmFtZTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5zZXRWYWx1ZShhdHRyTmFtZSwgdmFsdWUpO1xuICB9XG5cbiAgcHVibGljIGdldEF0dHJpYnV0ZShhdHRyTmFtZTogc3RyaW5nKTogR29tbEF0dHJpYnV0ZSB7XG4gICAgcmV0dXJuIHRoaXMuX2F0dHJpYnV0ZXNbYXR0ck5hbWVdO1xuICB9XG5cbiAgcHVibGljIGdldEFsbEF0dHJpYnV0ZXMoKTogeyBba2V5OiBzdHJpbmddOiBHb21sQXR0cmlidXRlIH0ge1xuICAgIHJldHVybiB0aGlzLl9hdHRyaWJ1dGVzO1xuICB9XG5cbiAgcHVibGljIGdldEFuaW1hdGVyKGF0dHJOYW1lOiBzdHJpbmcsIGJlZ2luVGltZTogbnVtYmVyLCBkdXJhdGlvbjogbnVtYmVyLCBiZWdpblZhbDogYW55LCBlbmRWYWw6IGFueSwgZWFzaW5nOiBFYXNpbmdGdW5jdGlvbkJhc2UsIG9uQ29tcGxldGU/OiBBY3Rpb24wKTogQW5pbWF0ZXJCYXNlIHtcbiAgICBjb25zdCBhdHRyID0gdGhpcy5fYXR0cmlidXRlc1thdHRyTmFtZV07XG4gICAgaWYgKGF0dHIgPT09IHVuZGVmaW5lZCkge1xuICAgICAgY29uc29sZS53YXJuKGBhdHRyaWJ1dGUgXFxcIiR7YXR0ck5hbWV9XFxcIiBpcyBub3QgZm91bmQuYCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBhdHRyLkNvbnZlcnRlci5nZXRBbmltYXRlcihhdHRyLCBiZWdpblZhbCwgZW5kVmFsLCBiZWdpblRpbWUsIGR1cmF0aW9uLCBlYXNpbmcsIG9uQ29tcGxldGUpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayB0aGUgYXR0cmlidXRlIHBhc3NlZCBpcyBkZWZpbmVkIG9yIG5vdC5cbiAgICovXG4gIHB1YmxpYyBpc0RlZmluZWQoYXR0ck5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLl9hdHRyaWJ1dGVzW2F0dHJOYW1lXSAhPT0gdW5kZWZpbmVkO1xuICB9XG5cbiAgLyoqXG4gICAqIERlZmluZSBhdHRyaWJ1dGVzIHRvIHRoZSBub2RlLlxuICAgKlxuICAgKiBUaGlzIG1ldGhvZCBtdXN0IG5vdCBiZSBjYWxsZWQgb3V0c2lkZSBvZiBOb2RlIGNsYXNzZXMuXG4gICAqIElmIHlvdSBkZWZpbmUgYWxyZWFkeSBkZWZpbmVkIGF0dHJpYnV0ZSwgaXQgd2lsbCBiZSByZXBsYWNlZC5cbiAgICovXG4gIHB1YmxpYyBkZWZpbmVBdHRyaWJ1dGUoYXR0cmlidXRlczogQXR0cmlidXRlRGVjbGFyYXRpb24pOiB2b2lkIHtcbiAgICAvLyBjb25zb2xlLmxvZyhcImF0dHJpYnV0ZXNfZGVjbGFyYXRpb25cIiwgYXR0cmlidXRlcyk7XG4gICAgZm9yIChsZXQga2V5IGluIGF0dHJpYnV0ZXMpIHtcbiAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZXNba2V5XTtcbiAgICAgIGNvbnN0IGNvbnZlcnRlciA9IHRoaXMuX25vZGUubm9kZU1hbmFnZXIuY29uZmlndXJhdG9yLmdldENvbnZlcnRlcihhdHRyaWJ1dGUuY29udmVydGVyKTtcbiAgICAgIGlmICghY29udmVydGVyICYmICghYXR0cmlidXRlLnJlc2VydmVkIHx8ICFpc1VuZGVmaW5lZChhdHRyaWJ1dGUuY29udmVydGVyKSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb252ZXJ0ZXIgXFxcIiR7YXR0cmlidXRlLmNvbnZlcnRlcn1cXFwiIGlzIG5vdCBmb3VuZGApO1xuICAgICAgfVxuICAgICAgY29uc3QgZXhpc3RlZF9hdHRyaWJ1dGUgPSB0aGlzLmdldEF0dHJpYnV0ZShrZXkpO1xuICAgICAgbGV0IGdvbWxBdHRyaWJ1dGU6IEdvbWxBdHRyaWJ1dGUgPSBudWxsO1xuICAgICAgaWYgKGV4aXN0ZWRfYXR0cmlidXRlICYmIGV4aXN0ZWRfYXR0cmlidXRlLnJlc2VydmVkKSB7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKFwiZGVmaW5lX2F0dHJpYnV0ZShvdmVycmlkZSlcIiwga2V5LCBhdHRyaWJ1dGUsIHRoaXMubm9kZS5nZXRUeXBlTmFtZSgpKTtcbiAgICAgICAgZ29tbEF0dHJpYnV0ZSA9IGV4aXN0ZWRfYXR0cmlidXRlO1xuICAgICAgICBnb21sQXR0cmlidXRlLkNvbnZlcnRlciA9IGNvbnZlcnRlcjtcbiAgICAgICAgZ29tbEF0dHJpYnV0ZS5jb25zdGFudCA9IGF0dHJpYnV0ZS5jb25zdGFudDtcbiAgICAgICAgZ29tbEF0dHJpYnV0ZS5WYWx1ZSA9IGdvbWxBdHRyaWJ1dGUuVmFsdWVTdHI7XG4gICAgICAgIGdvbWxBdHRyaWJ1dGUucmVzZXJ2ZWQgPSBmYWxzZTtcbiAgICAgICAgZ29tbEF0dHJpYnV0ZS5vbihcImNoYW5nZWRcIiwgYXR0cmlidXRlLm9uY2hhbmdlZC5iaW5kKHRoaXMuX25vZGUpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGdvbWxBdHRyaWJ1dGUgPSBuZXcgR29tbEF0dHJpYnV0ZShrZXksIGF0dHJpYnV0ZS52YWx1ZSwgY29udmVydGVyLCBhdHRyaWJ1dGUucmVzZXJ2ZWQsIGF0dHJpYnV0ZS5jb25zdGFudCk7XG4gICAgICAgIGlmIChhdHRyaWJ1dGUucmVzZXJ2ZWQpIHtcbiAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcImRlZmluZV9hdHRyaWJ1dGUodGVtcClcIiwga2V5LCBhdHRyaWJ1dGUsIHRoaXMubm9kZS5nZXRUeXBlTmFtZSgpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcImRlZmluZV9hdHRyaWJ1dGVcIiwga2V5LCBhdHRyaWJ1dGUsIHRoaXMubm9kZS5nZXRUeXBlTmFtZSgpKTtcbiAgICAgICAgICBpZiAoYXR0cmlidXRlLm9uY2hhbmdlZCkge1xuICAgICAgICAgICAgZ29tbEF0dHJpYnV0ZS5vbihcImNoYW5nZWRcIiwgYXR0cmlidXRlLm9uY2hhbmdlZC5iaW5kKHRoaXMuX25vZGUpKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKGBhdHRyaWJ1dGUgXCIke2tleX1cIiBkb2VzIG5vdCBoYXZlIG9uY2hhbmdlIGV2ZW50IGhhbmRsZXIuIHRoaXMgY2F1c2VzIGxhY2sgb2YgYXR0cmlidXRlJ3MgY29uc2lzdGVuY3kuYCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2F0dHJpYnV0ZXNba2V5XSA9IGdvbWxBdHRyaWJ1dGU7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5fbm9kZS5Nb3VudGVkICYmICFnb21sQXR0cmlidXRlLnJlc2VydmVkKSB7XG4gICAgICAgIGdvbWxBdHRyaWJ1dGUubm90aWZ5VmFsdWVDaGFuZ2VkKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJlc2VydmUgYXR0cmlidXRlIGZvciBkZWZpbmUuXG4gICAqXG4gICAqIFRoaXMgbWV0aG9kIGNvdWxkIGJlIGNhbGxlZCBmcm9tIG91dHNpZGUgb2YgTm9kZSBjbGFzc2VzLlxuICAgKi9cbiAgcHVibGljIHJlc2VydmVBdHRyaWJ1dGUobmFtZTogc3RyaW5nLCB2YWx1ZTogYW55KTogR29tbEF0dHJpYnV0ZSB7XG4gICAgY29uc3QgYXR0cmlidXRlOiBBdHRyaWJ1dGVEZWNsYXJhdGlvbiA9IHsgW25hbWVdOiB7IHZhbHVlLCByZXNlcnZlZDogdHJ1ZSB9IH07XG4gICAgdGhpcy5kZWZpbmVBdHRyaWJ1dGUoYXR0cmlidXRlKTtcbiAgICByZXR1cm4gdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSk7XG4gIH1cblxuICAvKipcbiAgICogRW1pdCBjaGFuZ2UgZXZlbnRzIHRvIGFsbCBhdHRyaWJ1dGVzXG4gICAqL1xuICBwdWJsaWMgZW1pdENoYW5nZUFsbCgpOiB2b2lkIHtcbiAgICBPYmplY3Qua2V5cyh0aGlzLl9hdHRyaWJ1dGVzKS5mb3JFYWNoKChrKSA9PiB7XG4gICAgICBsZXQgdiA9IHRoaXMuX2F0dHJpYnV0ZXNba107XG4gICAgICBpZiAodHlwZW9mIHYuVmFsdWUgIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgICAgdi5ub3RpZnlWYWx1ZUNoYW5nZWQoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGVWYWx1ZShhdHRyTmFtZT86IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICh0eXBlb2YgYXR0ck5hbWUgPT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgIE9iamVjdC5rZXlzKHRoaXMuX2F0dHJpYnV0ZXMpLmZvckVhY2goKGspID0+IHtcbiAgICAgICAgbGV0IHYgPSB0aGlzLl9hdHRyaWJ1dGVzW2tdO1xuICAgICAgICB2Lm5vdGlmeVZhbHVlQ2hhbmdlZCgpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuX2F0dHJpYnV0ZXNbYXR0ck5hbWVdO1xuICAgICAgdGFyZ2V0Lm5vdGlmeVZhbHVlQ2hhbmdlZCgpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBBdHRyaWJ1dGVEaWN0aW9uYXJ5O1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9

import CoreRelatedNodeBase from "../../CoreRelatedNodeBase";
import Vector3 from "../../../Math/Vector3";
import Quaternion from "../../../Math/Quaternion";
class SceneObjectNodeBase extends CoreRelatedNodeBase {
    constructor() {
        super();
        /**
         * Scene Object that will be applied to Scene.
         * @type {SceneObject}
         */
        this._sceneObject = null;
        /**
        * SceneObjectNode directly containing this node
        */
        this._parentSceneObjectNode = null;
        /**
        * SceneNode containing this node
        */
        this._containedSceneNode = null;
        this.attributes.defineAttribute({
            "position": {
                value: new Vector3(0, 0, 0),
                converter: "vec3",
                onchanged: this._onPositionAttrChanged__SceneObjectNodeBase.bind(this),
            },
            "scale": {
                value: new Vector3(1, 1, 1),
                converter: "vec3",
                onchanged: this._onScaleAttrChanged__SceneObjectNodeBase.bind(this),
            },
            "rotation": {
                value: Quaternion.Identity,
                converter: "rotation",
                onchanged: this._onRotationAttrChanged__SceneObjectNodeBase.bind(this),
            },
            "name": {
                value: void 0,
                converter: "string",
                onchanged: this._onNameAttrChanged__SceneObjectNodeBase.bind(this),
            }
        });
        this.on("update-scene-object", (obj) => {
            this._onPositionAttrChanged__SceneObjectNodeBase.call(this, this.attributes.getAttribute("position"));
            this._onScaleAttrChanged__SceneObjectNodeBase.call(this, this.attributes.getAttribute("scale"));
            this._onRotationAttrChanged__SceneObjectNodeBase.call(this, this.attributes.getAttribute("rotation"));
            this._onNameAttrChanged__SceneObjectNodeBase.call(this, this.attributes.getAttribute("name"));
        });
    }
    get ParentSceneObjectNode() {
        return this._parentSceneObjectNode;
    }
    get ContainedSceneNode() {
        return this._containedSceneNode;
    }
    __onMount() {
        super.__onMount();
        let containedSceneNode = null;
        let parentSceneObjectNode = null;
        // This parent node is scene node.
        if (this.__parent.getTypeName() === "SceneNode") {
            containedSceneNode = this.__parent;
            parentSceneObjectNode = null;
        }
        else {
            // check parent extends SceneObjectNodeBase or not.
            if (typeof this.__parent.ContainedSceneNode === "undefined") {
                console.error(`${this.__parent.toString()} is not extends SceneObjectNodeBase. Is this really ok to be contained in Scene tag?`);
                return;
            }
            else {
                parentSceneObjectNode = this.__parent;
                containedSceneNode = parentSceneObjectNode.ContainedSceneNode;
            }
        }
        this._containedSceneNode = containedSceneNode;
        this._parentSceneObjectNode = parentSceneObjectNode;
    }
    __onUnmount() {
        super.__onUnmount();
    }
    _onPositionAttrChanged__SceneObjectNodeBase(attr) {
        if (this._sceneObject) {
            this._sceneObject.Transformer.Position = attr.Value;
            attr.done();
        }
    }
    _onScaleAttrChanged__SceneObjectNodeBase(attr) {
        if (this._sceneObject) {
            this._sceneObject.Transformer.Scale = attr.Value;
            attr.done();
        }
    }
    _onRotationAttrChanged__SceneObjectNodeBase(attr) {
        if (this._sceneObject) {
            this._sceneObject.Transformer.Rotation = attr.Value;
            attr.done();
        }
    }
    _onNameAttrChanged__SceneObjectNodeBase(attr) {
        if (this._sceneObject) {
            this._sceneObject.name = attr.Value;
            attr.done();
        }
    }
    /**
     * update SceneObject child. using this.sceneObject to previus object, so do not change it before call this method.
     * @param {SceneObject} obj [description]
     */
    _updateSceneObjectChild(obj) {
        if (typeof obj === "undefined") {
            console.error(`${this.getTypeName()}: sceneObject is undefined. It must be null or instance.`);
            obj = null;
        }
        // previus object is exist in child, remove child
        if (this._sceneObject !== null) {
            if (this.ParentSceneObjectNode === null) {
                this._containedSceneNode.target.removeObject(this._sceneObject);
            }
            else {
                if (this._parentSceneObjectNode.TargetSceneObject === null) {
                    return;
                }
                this._parentSceneObjectNode.TargetSceneObject.removeChild(this._sceneObject);
            }
        }
        if (obj !== null) {
            if (this.ParentSceneObjectNode === null) {
                this._containedSceneNode.target.addObject(obj);
            }
            else {
                if (this._parentSceneObjectNode.TargetSceneObject === null) {
                    return;
                }
                this._parentSceneObjectNode.TargetSceneObject.addChild(obj);
            }
        }
    }
    /**
     * Change the SceneObject that is applied to Scene Hierarchy.
     * @param {SceneObject} obj [description]
     */
    set TargetSceneObject(obj) {
        this._updateSceneObjectChild(obj);
        this._sceneObject = obj;
        this.target = obj;
        this.emit("update-scene-object", this.target);
    }
    /**
     * Get the SceneObject that is applied to Scene Hierarchy.
     * @return {SceneObject} [description]
     */
    get TargetSceneObject() {
        return this._sceneObject;
    }
}
export default SceneObjectNodeBase;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkdvbWwvTm9kZXMvU2NlbmVPYmplY3RzL1NjZW5lT2JqZWN0Tm9kZUJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ik9BQU8sbUJBQW1CLE1BQU0sMkJBQTJCO09BR3BELE9BQU8sTUFBTSx1QkFBdUI7T0FDcEMsVUFBVSxNQUFNLDBCQUEwQjtBQUdqRCxrQ0FBeUQsbUJBQW1CO0lBaUIxRTtRQUNFLE9BQU8sQ0FBQztRQWpCVjs7O1dBR0c7UUFDSyxpQkFBWSxHQUFNLElBQUksQ0FBQztRQUUvQjs7VUFFRTtRQUNNLDJCQUFzQixHQUFxQyxJQUFJLENBQUM7UUFFeEU7O1VBRUU7UUFDTSx3QkFBbUIsR0FBYyxJQUFJLENBQUM7UUFJNUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUM7WUFDOUIsVUFBVSxFQUFFO2dCQUNWLEtBQUssRUFBRSxJQUFJLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDM0IsU0FBUyxFQUFFLE1BQU07Z0JBQ2pCLFNBQVMsRUFBRSxJQUFJLENBQUMsMkNBQTJDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQzthQUN2RTtZQUNELE9BQU8sRUFBRTtnQkFDUCxLQUFLLEVBQUUsSUFBSSxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQzNCLFNBQVMsRUFBRSxNQUFNO2dCQUNqQixTQUFTLEVBQUUsSUFBSSxDQUFDLHdDQUF3QyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7YUFDcEU7WUFDRCxVQUFVLEVBQUU7Z0JBQ1YsS0FBSyxFQUFFLFVBQVUsQ0FBQyxRQUFRO2dCQUMxQixTQUFTLEVBQUUsVUFBVTtnQkFDckIsU0FBUyxFQUFFLElBQUksQ0FBQywyQ0FBMkMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO2FBQ3ZFO1lBQ0QsTUFBTSxFQUFFO2dCQUNOLEtBQUssRUFBRSxLQUFLLENBQUM7Z0JBQ2IsU0FBUyxFQUFFLFFBQVE7Z0JBQ25CLFNBQVMsRUFB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Tm9kZUJhc2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQ29yZVJlbGF0ZWROb2RlQmFzZSBmcm9tIFwiLi4vLi4vQ29yZVJlbGF0ZWROb2RlQmFzZVwiO1xuaW1wb3J0IFNjZW5lTm9kZSBmcm9tIFwiLi4vU2NlbmVOb2RlXCI7XG5pbXBvcnQgU2NlbmVPYmplY3QgZnJvbSBcIi4uLy4uLy4uL0NvcmUvU2NlbmVPYmplY3RzL1NjZW5lT2JqZWN0XCI7XG5pbXBvcnQgVmVjdG9yMyBmcm9tIFwiLi4vLi4vLi4vTWF0aC9WZWN0b3IzXCI7XG5pbXBvcnQgUXVhdGVybmlvbiBmcm9tIFwiLi4vLi4vLi4vTWF0aC9RdWF0ZXJuaW9uXCI7XG5pbXBvcnQgR29tbEF0dHJpYnV0ZSBmcm9tIFwiLi4vLi4vR29tbEF0dHJpYnV0ZVwiO1xuXG5jbGFzcyBTY2VuZU9iamVjdE5vZGVCYXNlPFQgZXh0ZW5kcyBTY2VuZU9iamVjdD4gZXh0ZW5kcyBDb3JlUmVsYXRlZE5vZGVCYXNlPFQ+IHtcbiAgLyoqXG4gICAqIFNjZW5lIE9iamVjdCB0aGF0IHdpbGwgYmUgYXBwbGllZCB0byBTY2VuZS5cbiAgICogQHR5cGUge1NjZW5lT2JqZWN0fVxuICAgKi9cbiAgcHJpdmF0ZSBfc2NlbmVPYmplY3Q6IFQgPSBudWxsO1xuXG4gIC8qKlxuICAqIFNjZW5lT2JqZWN0Tm9kZSBkaXJlY3RseSBjb250YWluaW5nIHRoaXMgbm9kZVxuICAqL1xuICBwcml2YXRlIF9wYXJlbnRTY2VuZU9iamVjdE5vZGU6IFNjZW5lT2JqZWN0Tm9kZUJhc2U8U2NlbmVPYmplY3Q+ID0gbnVsbDtcblxuICAvKipcbiAgKiBTY2VuZU5vZGUgY29udGFpbmluZyB0aGlzIG5vZGVcbiAgKi9cbiAgcHJpdmF0ZSBfY29udGFpbmVkU2NlbmVOb2RlOiBTY2VuZU5vZGUgPSBudWxsO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5hdHRyaWJ1dGVzLmRlZmluZUF0dHJpYnV0ZSh7XG4gICAgICBcInBvc2l0aW9uXCI6IHtcbiAgICAgICAgdmFsdWU6IG5ldyBWZWN0b3IzKDAsIDAsIDApLFxuICAgICAgICBjb252ZXJ0ZXI6IFwidmVjM1wiLFxuICAgICAgICBvbmNoYW5nZWQ6IHRoaXMuX29uUG9zaXRpb25BdHRyQ2hhbmdlZF9fU2NlbmVPYmplY3ROb2RlQmFzZS5iaW5kKHRoaXMpLFxuICAgICAgfSxcbiAgICAgIFwic2NhbGVcIjoge1xuICAgICAgICB2YWx1ZTogbmV3IFZlY3RvcjMoMSwgMSwgMSksXG4gICAgICAgIGNvbnZlcnRlcjogXCJ2ZWMzXCIsXG4gICAgICAgIG9uY2hhbmdlZDogdGhpcy5fb25TY2FsZUF0dHJDaGFuZ2VkX19TY2VuZU9iamVjdE5vZGVCYXNlLmJpbmQodGhpcyksXG4gICAgICB9LFxuICAgICAgXCJyb3RhdGlvblwiOiB7XG4gICAgICAgIHZhbHVlOiBRdWF0ZXJuaW9uLklkZW50aXR5LFxuICAgICAgICBjb252ZXJ0ZXI6IFwicm90YXRpb25cIixcbiAgICAgICAgb25jaGFuZ2VkOiB0aGlzLl9vblJvdGF0aW9uQXR0ckNoYW5nZWRfX1NjZW5lT2JqZWN0Tm9kZUJhc2UuYmluZCh0aGlzKSxcbiAgICAgIH0sXG4gICAgICBcIm5hbWVcIjoge1xuICAgICAgICB2YWx1ZTogdm9pZCAwLFxuICAgICAgICBjb252ZXJ0ZXI6IFwic3RyaW5nXCIsXG4gICAgICAgIG9uY2hhbmdlZDogdGhpcy5fb25OYW1lQXR0ckNoYW5nZWRfX1NjZW5lT2JqZWN0Tm9kZUJhc2UuYmluZCh0aGlzKSxcbiAgICAgIH1cbiAgICB9KTtcbiAgICB0aGlzLm9uKFwidXBkYXRlLXNjZW5lLW9iamVjdFwiLCAob2JqOiBTY2VuZU9iamVjdCkgPT4ge1xuICAgICAgdGhpcy5fb25Qb3NpdGlvbkF0dHJDaGFuZ2VkX19TY2VuZU9iamVjdE5vZGVCYXNlLmNhbGwodGhpcywgdGhpcy5hdHRyaWJ1dGVzLmdldEF0dHJpYnV0ZShcInBvc2l0aW9uXCIpKTtcbiAgICAgIHRoaXMuX29uU2NhbGVBdHRyQ2hhbmdlZF9fU2NlbmVPYmplY3ROb2RlQmFzZS5jYWxsKHRoaXMsIHRoaXMuYXR0cmlidXRlcy5nZXRBdHRyaWJ1dGUoXCJzY2FsZVwiKSk7XG4gICAgICB0aGlzLl9vblJvdGF0aW9uQXR0ckNoYW5nZWRfX1NjZW5lT2JqZWN0Tm9kZUJhc2UuY2FsbCh0aGlzLCB0aGlzLmF0dHJpYnV0ZXMuZ2V0QXR0cmlidXRlKFwicm90YXRpb25cIikpO1xuICAgICAgdGhpcy5fb25OYW1lQXR0ckNoYW5nZWRfX1NjZW5lT2JqZWN0Tm9kZUJhc2UuY2FsbCh0aGlzLCB0aGlzLmF0dHJpYnV0ZXMuZ2V0QXR0cmlidXRlKFwibmFtZVwiKSk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0IFBhcmVudFNjZW5lT2JqZWN0Tm9kZSgpOiBTY2VuZU9iamVjdE5vZGVCYXNlPFNjZW5lT2JqZWN0PiB7XG4gICAgcmV0dXJuIHRoaXMuX3BhcmVudFNjZW5lT2JqZWN0Tm9kZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgQ29udGFpbmVkU2NlbmVOb2RlKCk6IFNjZW5lTm9kZSB7XG4gICAgcmV0dXJuIHRoaXMuX2NvbnRhaW5lZFNjZW5lTm9kZTtcbiAgfVxuXG4gIHByb3RlY3RlZCBfX29uTW91bnQoKTogdm9pZCB7XG4gICAgc3VwZXIuX19vbk1vdW50KCk7XG4gICAgbGV0IGNvbnRhaW5lZFNjZW5lTm9kZTogU2NlbmVOb2RlID0gbnVsbDtcbiAgICBsZXQgcGFyZW50U2NlbmVPYmplY3ROb2RlOiBTY2VuZU9iamVjdE5vZGVCYXNlPFNjZW5lT2JqZWN0PiA9IG51bGw7XG4gICAgLy8gVGhpcyBwYXJlbnQgbm9kZSBpcyBzY2VuZSBub2RlLlxuICAgIGlmICh0aGlzLl9fcGFyZW50LmdldFR5cGVOYW1lKCkgPT09IFwiU2NlbmVOb2RlXCIpIHtcbiAgICAgIGNvbnRhaW5lZFNjZW5lTm9kZSA9IDxTY2VuZU5vZGU+dGhpcy5fX3BhcmVudDtcbiAgICAgIHBhcmVudFNjZW5lT2JqZWN0Tm9kZSA9IG51bGw7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGNoZWNrIHBhcmVudCBleHRlbmRzIFNjZW5lT2JqZWN0Tm9kZUJhc2Ugb3Igbm90LlxuICAgICAgaWYgKHR5cGVvZiAoPFNjZW5lT2JqZWN0Tm9kZUJhc2U8U2NlbmVPYmplY3Q+PnRoaXMuX19wYXJlbnQpLkNvbnRhaW5lZFNjZW5lTm9kZSA9PT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGAke3RoaXMuX19wYXJlbnQudG9TdHJpbmcoKSB9IGlzIG5vdCBleHRlbmRzIFNjZW5lT2JqZWN0Tm9kZUJhc2UuIElzIHRoaXMgcmVhbGx5IG9rIHRvIGJlIGNvbnRhaW5lZCBpbiBTY2VuZSB0YWc/YCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHBhcmVudFNjZW5lT2JqZWN0Tm9kZSA9IDxTY2VuZU9iamVjdE5vZGVCYXNlPFNjZW5lT2JqZWN0Pj50aGlzLl9fcGFyZW50O1xuICAgICAgICBjb250YWluZWRTY2VuZU5vZGUgPSBwYXJlbnRTY2VuZU9iamVjdE5vZGUuQ29udGFpbmVkU2NlbmVOb2RlO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLl9jb250YWluZWRTY2VuZU5vZGUgPSBjb250YWluZWRTY2VuZU5vZGU7XG4gICAgdGhpcy5fcGFyZW50U2NlbmVPYmplY3ROb2RlID0gcGFyZW50U2NlbmVPYmplY3ROb2RlO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9fb25Vbm1vdW50KCk6IHZvaWQge1xuICAgIHN1cGVyLl9fb25Vbm1vdW50KCk7XG4gIH1cblxuICBwcml2YXRlIF9vblBvc2l0aW9uQXR0ckNoYW5nZWRfX1NjZW5lT2JqZWN0Tm9kZUJhc2UoYXR0cjogR29tbEF0dHJpYnV0ZSk6IHZvaWQge1xuICAgIGlmICh0aGlzLl9zY2VuZU9iamVjdCkge1xuICAgICAgdGhpcy5fc2NlbmVPYmplY3QuVHJhbnNmb3JtZXIuUG9zaXRpb24gPSA8VmVjdG9yMz5hdHRyLlZhbHVlO1xuICAgICAgYXR0ci5kb25lKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfb25TY2FsZUF0dHJDaGFuZ2VkX19TY2VuZU9iamVjdE5vZGVCYXNlKGF0dHI6IEdvbWxBdHRyaWJ1dGUpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5fc2NlbmVPYmplY3QpIHtcbiAgICAgIHRoaXMuX3NjZW5lT2JqZWN0LlRyYW5zZm9ybWVyLlNjYWxlID0gPFZlY3RvcjM+YXR0ci5WYWx1ZTtcbiAgICAgIGF0dHIuZG9uZSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX29uUm90YXRpb25BdHRyQ2hhbmdlZF9fU2NlbmVPYmplY3ROb2RlQmFzZShhdHRyOiBHb21sQXR0cmlidXRlKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX3NjZW5lT2JqZWN0KSB7XG4gICAgICB0aGlzLl9zY2VuZU9iamVjdC5UcmFuc2Zvcm1lci5Sb3RhdGlvbiA9IDxRdWF0ZXJuaW9uPmF0dHIuVmFsdWU7XG4gICAgICBhdHRyLmRvbmUoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9vbk5hbWVBdHRyQ2hhbmdlZF9fU2NlbmVPYmplY3ROb2RlQmFzZShhdHRyOiBHb21sQXR0cmlidXRlKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX3NjZW5lT2JqZWN0KSB7XG4gICAgICB0aGlzLl9zY2VuZU9iamVjdC5uYW1lID0gYXR0ci5WYWx1ZTtcbiAgICAgIGF0dHIuZG9uZSgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiB1cGRhdGUgU2NlbmVPYmplY3QgY2hpbGQuIHVzaW5nIHRoaXMuc2NlbmVPYmplY3QgdG8gcHJldml1cyBvYmplY3QsIHNvIGRvIG5vdCBjaGFuZ2UgaXQgYmVmb3JlIGNhbGwgdGhpcyBtZXRob2QuXG4gICAqIEBwYXJhbSB7U2NlbmVPYmplY3R9IG9iaiBbZGVzY3JpcHRpb25dXG4gICAqL1xuICBwcml2YXRlIF91cGRhdGVTY2VuZU9iamVjdENoaWxkKG9iajogU2NlbmVPYmplY3QpOiB2b2lkIHtcbiAgICBpZiAodHlwZW9mIG9iaiA9PT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgY29uc29sZS5lcnJvcihgJHt0aGlzLmdldFR5cGVOYW1lKCkgfTogc2NlbmVPYmplY3QgaXMgdW5kZWZpbmVkLiBJdCBtdXN0IGJlIG51bGwgb3IgaW5zdGFuY2UuYCk7XG4gICAgICBvYmogPSBudWxsO1xuICAgIH1cbiAgICAvLyBwcmV2aXVzIG9iamVjdCBpcyBleGlzdCBpbiBjaGlsZCwgcmVtb3ZlIGNoaWxkXG4gICAgaWYgKHRoaXMuX3NjZW5lT2JqZWN0ICE9PSBudWxsKSB7XG4gICAgICBpZiAodGhpcy5QYXJlbnRTY2VuZU9iamVjdE5vZGUgPT09IG51bGwpIHsgLy8gdGhpcyBpcyByb290IG9iamVjdCBvZiBzY2VuZVxuICAgICAgICB0aGlzLl9jb250YWluZWRTY2VuZU5vZGUudGFyZ2V0LnJlbW92ZU9iamVjdCh0aGlzLl9zY2VuZU9iamVjdCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAodGhpcy5fcGFyZW50U2NlbmVPYmplY3ROb2RlLlRhcmdldFNjZW5lT2JqZWN0ID09PSBudWxsKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3BhcmVudFNjZW5lT2JqZWN0Tm9kZS5UYXJnZXRTY2VuZU9iamVjdC5yZW1vdmVDaGlsZCh0aGlzLl9zY2VuZU9iamVjdCk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChvYmogIT09IG51bGwpIHtcbiAgICAgIGlmICh0aGlzLlBhcmVudFNjZW5lT2JqZWN0Tm9kZSA9PT0gbnVsbCkgeyAvLyB0aGlzIGlzIHJvb3Qgb2JqZWN0IG9mIHNjZW5lXG4gICAgICAgIHRoaXMuX2NvbnRhaW5lZFNjZW5lTm9kZS50YXJnZXQuYWRkT2JqZWN0KG9iaik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAodGhpcy5fcGFyZW50U2NlbmVPYmplY3ROb2RlLlRhcmdldFNjZW5lT2JqZWN0ID09PSBudWxsKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3BhcmVudFNjZW5lT2JqZWN0Tm9kZS5UYXJnZXRTY2VuZU9iamVjdC5hZGRDaGlsZChvYmopO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDaGFuZ2UgdGhlIFNjZW5lT2JqZWN0IHRoYXQgaXMgYXBwbGllZCB0byBTY2VuZSBIaWVyYXJjaHkuXG4gICAqIEBwYXJhbSB7U2NlbmVPYmplY3R9IG9iaiBbZGVzY3JpcHRpb25dXG4gICAqL1xuICBwcm90ZWN0ZWQgc2V0IFRhcmdldFNjZW5lT2JqZWN0KG9iajogVCkge1xuICAgIHRoaXMuX3VwZGF0ZVNjZW5lT2JqZWN0Q2hpbGQob2JqKTtcbiAgICB0aGlzLl9zY2VuZU9iamVjdCA9IG9iajtcbiAgICB0aGlzLnRhcmdldCA9IG9iajtcbiAgICB0aGlzLmVtaXQoXCJ1cGRhdGUtc2NlbmUtb2JqZWN0XCIsIHRoaXMudGFyZ2V0KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIFNjZW5lT2JqZWN0IHRoYXQgaXMgYXBwbGllZCB0byBTY2VuZSBIaWVyYXJjaHkuXG4gICAqIEByZXR1cm4ge1NjZW5lT2JqZWN0fSBbZGVzY3JpcHRpb25dXG4gICAqL1xuICBwcm90ZWN0ZWQgZ2V0IFRhcmdldFNjZW5lT2JqZWN0KCk6IFQge1xuICAgIHJldHVybiB0aGlzLl9zY2VuZU9iamVjdDtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBTY2VuZU9iamVjdE5vZGVCYXNlO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
